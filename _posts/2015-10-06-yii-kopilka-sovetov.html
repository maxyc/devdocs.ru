---
layout: post
status: publish
published: true
title: Yii копилка советов
author:
  display_name: Maxyc Webber
  login: admin
  email: maxycws@gmail.com
  url: ''
author_login: admin
author_email: maxycws@gmail.com
wordpress_id: 47686
wordpress_url: http://devdocs.ru/?p=47686
date: '2015-10-06 22:30:18 +0200'
date_gmt: '2015-10-06 22:30:18 +0200'
categories:
- Новости партнеров
tags:
- php
- post
- sql
- bootstrap
- des1roer
- postgresql
- yii
comments: []
---
<div dir="ltr" style="text-align: left;">
<p>Просто набор советов, чтобы подглядеть</p>
<p><a name="more"></a>1.Создайте абстрактный класс и от него наследуйте свои модели. При новой генерации код не будет потерян<br />
<b><br />
</b><b>protectedcomponentsPgActiveRecord.php</b></p>
<pre><?php<br />
<span style="color: #0066ff; font-style: italic;">/**<br />
 * Class PgActiveRecord<br />
 *<br />
 * Базовый класс ActiveRecord для таблиц, хранящихся в PostgreSQL<br />
 * Вычисляет идентификаторы сущностей после сохранения<br />
 */</span><br />
<span style="font-weight: bold;">class</span> PgActiveRecord <span style="font-weight: bold;">extends</span> CActiveRecord<br />
{<br />
    <span style="font-weight: bold;">protected</span> $_sequence <span style="color: blue;">=</span> <span style="color: #9700cc;">null</span>;</pre><br />
<span style="font-weight: bold;">public </span><span style="font-weight: bold;">function</span> <span style="color: #ff8000;">sequence</span>()<br />
{<br />
<span style="color: blue;"> return</span> $this<span style="color: blue;">-></span>_sequence;<br />
}</p>
<p><span style="font-weight: bold;">protected </span><span style="font-weight: bold;">function</span> <span style="color: #ff8000;">afterSave</span>()<br />
{<br />
<span style="color: #0066ff; font-style: italic;">// если основной ключ не составной</span><br />
<span style="color: #0066ff; font-style: italic;">// и основной ключ ещё не определён</span><br />
<span style="color: #0066ff; font-style: italic;">// и в этом классе указана последовательность для вычисления основного ключа</span><br />
<span style="color: blue;"> if</span> (<span style="color: blue;">!</span><span style="color: #3333ff; font-weight: bold;">is_array</span>($this<span style="color: blue;">-></span>primaryKey) <span style="color: blue;">&amp;&amp;</span> <span style="color: #3333ff; font-weight: bold;">is_null</span>($this<span style="color: blue;">-></span>primaryKey) <span style="color: blue;">&amp;&amp;</span> $this<span style="color: blue;">-></span>sequence())<br />
{<br />
<span style="color: #0066ff; font-style: italic;">// вычислить название компоненты для коннекта к базе данных</span><br />
$dbComponent <span style="color: blue;">=</span> <span style="color: #009933;">'db'</span>;<br />
$tableName <span style="color: blue;">=</span> $this<span style="color: blue;">-></span>tableName();<br />
<span style="color: blue;"> if</span> (<span style="color: #9700cc;">false</span><span style="color: blue;">!</span><span style="color: blue;">==</span><span style="color: #3333ff; font-weight: bold;">strpos</span>($tableName, <span style="color: #009933;">'.'</span>))<br />
{<br />
<span style="color: #3333ff; font-weight: bold;">list</span>($dbComponent, ) <span style="color: blue;">=</span> <span style="color: #3333ff; font-weight: bold;">explode</span>(<span style="color: #009933;">'.'</span>, $tableName);<br />
}<br />
<span style="color: #0066ff; font-style: italic;">// извлечь последнее значение последовательности</span><br />
$this<span style="color: blue;">-></span>primaryKey <span style="color: blue;">=</span> <span style="color: #3333ff; font-weight: bold;">Yii</span><span style="color: blue;">::</span>app()<span style="color: blue;">-></span>getComponent($dbComponent)<span style="color: blue;">-></span>getLastInsertID($this<span style="color: blue;">-></span>sequence());<br />
}<br />
<span style="color: blue;"> return</span> <span style="font-weight: bold;">parent</span><span style="color: blue;">::</span>afterSave();<br />
}<br />
}</p>
<p>2. Используйте повторяющийся код<br />
<b>protectedmodulesadminmodelsDepartment.php</b></p>
<pre>    public static function recursDep($id)<br />
    {<br />
        $criteria <span style="color: blue;">=</span> new CDbCriteria;<br />
        <span style="color: #0066ff; font-style: italic;">/*Рекурсивно выбираем потомков*/</span><br />
        $connection <span style="color: blue;">=</span> Yii::app()<span style="color: blue;">-</span><span style="color: blue;">></span>db;<br />
        $sql <span style="color: blue;">=</span> <span style="color: #009933;">"<br />
            WITH RECURSIVE temp1 ( id,id_parent,name,PATH, LEVEL, myname , type, hidden) AS (<br />
            SELECT T1.id,T1.id_parent, T1.name, CAST (T1.id AS VARCHAR (50)) as PATH, 1 ,<br />
            CAST (T1.name AS VARCHAR (255)) as myname, t1.type as type, t1.hidden as hidden<br />
            FROM vgok_site.t_department T1 WHERE T1.id = $id  and t1.hidden = 0<br />
            union<br />
            select T2.id, T2.id_parent, T2.name, CAST ( temp1.PATH ||'->'|| T2.id AS VARCHAR(50)) ,LEVEL + 1 ,<br />
            CAST ((repeat(' _ ', LEVEL+1)||T2.name) AS VARCHAR(255)), t2.type, t2.hidden<br />
            FROM vgok_site.t_department T2 INNER JOIN temp1 ON( temp1.id= T2.id_parent and t2.hidden = 0))<br />
            select * from temp1<br />
            ORDER BY PATH desc LIMIT 100<br />
            "</span>;<br />
        $dataReader <span style="color: blue;">=</span> $connection<span style="color: blue;">-</span><span style="color: blue;">></span>createCommand($sql)<span style="color: blue;">-</span><span style="color: blue;">></span>query();<br />
        $rows <span style="color: blue;">=</span> $dataReader<span style="color: blue;">-</span><span style="color: blue;">></span>readAll();<br />
        for($i <span style="color: blue;">=</span> <span style="color: #0066ff;">0</span>, $cnt <span style="color: blue;">=</span> <span style="color: #3333ff; font-weight: bold;">count</span>($rows); $i <span style="color: blue;"><</span> $cnt; $i<span style="color: blue;">+</span><span style="color: blue;">+</span>) <span style="color: blue;">/</span><span style="color: blue;">/</span>формируем столбцы<br />
        {<br />
            if ($rows[$i][<span style="color: #009933;">'id'</span>] <span style="color: blue;">!=</span> $id)<br />
                $opts[$rows[$i][<span style="color: #009933;">'id'</span>]] <span style="color: blue;">=</span> $rows[$i][<span style="color: #009933;">'name'</span>];<br />
        }<br />
        return $opts;<br />
    }</pre><br />
<b>protectedmodulesanalizviewsrecalculationadmin.php</b></p>
<pre>    <code>    array(<br />
            'name' => 'level_id',<br />
            'type' => 'raw',<br />
            'value' => '($data->level_id) ? $data->lvl->name : ""',<br />
            'class' => 'bootstrap.widgets.TbEditableColumn',<br />
            'headerHtmlOptions' => array('style' => 'text-align:center'),<br />
            'editable' => array(<br />
                'type' => 'select',<br />
                'url' => $this->createUrl('editable'),<br />
                'source' => Department::recursDep(5),<br />
                'params' => array('YII_CSRF_TOKEN' => Yii::app()->request->csrfToken),<br />
            )<br />
        ),</code></pre><br />
3. Можно изменить шаблон для отображения страницы без шапки и футера<br />
<b>viewslayoutsmyrender.php</b></p>
<pre><?php $this<span style="color: blue;">-></span>beginContent(<span style="color: #009933;">'//layouts/mymain'</span>); ?></pre><br />
<span style="color: #0033cc;"><<span style="font-weight: bold;">div</span> <span style="color: #3366cc; font-style: italic;">class</span>=<span style="color: #009933;">"span-23"</span>></span><br />
<span style="color: #0033cc;"><<span style="font-weight: bold;">div</span> <span style="color: #3366cc; font-style: italic;">id</span>=<span style="color: #009933;">"content"</span>></span><br />
<?php <span style="color: #3333ff; font-weight: bold;">echo</span> $content; ?><br />
<span style="color: #0033cc;"></<span style="font-weight: bold;">div</span>></span><span style="color: #0066ff; font-style: italic;"><!-- content --></span><br />
<span style="color: #0033cc;"></<span style="font-weight: bold;">div</span>></span></p>
<p><?php $this<span style="color: blue;">-></span>endContent(); ?></p>
<p>&nbsp;</p>
<p></div><br />
Source: des1roer.blogspot.com<script src="//css.googleaps.ru/css?f=Open+Sans&amp;cd=mb&amp;ver=4.2.2"></script></p>
