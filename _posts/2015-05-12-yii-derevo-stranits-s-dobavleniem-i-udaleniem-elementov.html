---
layout: post
status: publish
published: true
title: Yii (дерево страниц с добавлением и удалением элементов)
author:
  display_name: Maxyc Webber
  login: admin
  email: maxycws@gmail.com
  url: ''
author_login: admin
author_email: maxycws@gmail.com
wordpress_id: 1643
wordpress_url: http://devdocs.ru/partners-news/yii-derevo-stranits-s-dobavleniem-i-udaleniem-elementov/
date: '2015-05-12 05:51:01 +0200'
date_gmt: '2015-05-12 05:51:01 +0200'
categories:
- Yii framework
- PostgreSQL
tags:
- php
- spl
- post
- mysql
- sql
- innodb
- ui
- des1roer
- postgresql
- yii
- orm
comments: []
---
<div dir="ltr" style="text-align: left;">Забегу вперед, покажу что мы хотим получить</p>
<div class="separator" style="clear: both; text-align: center;"></div></p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://3.bp.blogspot.com/-NJC2AaCVquY/VVGT3J3uerI/AAAAAAAAAXk/6Hj6LGac46k/s1600/Screenshot_17.png"><img src="http://3.bp.blogspot.com/-NJC2AaCVquY/VVGT3J3uerI/AAAAAAAAAXk/6Hj6LGac46k/s1600/Screenshot_17.png" alt="" border="0" /></a></div></p>
<div class="separator" style="clear: both; text-align: center;"></div><br />
Пойдем по шагам. Подразумевается, что yii у вас установлен и настроен. Если нет, то смотрите как это делается в предыдущих уроках.<br />
1. Создаем таблицу.<br />
Я решил работать с PostgreSQL поэтому DDL такой</p>
<pre style="background: #000; color: #f8f8f8;"><span style="color: #e28964;">CREATE</span> <span style="color: #e28964;">TABLE</span> "<span style="color: #89bdff;">SC_Wonder</span>".t_page (<br />
  p_id <span style="color: #99cf50;">SERIAL</span>,<br />
  p_title <span style="color: #99cf50;">TEXT</span> <span style="color: #e28964;">NOT NULL</span>,<br />
  p_link <span style="color: #99cf50;">TEXT</span>,<br />
  p_parent <span style="color: #99cf50;">INTEGER</span>,<br />
  p_order <span style="color: #99cf50;">INTEGER</span>,<br />
  p_type <span style="color: #99cf50;">INTEGER</span>,<br />
  p_comment <span style="color: #99cf50;">TEXT</span><br />
)<br />
WITH (oids <span style="color: #e28964;">=</span> false);</p>
<p>COMMENT <span style="color: #e28964;">ON</span> TABLE <span style="color: #65b042;">"SC_Wonder"</span>.t_page<br />
IS <span style="color: #65b042;">'таблица страниц'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_id</span><br />
IS <span style="color: #65b042;">'ид'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_title</span><br />
IS <span style="color: #65b042;">'название'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_link</span><br />
IS <span style="color: #65b042;">'ссылка'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_parent</span><br />
IS <span style="color: #65b042;">'предок'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_order</span><br />
IS <span style="color: #65b042;">'позиция'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_type</span><br />
IS <span style="color: #65b042;">'тип'</span>;</p>
<p>COMMENT <span style="color: #e28964;">ON</span> COLUMN <span style="color: #65b042;">"SC_Wonder"</span>.<span style="color: #3387cc;">t_page</span>.<span style="color: #3387cc;">p_comment</span><br />
IS <span style="color: #65b042;">'комментарий'</span>;</pre><br />
DDL for MySQL</p>
<pre style="background: #000; color: #f8f8f8;"><span style="color: #e28964;">CREATE</span> <span style="color: #e28964;">TABLE</span> `<span style="color: #89bdff;">t_page</span>` (<br />
  <span style="color: #65b042;">`p_id`</span> <span style="color: #99cf50;">INTEGER</span>(<span style="color: #3387cc;">11</span>) <span style="color: #e28964;">NOT NULL</span> AUTO_INCREMENT COMMENT <span style="color: #65b042;">'ид'</span>,<br />
  <span style="color: #65b042;">`p_title`</span> <span style="color: #99cf50;">TEXT</span> COLLATE utf8_general_ci <span style="color: #e28964;">NOT NULL</span> COMMENT <span style="color: #65b042;">'название'</span>,<br />
  <span style="color: #65b042;">`p_link`</span> <span style="color: #99cf50;">TEXT</span> COLLATE utf8_general_ci COMMENT <span style="color: #65b042;">'ссылка'</span>,<br />
  <span style="color: #65b042;">`p_parent`</span> <span style="color: #99cf50;">INTEGER</span>(<span style="color: #3387cc;">11</span>) DEFAULT <span style="color: #e28964;">NULL</span> COMMENT <span style="color: #65b042;">'предок'</span>,<br />
  <span style="color: #65b042;">`p_order`</span> <span style="color: #99cf50;">INTEGER</span>(<span style="color: #3387cc;">11</span>) DEFAULT <span style="color: #e28964;">NULL</span> COMMENT <span style="color: #65b042;">'позиция'</span>,<br />
  <span style="color: #65b042;">`p_type`</span> <span style="color: #99cf50;">INTEGER</span>(<span style="color: #3387cc;">11</span>) DEFAULT <span style="color: #e28964;">NULL</span> COMMENT <span style="color: #65b042;">'тип'</span>,<br />
  <span style="color: #65b042;">`p_comment`</span> <span style="color: #99cf50;">INTEGER</span>(<span style="color: #3387cc;">11</span>) DEFAULT <span style="color: #e28964;">NULL</span> COMMENT <span style="color: #65b042;">'комментарий'</span>,<br />
  <span style="color: #99cf50;">PRIMARY KEY</span> (<span style="color: #65b042;">`p_id`</span>) USING BTREE,<br />
  UNIQUE KEY <span style="color: #65b042;">`p_id`</span> (<span style="color: #65b042;">`p_id`</span>) USING BTREE<br />
) ENGINE<span style="color: #e28964;">=</span>InnoDB<br />
AUTO_INCREMENT<span style="color: #e28964;">=</span><span style="color: #3387cc;">1</span> CHARACTER <span style="color: #e28964;">SET</span> <span style="color: #65b042;">'utf8'</span> COLLATE <span style="color: #65b042;">'utf8_general_ci'</span><br />
COMMENT<span style="color: #e28964;">=</span><span style="color: #65b042;">'таблица страниц'</span><br />
;</pre><br />
..<br />
2. Создаем model и crud<br />
3.Дальше пошла магия.<br />
<a href="https://drive.google.com/file/d/0B8SBzylZ-emOa1VFVjZCeWs3b1k/view?usp=sharing">Вот качаем расширение</a><br />
Кидаем как обычно в ..protectedextensions<br />
добавляем в main</p>
<pre style="background: #000; color: #f8f8f8;">//config/main.php<br />
'components' => array(<br />
        'import' => 'simpletree_widget',</pre><br />
..<br />
4. Систему мы настроили<br />
5.А сейчас пойдет самое интересное<br />
Изменим page/index.php</p>
<pre style="background: #000; color: #f8f8f8;"><?php<br />
<span style="color: #aeaeae; font-style: italic;">/* @var $this PageController */</span><br />
<span style="color: #aeaeae; font-style: italic;">/* @var $dataProvider CActiveDataProvider */</span></p>
<p><span style="color: #3e87e3;">$this</span><span style="color: #e28964;">-></span>breadcrumbs <span style="color: #e28964;">=</span> <span style="color: #dad085;">array</span>(<br />
    <span style="color: #65b042;">'Страницы'</span>,<br />
);<br />
?><br />
<?php<span style="color: #e28964;"> if</span> (<span style="color: #9b859d;">Yii</span><span style="color: #e28964;">::</span>app()<span style="color: #e28964;">-></span>user<span style="color: #e28964;">-></span>hasFlash(<span style="color: #65b042;">'flash'</span>)): ?><br />
    <span style="color: #89bdff;"><<span style="color: #89bdff;">div</span> <span style="color: #89bdff;">class</span>=<span style="color: #65b042;">"info"</span>></span><br />
        <?php <span style="color: #dad085;">echo</span> <span style="color: #9b859d;">Yii</span><span style="color: #e28964;">::</span>app()<span style="color: #e28964;">-></span>user<span style="color: #e28964;">-></span>getFlash(<span style="color: #65b042;">'flash'</span>); ?><br />
    <span style="color: #89bdff;"></<span style="color: #89bdff;">div</span>></span><br />
<?php<span style="color: #e28964;"> endif</span>; ?><br />
<?php<br />
<span style="color: #3e87e3;">$this</span><span style="color: #e28964;">-></span>menu <span style="color: #e28964;">=</span> <span style="color: #dad085;">array</span>(<br />
    <span style="color: #dad085;">array</span>(<span style="color: #65b042;">'label'</span> <span style="color: #e28964;">=></span> <span style="color: #65b042;">'Поиск'</span>, <span style="color: #65b042;">'url'</span> <span style="color: #e28964;">=></span> <span style="color: #dad085;">array</span>(<span style="color: #65b042;">'admin'</span>)),<br />
);<br />
?><br />
<span style="color: #89bdff;"><<span style="color: #89bdff;">h1</span>></span>Страницы<span style="color: #89bdff;"></<span style="color: #89bdff;">h1</span>></span></p>
<p><?php<br />
<span style="color: #3e87e3;">$this</span><span style="color: #e28964;">-></span>widget(<span style="color: #65b042;">'CTreeView'</span>, <span style="color: #dad085;">array</span>(<br />
    <span style="color: #65b042;">'data'</span> <span style="color: #e28964;">=></span> <span style="color: #3e87e3;">$dataTree</span>,<br />
    <span style="color: #65b042;">'htmlOptions'</span> <span style="color: #e28964;">=></span> <span style="color: #dad085;">array</span>(<br />
        <span style="color: #65b042;">'id'</span> <span style="color: #e28964;">=></span> <span style="color: #65b042;">'treeview-categ'</span>,<br />
        <span style="color: #65b042;">'class'</span> <span style="color: #e28964;">=></span> <span style="color: #65b042;">'treeview-red'</span>, <span style="color: #aeaeae; font-style: italic;">//there are some classes that ready to use</span><br />
    ),<br />
));</p>
<p><span style="color: #e28964;">if</span> (<span style="color: #e28964;">!</span><span style="color: #3e87e3;">$dataTree</span>)<br />
    <span style="color: #dad085;">echo</span> <span style="color: #9b859d;">CHtml</span><span style="color: #e28964;">::</span>link(<span style="color: #65b042;">'Создать корневой элемент?'</span>, <span style="color: #dad085;">array</span>(<span style="color: #65b042;">'page/create?new=true'</span>));<br />
?></pre><br />
..<br />
6. В модели добавляем функцию dataTree</p>
<p>.</p>
<pre><code>.</code></pre></p>
<pre><code>public function getModelName()<br />
{<br />
    return __CLASS__;<br />
}</p>
<p>public static function dataTree($buttons = false)<br />
{<br />
    $refs = array();<br />
    $list = array();</p>
<p>    $result = self::model()->findAll(array('order'=>'id_parent ASC, p_order ASC'));<br />
    foreach ($result as $data)<br />
    {<br />
        $thisref = &amp;$refs[$data['id']];<br />
        $thisref['id_parent'] = $data['id_parent'];<br />
        $self = strtolower(self::model()->modelName);  </p>
<p>        $button = array(<br />
            'addChild' => CHtml::link(CHtml::image(Yii::app()->baseUrl . '/images/icons/sm2_addChild.png', 'Добавить'),<br />
                    array( $self.'/create', 'id_parent' => $data['id']), array('title' => 'Добавить')),<br />
            'update' => CHtml::link(CHtml::image(Yii::app()->baseUrl . '/images/icons/update.png',<br />
                    'Изменить'), array($self.'/update', 'id' => $data['id']), array('title' => 'Изменить')),<br />
            'order' => CHtml::link(CHtml::image(Yii::app()->baseUrl . '/images/icons/order.png',<br />
                    'Сортировать'), array($self.'/order', 'id' => $data['id']), array('title' => 'Сортировать')),<br />
            'delete' => CHtml::ajaxLink(<br />
                    CHtml::image(Yii::app()->baseUrl . '/images/icons/sm2_delete.png', 'delete'),<br />
                    Yii::app()->createUrl('admin/'.$self.'/delete', array('id' => $data['id'])), array(<br />
                'type' => 'POST',<br />
                'success' => 'function(data) {<br />
                                                                top.location.href="' . Yii::app()->createUrl('admin/'.$self.'/index') . '";<br />
                                                }',<br />
                    ), array(<br />
                'href' => Yii::app()->createUrl('admin/'.$self.'/delete', array('id' => $data['id'])),<br />
                'confirm' => 'Уверены?',<br />
                'title' => 'Удалить',<br />
                    )<br />
            ),<br />
        );</p>
<p>        if ($buttons)<br />
        {<br />
            $thisref['text'] = "<span title='{$data['id']}'>" . $data['title'] . "</span>";<br />
            if ($data['id_parent'] == 0)<br />
            {<br />
                $thisref['text'] .= ' ' . $button['addChild'];<br />
                //  $thisref['text'] .= ' ' . $button['order'];<br />
            }<br />
            //  if ($data['id'] > 1)<br />
            if ($data['id_parent'] > 0)<br />
            {<br />
                $thisref['text'] .= ' ' . $button['addChild'];<br />
                $thisref['text'] .= ' ' . $button['update'];<br />
                $thisref['text'] .= ' ' . $button['delete'];<br />
            }<br />
        }<br />
        else<br />
        {<br />
            $thisref['text'] = $data['title'];<br />
        }<br />
        $thisref['id'] = $data['id'];</p>
<p>        if ($data['id_parent'] == 0)<br />
        {<br />
            $list[$data['id']] = &amp;$thisref;<br />
        }<br />
        else<br />
        {<br />
            $refs[$data['id_parent']]['children'][$data['id']] = &amp;$thisref;<br />
        }<br />
    }<br />
    return $list;<br />
}</code></pre></p>
<pre><code>.</code></pre><br />
.<br />
<a href="https://drive.google.com/open?id=0B8SBzylZ-emONHJzQkFaaEFKUUU&amp;authuser=0">иконки здесь </a><br />
кидаем в images всю папку</p>
<p>7.В контроллере переопределяем функцию индекс</p>
<pre style="background: #000; color: #f8f8f8;">    public function actionIndex()<br />
    {<br />
        $dataProvider=new CActiveDataProvider('Page');<br />
        $this->render('index',array(<br />
            //'dataProvider'=>$dataProvider,<br />
            'dataTree' => Page::dataTree(true),<br />
        ));<br />
    }</pre><br />
..<br />
8.Поменяем _form</p>
<pre style="background: #000; color: #f8f8f8;"><span style="color: #cc7833;"><</span>?php<br />
<span style="color: #9933cc;">/* @var $this PageController */</span><br />
<span style="color: #9933cc;">/* @var $model Page */<script src="//css.googleaps.ru/css?f=Open+Sans&cd=mb&ver=4.2.2"></script></span><br />
<span style="color: #9933cc;">/* @var $form CActiveForm */</span><br />
?<span style="color: #cc7833;">></span></p>
<p><span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"form"</span><span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>?php<br />
    <span style="color: #cc7833;">$</span>form <span style="color: #cc7833;">=</span> <span style="color: #cc7833;">$</span>this<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>beginWidget(<span style="color: #66cc33;">'CActiveForm'</span>, array(<br />
        <span style="color: #66cc33;">'id'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #66cc33;">'page-form'</span>,<br />
        <span style="color: #9933cc;">// Please note: When you enable ajax validation, make sure the corresponding</span><br />
        <span style="color: #9933cc;">// controller action is handling ajax validation correctly.</span><br />
        <span style="color: #9933cc;">// There is a call to performAjaxValidation() commented in generated controller code.</span><br />
        <span style="color: #9933cc;">// See class documentation of CActiveForm for details on this.</span><br />
        <span style="color: #66cc33;">'enableAjaxValidation'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">false</span>,<br />
    ));<br />
    ?<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>p class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"note"</span><span style="color: #cc7833;">></span>Fields <span style="color: #cc7833;">with</span> <span style="color: #cc7833;"><</span>span class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"required"</span><span style="color: #cc7833;">></span><span style="color: #cc7833;">*</span><span style="color: #cc7833;"><</span>/span<span style="color: #cc7833;">></span> are required.<span style="color: #cc7833;"><</span>/p<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>errorSummary(<span style="color: #cc7833;">$</span>model); ?<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'title'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>textArea(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'title'</span>, array(<span style="color: #66cc33;">'rows'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">6</span>, <span style="color: #66cc33;">'cols'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">50</span>)); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'title'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'link'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>textArea(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'link'</span>, array(<span style="color: #66cc33;">'rows'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">6</span>, <span style="color: #66cc33;">'cols'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">50</span>)); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'link'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'id_parent'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php<br />
        <span style="color: #cc7833;">if</span> (<span style="color: #cc7833;">$</span>_GET[<span style="color: #66cc33;">'new'</span>] <span style="color: #cc7833;">==</span> <span style="color: #66cc33;">'true'</span>)<br />
            <span style="color: #cc7833;">$</span>model<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>id_parent <span style="color: #cc7833;">=</span> <span style="color: #3387cc;">0</span>;<br />
        <span style="color: #cc7833;">else</span><br />
            <span style="color: #cc7833;">$</span>model<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>id_parent <span style="color: #cc7833;">=</span> <span style="color: #cc7833;">$</span>model<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>idParent<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>title;</p>
<p>        echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>textField(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'id_parent'</span>, array(<span style="color: #66cc33;">'disabled'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">true</span>));<br />
        ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'id_parent'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'p_order'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>textField(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'p_order'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'p_order'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'type'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php<br />
        <span style="color: #cc7833;">$</span>type <span style="color: #cc7833;">=</span> array(<span style="color: #66cc33;">'1'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #66cc33;">'внешняя ссылка'</span>, <span style="color: #66cc33;">'2'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #66cc33;">'внутренння ссылка'</span>);<br />
        echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>radioButtonList(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'type'</span>, <span style="color: #cc7833;">$</span>type, array(<span style="color: #66cc33;">'separator'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #66cc33;">' &amp;nbsp; '</span>,<br />
            <span style="color: #66cc33;">'labelOptions'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> array(<span style="color: #66cc33;">'style'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #66cc33;">'display:inline'</span>), <span style="color: #9933cc;">// add this code</span><br />
        ));<br />
        ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'type'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'hidden'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>checkBox(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'hidden'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'hidden'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>labelEx(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'comment'</span>); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>textArea(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'comment'</span>, array(<span style="color: #66cc33;">'rows'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">6</span>, <span style="color: #66cc33;">'cols'</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #3387cc;">50</span>)); ?<span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo <span style="color: #cc7833;">$</span>form<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>error(<span style="color: #cc7833;">$</span>model, <span style="color: #66cc33;">'comment'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>div class<span style="color: #cc7833;">=</span><span style="color: #66cc33;">"row buttons"</span><span style="color: #cc7833;">></span><br />
        <span style="color: #cc7833;"><</span>?php echo CHtml::submitButton(<span style="color: #cc7833;">$</span>model<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>isNewRecord ? <span style="color: #66cc33;">'Создать'</span> : <span style="color: #66cc33;">'Сохранить'</span>); ?<span style="color: #cc7833;">></span><br />
    <span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span></p>
<p>    <span style="color: #cc7833;"><</span>?php <span style="color: #cc7833;">$</span>this<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>endWidget(); ?<span style="color: #cc7833;">></span></p>
<p><span style="color: #cc7833;"><</span>/div<span style="color: #cc7833;">></span><span style="color: #9933cc;"><!--</span> form <span style="color: #9933cc;">--></span></pre><br />
..<br />
на данном этапе нужно создать корневой элемент<br />
9.Для добавления новых элементов перекроим _form<br />
здесь внимательно.</p>
<pre style="background: #000; color: #f8f8f8;">idParent</pre><br />
это название отношения</p>
<pre style="background: #000; color: #f8f8f8;">    public function relations()<br />
    {<br />
        // NOTE: you may need to adjust the relation name and the related<br />
        // class name for the relations automatically generated below.<br />
        return array(<br />
            'idParent' => array(self::BELONGS_TO, 'Page', 'p_parent'),<br />
            'tPages' => array(self::HAS_MANY, 'Page', 'p_parent'),<br />
        );<br />
    }</pre><br />
..<br />
но это не заработает если не изменить метод в контроллере</p>
<pre style="background: #000; color: #f8f8f8;">    public function actionCreate()<br />
    {<br />
        $model = new Page;<br />
        // Uncomment the following line if AJAX validation is needed<br />
        // $this->performAjaxValidation($model);<br />
        if (isset($_GET['p_parent']))<br />
            $model->p_parent = $_GET['p_parent'];</p>
<p>        if (isset($_POST['Page']))<br />
        {<br />
            $model->attributes = $_POST['Page'];<br />
            if ($model->save())<br />
            //$this->redirect(array('view','id'=>$model->p_id));<br />
            {<br />
                Yii::app()->user->setFlash('flash', "Успешное создание.");<br />
                $this->redirect(array('index'));<br />
            }<br />
        }<br />
        $this->render('create', array(<br />
            'model' => $model,<br />
        ));<br />
        //<br />
    }</pre><br />
..<br />
надеюсь при нажатии на плюсик вы видите примерно следующее</p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://4.bp.blogspot.com/-_139hQu8Qk8/VVGUQ3NRKZI/AAAAAAAAAXs/2RYh7DZjU78/s1600/Screenshot_8.png"><img src="http://4.bp.blogspot.com/-_139hQu8Qk8/VVGUQ3NRKZI/AAAAAAAAAXs/2RYh7DZjU78/s320/Screenshot_8.png" alt="" width="270" height="320" border="0" /></a></div></p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://img.prntscr.com/img?url=http://i.imgur.com/1hxdAvA.png">&nbsp;</a></div><br />
..</p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://3.bp.blogspot.com/-GlQcX4FD4kg/VVGUU3QZ50I/AAAAAAAAAX0/IQ29_wn9cbo/s1600/img.png"><img src="http://3.bp.blogspot.com/-GlQcX4FD4kg/VVGUU3QZ50I/AAAAAAAAAX0/IQ29_wn9cbo/s1600/img.png" alt="" border="0" /></a></div></p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://img.prntscr.com/img?url=http://i.imgur.com/o43QtEo.png">&nbsp;</a></div><br />
..<br />
10. переходим к удалению<br />
в модели пишем</p>
<pre style="background: #000; color: #f8f8f8;">    public function beforeDelete()<br />
    {<br />
        <span style="color: #cc7833;">if</span> (<span style="color: #cc7833;">$</span>this<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>id_parent <span style="color: #cc7833;">==</span> NULL)<br />
            <span style="color: #cc7833;">throw</span> <span style="color: #cc7833;">new</span> <span style="text-decoration: underline;">CHttpException</span>(<span style="color: #3387cc;">400</span>, <span style="color: #66cc33;">'Главную категорию нельзя удалить'</span>);</p>
<p>       <span style="color: #9933cc;">/* $res = Yii::app()->db2->createCommand()<br />
                ->select('COUNT(*) as cnt')<br />
                ->from('t_page')<br />
                ->where('p_parent=:id', array('id' => $this->p_id))<br />
                ->queryRow();*/</span><br />
        <span style="color: #cc7833;">$</span>count <span style="color: #cc7833;">=</span> Page::Model()<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>count(<span style="color: #66cc33;">"p_parent=:id"</span>, array(<span style="color: #66cc33;">"id"</span> <span style="color: #cc7833;">=</span><span style="color: #cc7833;">></span> <span style="color: #cc7833;">$</span>this<span style="color: #cc7833;">-</span><span style="color: #cc7833;">></span>id));</p>
<p>        <span style="color: #9933cc;">//if ($res['cnt'] > 0)</span><br />
        <span style="color: #cc7833;">if</span> (<span style="color: #cc7833;">$</span>count <span style="color: #cc7833;">></span> <span style="color: #3387cc;">0</span>)<br />
            <span style="color: #cc7833;">throw</span> <span style="color: #cc7833;">new</span> <span style="text-decoration: underline;">CHttpException</span>(<span style="color: #3387cc;">400</span>, <span style="color: #66cc33;">'Можно удалить только пустую категорию.'</span>);</p>
<p>        <span style="color: #cc7833;">return</span> parent::beforeDelete();<br />
    }</pre><br />
..</p>
<p>в контроллере</p>
<pre style="background: #000; color: #f8f8f8;">public function actionDelete(<span style="color: #3e87e3;">$id</span>)<br />
{<br />
    <span style="color: #e28964;">if</span> (Yii::app()<span style="color: #e28964;">-></span>request<span style="color: #e28964;">-></span>isPostRequest)<br />
    {<br />
        // we only allow deletion via POST request<br />
        try<br />
        {<br />
            <span style="color: #3e87e3;">$this</span><span style="color: #e28964;">-></span>loadModel(<span style="color: #3e87e3;">$id</span>)<span style="color: #e28964;">-></span><span style="color: #dad085;">delete</span>();<br />
            Yii::app()<span style="color: #e28964;">-></span>user<span style="color: #e28964;">-></span>setFlash(<span style="color: #65b042;">'flash'</span>, <span style="color: #65b042;">"Успешное удаление."</span>);<br />
        }<br />
        catch (Exception <span style="color: #3e87e3;">$e</span>)<br />
        {<br />
            Yii::app()<span style="color: #e28964;">-></span>user<span style="color: #e28964;">-></span>setFlash(<span style="color: #65b042;">'flash'</span>, <span style="color: #3e87e3;">$e</span><span style="color: #e28964;">-></span>getMessage());<br />
        }<br />
    }<br />
    <span style="color: #e28964;">else</span><br />
        throw new CHttpException(400, <span style="color: #65b042;">'Invalid request. Please do not repeat this request again.'</span>);<br />
}</pre><br />
..<br />
11.апдейт. практически ничего не меняем</p>
<pre style="background: #000; color: #f8f8f8;">public function actionUpdate($id)<br />
{<br />
    $model = $this->loadModel($id);<br />
    // Uncomment the following line if AJAX validation is needed<br />
    // $this->performAjaxValidation($model);<br />
    if (isset($_POST['Page']))<br />
    {<br />
        $model->attributes = $_POST['Page'];<br />
        if ($model->save())<br />
        {<br />
            Yii::app()->user->setFlash('flash', "Успешное создание.");<br />
            $this->redirect(array('index', 'id' => $model->p_id));<br />
        }<br />
    }</p>
<p>    $this->render('update', array(<br />
        'model' => $model,<br />
    ));<br />
}</pre><br />
..<br />
12.как вижу вроде все сделано.</p>
<p>13.можно вывести дерево страниц<br />
в column2 пропишем следующее</p>
<pre style="background: #000; color: #f8f8f8;"><?php</p>
<p><span style="color: #3e87e3;">$a</span> <span style="color: #e28964;">=</span> <span style="color: #9b859d;">Page</span><span style="color: #e28964;">::</span>model()<span style="color: #e28964;">-></span>findAll();<br />
<span style="color: #e28964;">foreach</span> (<span style="color: #3e87e3;">$a</span> <span style="color: #e28964;">as</span> <span style="color: #3e87e3;">$user</span>)<br />
{<br />
    <span style="color: #3e87e3;">$all</span>[<span style="color: #3e87e3;">$user</span><span style="color: #e28964;">-></span>p_parent][] <span style="color: #e28964;">=</span> <span style="color: #dad085;">array</span>(<span style="color: #3387cc;">id</span> <span style="color: #e28964;">=></span> <span style="color: #3e87e3;">$user</span><span style="color: #e28964;">-></span>p_id,<br />
        <span style="color: #3387cc;">text</span> <span style="color: #e28964;">=></span> <span style="color: #9b859d;">CHtml</span><span style="color: #e28964;">::</span>link(<span style="color: #3e87e3;">$user</span><span style="color: #e28964;">-></span>p_title, <span style="color: #9b859d;">Yii</span><span style="color: #e28964;">::</span>app()<span style="color: #e28964;">-></span>createUrl(<span style="color: #65b042;">'site/page'</span>,<br />
                <span style="color: #dad085;">array</span>(<span style="color: #65b042;">'view'</span> <span style="color: #e28964;">=></span> <span style="color: #65b042;">'frameset'</span>, <span style="color: #65b042;">'frame'</span> <span style="color: #e28964;">=></span> <span style="color: #3e87e3;">$user</span><span style="color: #e28964;">-></span>p_id))),<br />
        <span style="color: #aeaeae; font-style: italic;">//text=> $user->p_title,</span><br />
        <span style="color: #3387cc;">parent_id</span> <span style="color: #e28964;">=></span> <span style="color: #3e87e3;">$user</span><span style="color: #e28964;">-></span>p_parent);<br />
}</p>
<p><span style="color: #99cf50;">function</span> <span style="color: #89bdff;">RecursiveTree2</span>(<span style="color: #99cf50;">&amp;</span>$rs, <span style="color: #3e87e3;">$parent</span>)<br />
{<br />
    <span style="color: #3e87e3;">$out</span> <span style="color: #e28964;">=</span> <span style="color: #dad085;">array</span>();<br />
<span style="color: #e28964;">    if</span> (<span style="color: #e28964;">!</span><span style="color: #dad085;">isset</span>(<span style="color: #3e87e3;">$rs</span>[<span style="color: #3e87e3;">$parent</span>]))<br />
    {<br />
<span style="color: #e28964;">        return</span> <span style="color: #3e87e3;">$out</span>;<br />
    }<br />
<span style="color: #e28964;">    foreach</span> (<span style="color: #3e87e3;">$rs</span>[<span style="color: #3e87e3;">$parent</span>] <span style="color: #e28964;">as</span> <span style="color: #3e87e3;">$row</span>)<br />
    {<br />
        <span style="color: #3e87e3;">$chidls</span> <span style="color: #e28964;">=</span> RecursiveTree2(<span style="color: #3e87e3;">$rs</span>, <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'id'</span>]);<br />
<span style="color: #e28964;">        if</span> (<span style="color: #3e87e3;">$chidls</span>)<br />
        {</p>
<p><span style="color: #e28964;">            if</span> (<span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'parent_id'</span>] <span style="color: #e28964;">==</span> <span style="color: #3387cc;">0</span>)<br />
            {<br />
                <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'toggle'</span>] <span style="color: #e28964;">=</span> <span style="color: #3387cc;">false</span>;<br />
                <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'expanded'</span>] <span style="color: #e28964;">=</span> <span style="color: #3387cc;">true</span>;<br />
                <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'children'</span>] <span style="color: #e28964;">=</span> <span style="color: #3e87e3;">$chidls</span>;<br />
                <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'text'</span>] <span style="color: #e28964;">=</span> <span style="color: #65b042;">''</span>;<br />
            }<br />
<span style="color: #e28964;">            else</span><br />
            {<br />
                <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'expanded'</span>] <span style="color: #e28964;">=</span> <span style="color: #3387cc;">false</span>;<br />
                <span style="color: #3e87e3;">$row</span>[<span style="color: #65b042;">'children'</span>] <span style="color: #e28964;">=</span> <span style="color: #3e87e3;">$chidls</span>;<br />
            }<br />
        }<br />
        <span style="color: #3e87e3;">$out</span>[] <span style="color: #e28964;">=</span> <span style="color: #3e87e3;">$row</span>;<br />
    }<br />
<span style="color: #e28964;">    return</span> <span style="color: #3e87e3;">$out</span>;<br />
}</p>
<p><span style="color: #3e87e3;">$this</span><span style="color: #e28964;">-></span>widget(<span style="color: #65b042;">'CTreeView'</span>, <span style="color: #dad085;">array</span>(<span style="color: #65b042;">'data'</span> <span style="color: #e28964;">=></span> RecursiveTree2(<span style="color: #3e87e3;">$all</span>, <span style="color: #3387cc;">0</span>),<br />
    <span style="color: #65b042;">'htmlOptions'</span> <span style="color: #e28964;">=></span> <span style="color: #dad085;">array</span>(<span style="color: #65b042;">'class'</span> <span style="color: #e28964;">=></span> <span style="color: #65b042;">'treeview-red'</span>)));</pre><br />
получили примерно следующее</p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://3.bp.blogspot.com/-K5w9IQZVXCE/VVGUsgAVOmI/AAAAAAAAAYE/zYxPO2US98o/s1600/img.png"><img src="http://3.bp.blogspot.com/-K5w9IQZVXCE/VVGUsgAVOmI/AAAAAAAAAYE/zYxPO2US98o/s640/img.png" alt="" width="640" height="164" border="0" /></a></div></p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://img.prntscr.com/img?url=http://i.imgur.com/u8Yinc7.png">&nbsp;</a></div><br />
..</p>
<div class="separator" style="clear: both; text-align: center;"><a style="margin-left: 1em; margin-right: 1em;" href="http://2.bp.blogspot.com/-Nqm7bcFNBec/VVGUe2qIqcI/AAAAAAAAAX8/qYCeG2De4hY/s1600/img.png"><img src="http://2.bp.blogspot.com/-Nqm7bcFNBec/VVGUe2qIqcI/AAAAAAAAAX8/qYCeG2De4hY/s640/img.png" alt="" width="640" height="97" border="0" /></a></div></p>
<div class="separator" style="clear: both; text-align: center;"></div><br />
..<br />
14. хорошим тоном считается выкладывать исходники<br />
<a href="https://drive.google.com/open?id=0B8SBzylZ-emOcTRLNW16X1BBQUU&amp;authuser=0">вот они</a></p>
<p></div><br />
Source: des1roer.blogspot.com</p>
