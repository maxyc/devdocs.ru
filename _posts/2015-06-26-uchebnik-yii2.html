---
layout: post
status: publish
published: true
title: Учебник yii2
author:
  display_name: Maxyc Webber
  login: admin
  email: maxycws@gmail.com
  url: ''
author_login: admin
author_email: maxycws@gmail.com
wordpress_id: 1621
wordpress_url: http://devdocs.ru/partners-news/uchebnik-yii2/
date: '2015-06-26 08:04:21 +0200'
date_gmt: '2015-06-26 08:04:21 +0200'
categories:
- Yii framework
tags:
- Тема
- php
- ip
- spl
- post
- javascript
- mysql
- sql
- innodb
- css
- tutorial
- git
- bootstrap
- js
- ui
- api
- facebook
- twitter
- тестирование
- TDD
- yii2
- des1roer
- postgresql
- yii
- orm
comments:
- id: 455
  author: andrew
  author_email: boobaleh15@yandex.ru
  author_url: http://gravatar.com/by1andy1for1all1people
  date: '2016-05-25 08:29:43 +0200'
  date_gmt: '2016-05-25 08:29:43 +0200'
  content: Спасибо, не хватало такого учебника - очень полезно для начинающих!
---
<div dir="ltr" style="text-align: left;">1 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Создание сайта с использованием <a href="http://www.yiiframework.com/" target="_blank">Yii</a> 2.x</h3><br />
В данном учебнике описывается процесс создания сайта. Каждый шаг разработки описан максимально подробно и может быть применён при создании других приложений. В дополнение к <a href="http://www.yiiframework.com/doc-2.0/guide-index.html" target="_blank">полному руководству</a>и <a href="http://www.yiiframework.com/doc-2.0/index.html" target="_blank">API</a>, данное пособие показывает, вместо полного и подробного описания, пример практического применения фреймворка Yii.<br />
Для того, чтобы выполнять упражнения из учебника понадобятся инструменты <a href="https://getcomposer.org/" target="_blank">composer</a> и <a href="http://git-scm.com/" target="_blank">git</a>. Не отчаивайтесь, если вам не известны эти инструменты, нужно будет лишь выполнить несколько команд, которые будут описаны.<br />
Разработчики данного интерактивного курса:</p>
<ul>
<li>Евгений Ткаченко (<a href="mailto:et.coder@gmail.com">et.coder@gmail.com</a>)</li><br />
</ul><br />
Сообщество Yii</p>
<ul>
<li><a href="http://www.yiiframework.com/forum/">Форум</a></li>
<li><a href="https://github.com/yiisoft/yii2">GitHub</a></li>
<li><a href="https://www.facebook.com/groups/yiitalk/">Facebook</a></li>
<li><a href="https://twitter.com/yiiframework">Twitter</a></li>
<li><a href="https://www.linkedin.com/groups/yii-framework-1483367">LinkedIn</a></li><br />
</ul></p>
<h3>Начальная установка</h3><br />
Установим стартовый шаблон приложения <a href="https://github.com/yiisoft/yii2-app-advanced" target="_blank">[Yii 2 Advanced Project Template]</a>. Для этого необходимо выполнить команды, из корневой директории учебника(yii2-tutorial):</p>
<pre><code class="hljs coffeescript">composer <span class="hljs-built_in">global</span> <span class="hljs-built_in">require</span> <span class="hljs-string">"fxp/composer-asset-plugin:1.0.0"</span><br />
composer create-project --prefer-dist yiisoft/yii2-app-advanced yii2-app-advanced<br />
</code></pre></p>
<div class="alert alert-info">Если возникают сложности, то ознакомьтесь с <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/start-installation.md" target="_blank">официальным руководством</a></div><br />
Процесс установки шаблона первый раз длительный, поэтому давайте пока познакомимся со структурой учебника. Для этого откройте директорию <code>yii2-tutorial</code> и осмотритесь:</p>
<pre><code class="hljs coffeescript"><span class="hljs-regexp">/scripts/</span>                -> Скрипты для работы учебника<br />
<span class="hljs-regexp">/yii2-app-advanced/</span>      -> Сюда будет загружено демонстрационное приложение<br />
/.gitignore              -> Файл конфигурация, для Git<br />
/readme.md               -> Начальное описание учебника<br />
</code></pre><br />
После того как процесс установки демонстрационного приложения будет окончен, то можно перейти в директорию <code>yii2-app-advanced</code>. Для его инициализации, запуска необходимо выполнить команду в этой директории:</p>
<pre><code class="hljs nginx"><span class="hljs-title">php</span> init --env=Development<br />
</code></pre><br />
После этого будут сгенерированы некоторые файлы для работы всего приложения и будет установлен режим отладки. Теперь вы можете перейти по ссылке, чтобы убедится в работоспособности вашего сайта.</p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul style="text-align: left;">
<li>Ознакомьтесь с информацией об Yii <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/intro-yii.md" target="_blank">официальном руководстве</a>.</li>
<li>Ознакомьтесь с информацией о запуске приложения <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/start-workflow.md" target="_blank">официальном руководстве</a>.2 урок
<div class="col-md-9 col-lg-8">
<h3>Знакомство с шаблоном приложения Advanced</h3><br />
Для перехода к следующему упражнению, выполните команду из директории yii2-tutorial</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">0</span><br />
</code></pre><br />
В последствии будет установлен "Шаблон приложения advanced", который станет доступен по ссылке.</p>
<div class="alert alert-info">Пожалуйста, ознакомьтесь с официальным руководством, для того чтобы иметь представление, как устроен "Шаблон приложения advanced".</div><br />
Все статичные страницы нашего приложения не требуют каких-либо данных. А вот страница <code>Signup</code>(регистрация пользователей) требует подключения к базе данных. Если на этой странице ввести в поля какие-либо данные и нажать кнопку "Signup", то скорее всего увидите ошибку <code>Database Exception...</code>.<br />
Сейчас наш сайт пытается подключится к базе данных <code>yii2advanced</code> MySQL. Yii не ограничивает вас в выборе базы данных, вы можете легко изменить базу данных, будь то MySQL, MSSQL, PostgreSQL или другие. Для обучения будем использовать <a href="https://ru.wikipedia.org/wiki/SQLite" target="_blank">SQLite</a>, так как она компактная и не требует накладных расходов. Знать тонкости синтаксиса SQLite не придётся, так как в большинстве случаев вместо SQL будет использоваться <a href="https://ru.wikipedia.org/wiki/ORM">ORM</a> подход.</p>
<div class="alert alert-warning">Обратите внимание, что для работы PHP и SQLite потребуется подключение php_pdo_sqlite. Проверьте подключено ли оно у вас.</div><br />
Поменяем настройки подключения к базе данных для всего сайта:<br />
Зайдите в <code>/yii2-app-advanced/common/config/</code>. В этой директории хранятся файлы конфигурации для работы всех (клиентской, административной, и других) частей сайта. В файле <code>main-local.php</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">return</span> [<br />
    <span class="hljs-string">'components'</span> => [<br />
        <span class="hljs-string">'db'</span> => [<br />
            <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiidbConnection'</span>,<br />
            <span class="hljs-string">'dsn'</span> => <span class="hljs-string">'mysql:host=localhost;dbname=yii2advanced'</span>,<br />
            <span class="hljs-string">'username'</span> => <span class="hljs-string">'root'</span>,<br />
            <span class="hljs-string">'password'</span> => <span class="hljs-string">''</span>,<br />
            <span class="hljs-string">'charset'</span> => <span class="hljs-string">'utf8'</span>,<br />
        ],<br />
        <span class="hljs-string">'mailer'</span> => [<br />
            <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiiswiftmailerMailer'</span>,<br />
            <span class="hljs-string">'viewPath'</span> => <span class="hljs-string">'@common/mail'</span>,<br />
            <span class="hljs-comment">// send all mails to a file by default. You have to set</span><br />
            <span class="hljs-comment">// 'useFileTransport' to false and configure a transport</span><br />
            <span class="hljs-comment">// for the mailer to send real emails.</span><br />
            <span class="hljs-string">'useFileTransport'</span> => <span class="hljs-keyword">true</span>,<br />
        ],<br />
    ],<br />
];<br />
</code></pre><br />
Компонент <code>mailer</code>(компонент отправки почты) оставим без изменений. А вот настройки компонента <code>db</code> изменим.</p>
<div class="alert alert-info">Подробнее о компонентах в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-application-components.md" target="_blank">официальном руководстве</a></div></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">return</span> [<br />
    <span class="hljs-string">'components'</span> => [<br />
        <span class="hljs-string">'db'</span> => [<br />
            <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiidbConnection'</span>,<br />
            <span class="hljs-string">'dsn'</span> => <span class="hljs-string">'sqlite:'</span> . <span class="hljs-keyword">__DIR__</span>  .<span class="hljs-string">'/../../sqlite.db'</span>,<br />
        ],<br />
    ],<br />
];<br />
</code></pre><br />
В нашем и предыдущем случае за соединение с базой данной отвечает класс <code>yiidbConnection</code>.</p>
<div class="alert alert-info">Рекомендуется ознакомится с <a href="http://www.yiiframework.com/doc-2.0/yii-db-connection.html" target="_blank">API класса Connection</a></div><br />
Для соединения нужно указать DSN, в нашем случае это путь к файлу - <code>/yii2-app-advanced/sqlite.db</code>. Для остальных, наподобие:</p>
<pre><code class="hljs php"><span class="hljs-string">'dsn'</span> => <span class="hljs-string">'pgsql:host=localhost;port=5432;dbname=mydatabase'</span>, <span class="hljs-comment">// PostgreSQL</span><br />
<span class="hljs-string">'dsn'</span> => <span class="hljs-string">'cubrid:dbname=demodb;host=localhost;port=33000'</span>, <span class="hljs-comment">// CUBRID</span><br />
<span class="hljs-string">'dsn'</span> => <span class="hljs-string">'sqlsrv:Server=localhost;Database=mydatabase'</span>, <span class="hljs-comment">// MS SQL Server, sqlsrv</span><br />
<span class="hljs-string">'dsn'</span> => <span class="hljs-string">'dblib:host=localhost;dbname=mydatabase'</span>, <span class="hljs-comment">// MS SQL Server, dblib driver</span><br />
<span class="hljs-string">'dsn'</span> => <span class="hljs-string">'mssql:host=localhost;dbname=mydatabase'</span>, <span class="hljs-comment">// MS SQL Server, mssql driver</span><br />
<span class="hljs-string">'dsn'</span> => <span class="hljs-string">'oci:dbname=//localhost:1521/mydatabase'</span>, <span class="hljs-comment">// Oracle</span><br />
</code></pre></p>
<blockquote><p>Имя источника данных (DSN) - это логическое имя, которое используется ODBC (Open Database Connectivity), чтобы обращаться к диску и другой информации, необходимой для доступа к данным.</blockquote><br />
После настройки подключения, необходимо наполнить данные в базу данных. Для это будем использовать "миграции". Для чего нужны миграции? Вот сейчас нужно заполнить sqlite данными, создать таблицы и чтобы не описывать sql запросы, которые вы должны выполнить, была создана одна миграция. Всё что вам нужно сделать, это выполнить консольную команду в <code>yii2-app-advanced</code>:</p>
<pre><code class="hljs nginx"> <span class="hljs-title">php</span> yii migrate<br />
</code></pre><br />
После этого увидите, что-то вроде:</p>
<pre><code class="hljs coffeescript">yii2-tutorialyii2-app-advanced>php yii migrate<br />
Yii Migration Tool (based <span class="hljs-literal">on</span> Yii v2.0.3)</p>
<p>Total <span class="hljs-number">1</span> <span class="hljs-keyword">new</span> migration to be <span class="hljs-attribute">applied</span>:<br />
     m130524_201442_init</p>
<p>Apply the above migration? (<span class="hljs-literal">yes</span>|<span class="hljs-literal">no</span>) [<span class="hljs-literal">no</span>]:y<br />
*** applying m130524_201442_init<br />
 > create table {{%user}} ... done (<span class="hljs-attribute">time</span>: <span class="hljs-number">0.059</span>s)<br />
*** applied m130524_201442_init (<span class="hljs-attribute">time</span>: <span class="hljs-number">0.111</span>s)</p>
<p>Migrated up successfully.<br />
</code></pre><br />
Теперь в <code>yii2-app-advanced</code> можно обнаружить файл <code>sqlite.db</code> - это и есть наша база данных.<br />
Ну что ж, вернёмся на Signupи попробуем ввести регистрационные данные: <code>Username</code> - <code>admin</code>, <code>Email</code> - <code>admin@local.net</code>, <code>Password</code> - <code>123456</code>. После отправки данных, произойдёт переход на главную страницу с последующей аутентификацией пользователя <code>admin</code>. Сейчас мы находимся в пользовательском приложении (frontend). Шаблон <code>Advanced</code> также реализует административное приложение(backend). Чтобы попасть в него, просто перейдите по ссылке. На данный момент backend скуден по функционалу, чем frontend. Далее постараемся исправить эту ситуацию.</p>
<p></div><br />
3 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Виды и шаблоны</h3><br />
В этом разделе рассмотрим как создать новую страницу со статическим текстом.<br />
Чтобы начать, выполните команду из директории yii2-tutorial</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">0.1</span><br />
</code></pre><br />
Перейдите по ссылке вы попадёте на статическую страницу "About".<br />
Если посмотреть на адрес ссылки, то можно увидеть <code>index.php?r=site%2Fabout</code>. <code>index.php</code> это входной скрипт нашего приложения. Именно через него идут все запросы пользователя на исполнение. Дальше связка <code>site%2Fabout (эквивалентно site/about)</code>. <code>site</code> - имя контроллера, который обрабатывает наш запрос, <code>about</code> - действие, в контроллере которое мы вызываем. Т.е., внутри, Yii переделывает <code>site</code> в класс <code>SiteController</code>, а <code>about</code> в метод <code>function actionAbout() {...}</code> и вызывает его на исполнение.<br />
Найдём этот контроллер и этот метод. Контроллер лежит в <code>yii2-app-advanced/frontend/controllers/SiteController.php</code>, по умолчанию все контроллеры принято располагать в папке <code>controllers/</code> c суффиксом <code>Controller</code> (<a href="https://github.com/yiisoft/yii2/issues/2709" target="_blank">Почему так?</a>).</p>
<div class="alert alert-info">Подробнее о контроллерах и действиях в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-controllers.md" target="_blank">официальном руководстве</a></div><br />
В контроллере <code>SiteController</code> сейчас вызов статической страницы реализован, через <code>actionAbout()</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionAbout</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'about'</span>);<br />
}<br />
</code></pre><br />
Метод возвращает статический текст, который состоит из шаблона и вида.</p>
<blockquote><p>Виды - это часть MVC архитектуры, это код, который отвечает за представление данных конечным пользователям.</blockquote></p>
<blockquote><p>Шаблоны - особый тип видов, которые представляют собой общие части разных видов.</blockquote></p>
<div class="alert alert-info">Подробнее о видах и шаблонах в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-views.md" target="_blank">официальном руководстве</a></div><br />
В данном случае у нас <code>'about'</code> - это вид, файл который лежит в директории <code>yii2-app-advanced/frontend/views/site/</code>.</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">helpers</span><span class="hljs-title">Html</span>;</p>
<p><span class="hljs-comment">/*<span class="hljs-phpdoc"> @var</span> $this yiiwebView */</span><br />
<span class="hljs-variable">$this</span>->title = <span class="hljs-string">'About'</span>;<br />
<span class="hljs-variable">$this</span>->params[<span class="hljs-string">'breadcrumbs'</span>][] = <span class="hljs-variable">$this</span>->title;<br />
<span class="hljs-preprocessor">?></span></p>
<div <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">site</span>-<span class="hljs-title">about</span>"><br />
    <<span class="hljs-title">h1</span>><?= <span class="hljs-title">Html</span>::<span class="hljs-title">encode</span>($<span class="hljs-title">this</span>-><span class="hljs-title">title</span>) ?></<span class="hljs-title">h1</span>></p>
<p>    <<span class="hljs-title">p</span>>Это статическая страница, которая может быть изменена в файле:</<span class="hljs-title">p</span>></p>
<p>    <<span class="hljs-title">code</span>><?= <span class="hljs-title">__FILE__</span> ?></<span class="hljs-title">code</span>><br />
</<span class="hljs-title">div</span>><br />
</span></code></pre><br />
Из содержимого файла <code>about.php</code> можно понять, что доступен объект <code>$this</code> - <a href="http://www.yiiframework.com/doc-2.0/yii-web-view.html" target="_blank">yiiwebView</a>. Этот объект достен во всех видах и шаблонах. В данном случае у нас используется его свойство, <code>$this->title</code>, которое отвечает за заголовок открытой страницы. Также этот заголовок передаётся в "Навигационную цепочку", через</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$this</span>->params[<span class="hljs-string">'breadcrumbs'</span>][] = <span class="hljs-variable">$this</span>->title;<br />
</code></pre><br />
Попробуйте поменять заголовок "About" на текст "О нас!" и откройте страницу.</p>
<p>Видно, что в меню, всё ещё осталось "About". Чтобы это исправить, нужно внести правки в код этого меню. В роли меню выступает виджет <a href="http://www.yiiframework.com/doc-2.0/yii-bootstrap-nav.html" target="_blank">yiibootstrapNav</a>.</p>
<blockquote><p>Виджеты представляют собой многоразовые строительные блоки, используемые в видах для создания элементов пользовательского интерфейса.</blockquote></p>
<div class="alert alert-info">Подробнее о виджетах в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-widgets.md" target="_blank">официальном руководстве</a></div><br />
Виджет меню подключается в шаблоне, который подключается перед показом вида <code>about</code>. Чтобы определить какой шаблон используется, то нужно обратиться к текущему контроллеру <code>`SiteController</code> и его методу <code>render()</code>, которое мы вызываем в нашем действии <code>actionAbout()</code>. Метод <code>render()</code> обращается к свойству <code>layout</code> текущего контроллера, для определения шаблона. Если это свойство не задано у контроллера, то ищется шаблон экземпляра приложения. В данном случае в роли экземпляра приложения выступает класс <code>yiiwebApplication</code>, который создаётся при запуске приложения.</p>
<div class="alert alert-info">Подробнее о процессе "Запуск приложения" в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/start-workflow.md" target="_blank">официальном руководстве</a></div><br />
В общем, обычно всё находится в директории <code>yii2-app-advanced/frontend/views/layouts</code> в файле <code>main.php</code>. Иногда разработчики приложения изменяют эту ситуацию, настраивая конфигурацию <code>yiiwebApplication</code> или <code>SiteController</code> на своё усмотрение. Yii никого в этом не ограничивает. В данный момент, ограничимся тем, что имеем по умолчанию.<br />
Итак, откройте <code>yii2-app-advanced/frontend/views/layout/main.php</code> и ознакомьтесь с содержимым. Это шаблон, который подключается к каждому виду. Т.е. по сути это главная HTML разметка для всех страниц приложения. Виджет меню имеет вид</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">bootstrap</span><span class="hljs-title">Nav</span>;</p>
<p>NavBar::begin([<br />
<span class="hljs-comment">//...</span><br />
NavBar::end();<br />
</code></pre><br />
Найдите код внутри этого виджета</p>
<pre><code class="language-php hljs">[<span class="hljs-string">'label'</span> => <span class="hljs-string">'About'</span>, <span class="hljs-string">'url'</span> => [<span class="hljs-string">'/site/about'</span>]],<br />
</code></pre><br />
И просто изменить <code>label</code> на</p>
<pre><code class="language-php hljs">[<span class="hljs-string">'label'</span> => <span class="hljs-string">'О нас'</span>, <span class="hljs-string">'url'</span> => [<span class="hljs-string">'/site/about'</span>]],<br />
</code></pre><br />
Можете самостоятельно попробовать изменить все остальные пункты меню.<br />
Как видно, всё ещё остались "My Company" и "Home". Возможно вы уже поменяли "My Company" на свой текст, просто заменив его. У приложения есть <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-applications.md#%D0%A1%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9-" target="_blank">свойства</a>, которые доступны для конфигурации. А именно "имя приложения". Оно как раз подходит для того, чтобы быть задействованным в данном случае. Настроим его.<br />
Для этого нужно обратиться к настройкам приложения. Мы это уже делали в уроке, когда знакомились с шаблоном приложения Advanced. Только на этот раз, это будет файл не <code>yii2-app-advanced/common/config/main-local.php</code>, а <code>main.php</code> в той же директории. И измените его на</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">return</span> [<br />
    <span class="hljs-string">'name'</span> => <span class="hljs-string">'Мой сайт'</span>,<br />
    <span class="hljs-string">'language'</span> => <span class="hljs-string">'ru'</span>,<br />
    <span class="hljs-string">'vendorPath'</span> => dirname(dirname(<span class="hljs-keyword">__DIR__</span>)) . <span class="hljs-string">'/vendor'</span>,<br />
    <span class="hljs-string">'components'</span> => [<br />
        <span class="hljs-string">'cache'</span> => [<br />
            <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiicachingFileCache'</span>,<br />
        ],<br />
    ],<br />
];<br />
</code></pre><br />
Изменив <code>'language' => 'ru',</code>, изменился основной язык приложения. Доступные языки для приложения можно обнаружить в <code>yii2-app-advanced/vendor/yiisoft/yii2/messages/</code>. Все возможные сообщения, которые были на английском, станут на русском.<br />
Свойство <code>'name' => 'Мой сайт',</code> доступно в качестве конструкции <code>Yii::$app->name</code>. Не сложно догадаться, что <code>`Yii::$app->language</code> вернёт <code>ru</code>. Т.е. к любому <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-applications.md#%D0%A1%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9-" target="_blank">свойству</a> приложения можно обратиться именно так.<br />
Изменим в главном шаблоне "My Company" на <code>Yii::$app->name</code></p>
<pre><code class="language-php hljs">  NavBar::begin([<br />
                <span class="hljs-string">'brandLabel'</span> => Yii::<span class="hljs-variable">$app</span>->name,<br />
</code></pre><br />
и чуть ниже в footer:</p>
<pre><code class="language-html hljs xml"><span class="hljs-tag"><<span class="hljs-title">p</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"pull-left"</span>></span>&amp;copy; <span class="php"><span class="hljs-preprocessor"><?</span>= Yii::<span class="hljs-variable">$app</span>->name <span class="hljs-preprocessor">?></span></span> <span class="php"><span class="hljs-preprocessor"><?</span>= date(<span class="hljs-string">'Y'</span>) <span class="hljs-preprocessor">?></span></span><span class="hljs-tag"></<span class="hljs-title">p</span>></span><br />
</code></pre></p>
<h3>Хочу ещё больше статических страниц!</h3><br />
Когда у вас будет много статический страниц "О нас", "Режим работы", "Доставка" и прочее, то не совсем удобно, каждый раз в контроллере создавать метод:</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SiteController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionAbout</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'about'</span>);<br />
    }</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionDuty</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'duty'</span>);<br />
    }</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionDelivery</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'delivery'</span>);<br />
    }<br />
}<br />
</code></pre><br />
Для этого уже реализовано одно действие для контроллеров. Это <code>yiiwebViewAction</code></p>
<div class="alert alert-info">Рекомендуется ознокомится с <a href="http://www.yiiframework.com/doc-2.0/yii-web-viewaction.html" target="_blank">API класса ViewAction</a> и перечитать про <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-controllers.md#%D0%9E%D1%82%D0%B4%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D1%8F-" target="_blank">отдельные действия</a> в контроллерах.</div><br />
Найдите в <code>SiteController</code> метод <code>actions</code>, в котором уже имеется:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'page'</span> => [<br />
    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiiwebViewAction'</span>,<br />
],<br />
</code></pre><br />
По умолчанию в Advanced этого кода нет, он добавлен для вашего удобства. Теперь нужно перейти по адресу index.php?r=site/page&amp;view=about<br />
Попробуйте поменять в адресной строке параметр <code>view</code> на duty или delivery. Проанализируйте результаты.</p>
<p></div><br />
4 урок</p>
<div class="row">
<div class="col-md-9 col-lg-8">
<h3>Работа с формами</h3><br />
В этом разделе рассмотрим как создать форму.<br />
Чтобы начать, выполните команду из директории yii2-tutorial</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">0.2</span><br />
</code></pre><br />
Как выглядит форма, созданная с помощью Yii2, можно увидеть по ссылке.<br />
Иногда можно увидеть на этой странице ошибку</p>
<blockquote><p>"Invalid Configuration &ndash; yiibaseInvalidConfigException Either GD PHP extension with FreeType support or ImageMagick PHP extension with PNG support is required.".</blockquote><br />
Связана она с тем, что на этой странице используется CAPTCHA и ей необходима <a href="http://php.net/manual/ru/image.installation.php" target="_blank">GD</a>или <a href="https://php.net/manual/ru/imagick.installation.php" target="_blank">ImageMagick</a> PHP библиотеки.<br />
Если всё в порядке, то продолжим. По адресу ссылки <code>index.php?r=site%2Fcontact</code>, где находится форма, можно увидеть, что используется всё тот же <code>SiteController</code> контроллер, что и в предыдущем уроке. Только тут действие другое - <code>contact</code>. Следовательно открываем <code>frontendcontrollersSiteController::actionContact</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionContact</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> ContactForm();<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post()) &amp;&amp; <span class="hljs-variable">$model</span>->validate()) {<br />
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->sendEmail(Yii::<span class="hljs-variable">$app</span>->params[<span class="hljs-string">'adminEmail'</span>])) {<br />
            Yii::<span class="hljs-variable">$app</span>->session->setFlash(<span class="hljs-string">'success'</span>, <span class="hljs-string">'Спасибо за ваше письмо. Мы свяжемся с вами в ближайшее время.'</span>);<br />
        } <span class="hljs-keyword">else</span> {<br />
            Yii::<span class="hljs-variable">$app</span>->session->setFlash(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Ошибка отправки почты.'</span>);<br />
        }</p>
<p>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->refresh();<br />
    } <span class="hljs-keyword">else</span> {<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'contact'</span>, [<br />
            <span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,<br />
        ]);<br />
    }<br />
}<br />
</code></pre><br />
Видим знакомый уже <code>$this->render</code>, где первым параметром передаётся название вида - в данном случае используется вид <code>'contact'</code>. Открываем его <code>yii2-app-advanced/frontend/views/site/contact.php</code>.<br />
Чтобы создать в Yii html код формы:</p>
<pre><code class="language-html hljs xml"><span class="hljs-tag"><<span class="hljs-title">form</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"..."</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span>></span><br />
    <span class="hljs-tag"><<span class="hljs-title">input</span> <span class="hljs-attribute">...</span>></span><br />
    <span class="hljs-tag"><<span class="hljs-title">input</span> <span class="hljs-attribute">...</span>></span><br />
    <span class="hljs-tag"><<span class="hljs-title">input</span> <span class="hljs-attribute">...</span>></span><br />
    <span class="hljs-tag"><<span class="hljs-title">button</span>></span><br />
<span class="hljs-tag"></<span class="hljs-title">form</span>></span><br />
</code></pre><br />
нужно обратиться за помощью к виджету <code>yiiwidgetsActiveForm</code>. Наследник этого виджета - <code>yiibootstrapActiveForm;</code>, и используется в <code>contact.php</code>. Отличия <code>yiiwidgetsActiveForm</code> от <code>yiibootstrapActiveForm</code> в том, что последний выводит элементы формы с учётом <a href="http://getbootstrap.com/css/#forms" target="_blank">требований Bootstrap</a>.<br />
На первых порах возникает вопрос - зачем использовать этот виджет и вообще php код, если можно использовать HTML. Во-первых использование виджета ускоряет процесс создания рутинных, обычных форм и делает легким процесс проверки пользовательских данных.<br />
В <code>contact.php</code></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span> <span class="hljs-variable">$form</span> = ActiveForm::begin([<span class="hljs-string">'id'</span> => <span class="hljs-string">'contact-form'</span>, <span class="hljs-string">'enableClientValidation'</span> => <span class="hljs-keyword">false</span>]); <span class="hljs-preprocessor">?></span><br />
    <span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'name'</span>) <span class="hljs-preprocessor">?></span><br />
    <span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'email'</span>) <span class="hljs-preprocessor">?></span><br />
    <span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'subject'</span>) <span class="hljs-preprocessor">?></span><br />
    <span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'body'</span>)->textArea([<span class="hljs-string">'rows'</span> => <span class="hljs-number">6</span>]) <span class="hljs-preprocessor">?></span><br />
    <span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'verifyCode'</span>)->widget(<br />
        Captcha::className(),<br />
        [<br />
            <span class="hljs-string">'template'</span> => <span class="hljs-string">'
<div class="row">
<div class="col-lg-3">{image}</div>
<div class="col-lg-6">{input}</div></div>'</span>,<br />
        ]<br />
    ) <span class="hljs-preprocessor">?></span></p>
<div <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">form</span>-<span class="hljs-title">group</span>"><br />
        <?= <span class="hljs-title">Html</span>::<span class="hljs-title">submitButton</span>('Отправить', ['<span class="hljs-title">class</span>' => '<span class="hljs-title">btn</span> <span class="hljs-title">btn</span>-<span class="hljs-title">primary</span>', '<span class="hljs-title">name</span>' => '<span class="hljs-title">contact</span>-<span class="hljs-title">button</span>']) ?><br />
    </<span class="hljs-title">div</span>><br />
<?<span class="hljs-title">php</span> <span class="hljs-title">ActiveForm</span>::<span class="hljs-title">end</span>(); ?><br />
</span></code></pre><br />
Методы <code>ActiveForm::begin</code> и <code>ActiveForm::end();</code> выводят открывающий и закрывающий теги формы. Между этими методами с помощью метода ActiveForm::field создаются элементы формы.</p>
<div class="alert alert-info">Рекомендуется ознакомится с <a href="http://www.yiiframework.com/doc-2.0/yii-bootstrap-activeform.html" target="_blank">API класса ActiveForm</a></div><br />
Вы наверное обратили внимание, что в каждый элемент формы передаётся переменная $model. Yii использует <a href="https://ru.wikipedia.org/wiki/Model-View-Controller" target="_blank">MVC (&laquo;модель-представление-контроллер&raquo;)</a>шаблон проектирования приложения. Вы уже знакомы с контроллерами и представлениям, так вот переменная <code>$model</code> - это недостающее звено, класс который описывает данные и предоставляет методы для работы с этими данными. В данном случае, модель описывает "деловое предложение" или "вопрос" от пользователя, т.е. "обратную связь". В Yii для работы с моделью реализован базовый класс <a href="http://www.yiiframework.com/doc-2.0/yii-base-model.html" target="_blank">yiibaseModel</a>. Этот класс предоставляет методы, которые:</p>
<ul>
<li>помогают наполнять модель данными,</li>
<li>читать данные из модели,</li>
<li>проверять данные на корректность;</li><br />
</ul><br />
Объект модели создаётся в контроллере и передаётся в представление</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionContact</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> ContactForm();</p>
<p>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'contact'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,]);<br />
}<br />
</code></pre><br />
Откройте класс <code>ContactForm</code>, он находится в <code>yii2-app-advanced/frontend/models/</code>.</p>
<div class="alert alert-info">Принято все модели располагать в директории `application/models/`, но вы всегда можете расположить их где угодно с учётом стандарта PSR-4.</div></p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContactForm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$email</span>;<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$subject</span>;<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$body</span>;<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$verifyCode</span>;</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span><br />
    </span>{</p>
<p>    }</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attributeLabels</span><span class="hljs-params">()</span><br />
    </span>{</p>
<p>    }</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendEmail</span><span class="hljs-params">(<span class="hljs-variable">$email</span>)</span><br />
    </span>{</p>
<p>    }<br />
</code></pre><br />
Сначала перечисляются все атрибуты модели, это - имя пользователя($name), электронный адрес($email), тема сообщения($subject), само сообщение($body) и CAPTCHA(verifyCode). Эти атрибуты описывают модель - сущность "обратная связь". Дальше идёт метод <code>rules()</code>, который используется для валидации, проверки атрибутов модели. Второй метод <code>attributeLabels</code>используется для описания меток, маркировок атрибутов на понятном для человека языке. Обычно эти метки используются в представлении для описания элементов форм или другого. Следующий метод <code>sendEmail</code> отвечает за отправку "обратной связи" на электронный адрес администратора сайта.</p>
<h4>Как всё работает? (упрощённо)</h4><br />
Запрос от пользователя поступает на входной скрипт <code>web/index.php</code>. В скрипте создаётся приложение <code>yiiwebApplication</code>с учётом конфигураций. Приложение определяет маршрут - контроллер и действие. Создаётся экземпляр контроллера и вызывается действие. В действии создаёт модель и контроллер передаёт её в вид. Далее генерируется конечный ответ, с учётом шаблонов, видов и данных из моделей. Ответ отдаётся пользователю. Пользователь вводит данные и отправляет их опять в входной скрипт. Всё повторяется до контроллера. Теперь в контроллере опять создаётся модель, но перед отправкой её в представление, она наполняется данными с помощью метода <code>yiibaseModel->load()</code> и затем данные проверяются методом <code>yiibaseModel->validate()</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionContact</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> ContactForm();<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post()) &amp;&amp; <span class="hljs-variable">$model</span>->validate())<br />
</code></pre><br />
Модель наполняется пользовательскими данными с помощью компонента request <code>Yii::$app->request->post()</code>. В первом уроке мы уже знакомились с одним из компонентном <code>db</code>, который служил для настройки базы данных. Любой компонент приложения может быть вызван как <code>Yii::$app->имя_компонента</code>. Где <code>Yii::$app</code> - это приложение, которое было создано в входном файле <code>index.php</code>, а имя компонента можно установить через конфигурацию приложения. Компонент <code>request</code> (служит для работы с HTTP запросами <a href="http://www.yiiframework.com/doc-2.0/yii-web-request.html" target="_blank">yiiwebRequest</a>), с помощью метода <code>post</code> возвращает <code>$_POST</code> данные, которые поступают в метод <code>$model->load</code>. Этот метод модели соотносит её атрибуты с данными из формы, по принципу</p>
<pre><code class="hljs">имя_модели[атрибут] = данные[имя_элемента_формы][атрибут]<br />
</code></pre><br />
В данном случае это:</p>
<pre><code class="hljs markdown">ContactForm[<span class="hljs-link_label">'name'</span>] = $_POST[<span class="hljs-link_label">'ContactForm'</span>][<span class="hljs-link_reference">'name'</span>]<br />
ContactForm[<span class="hljs-link_label">'email'</span>] = $_POST[<span class="hljs-link_label">'ContactForm'</span>][<span class="hljs-link_reference">'email'</span>]<br />
// и так далее.<br />
</code></pre><br />
Данные из формы могут быть какими угодно, поэтому их следует проверить, перед тем как с ними работать. Одну часть работы по проверке данных делает всё тот же метод <code>load</code>. Он определяет каким атрибутам можно задавать значения. Так если бы пользователь отправил из формы данные с именем $_POST['ContactForm']['hack'], то они бы не попали в модель, так как у модели нет атрибута <code>$hack</code>. Также в <code>load</code> срабатывает внутренний механизм, который смотрит метод модели <code>rules</code> и извлекает из него все атрибуты которые там упоминаются. Если какого-то атрибута в <code>rules</code> нет, то атрибут модели считается не безопасным.</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        [[<span class="hljs-string">'name'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'subject'</span>, <span class="hljs-string">'body'</span>], <span class="hljs-string">'required'</span>],<br />
        [<span class="hljs-string">'email'</span>, <span class="hljs-string">'email'</span>],<br />
        [<span class="hljs-string">'verifyCode'</span>, <span class="hljs-string">'captcha'</span>],<br />
    ];<br />
}<br />
</code></pre><br />
Видно, что все возможные атрибуты модели встречаются в коде rules, поэтому в данном случае они все являются безопасными. Т.е. для них выполняется условие:</p>
<pre><code class="hljs">имя_модели[атрибут] = данные[имя_элемента_формы][атрибут]<br />
</code></pre><br />
Метод <code>$model->validate()</code>, который запускает вторую часть проверки данных, формирует из результата метода <code>rules()</code>различные проверки. Делает он это по следующему принципу:</p>
<ul>
<li>перебирается каждый элемент массива: <code>`</code>php [ [['name', 'email', 'subject', 'body'], 'required'], ['email', 'email'], ['verifyCode', 'captcha'], ]; <code>`</code></li>
<li>каждый элемент разбирается на составляющие: названия атрибутов, название валидатора.</li><br />
</ul><br />
<code>required</code> - валидатор, который проверяет отправил ли пользователь необходимые данные. Т.е. отправил ли пользователь name, email, subject, body.<br />
<code>email</code> - валидатор, который проверяет правильность введённого электронного адреса.<br />
<code>captcha</code> - валидатор, который проверяет правильность введённого проверочного кода.<br />
Список встроенных валидаторов можно посмотреть в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/tutorial-core-validators.md" target="_blank">официальном руководстве</a></p>
<h4>Пользовательские данные не корректные.</h4><br />
Если какая-нибудь проверка прошла не успешно, то атрибут модели модель <code>$errors</code> наполняется сообщениями об ошибках с учётом атрибута, в котором возникла ошибка. В результате в контроллере условие не выполняется:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post()) &amp;&amp; <span class="hljs-variable">$model</span>->validate()) {<br />
</code></pre><br />
и в вид отправляется модель с сообщениями об ошибках. В виде <code>contract.php</code> с помощью <code>ActiveForm::field</code> выводятся элементы формы: для тех у кого ошибки, формируются сообщения об ошибках, остальные выводятся со значениями.</p>
<p>По умолчанию в виджете <code>ActiveForm</code> включено свойство <code>$enableClientValidation</code>, которое означает, что проверки выполняются с помощью javascript кода прямо в браузере, а не отправляются на сервер. В нашем примере оно отключено, включите его при создании ActiveForm:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$form</span> = ActiveForm::begin([<span class="hljs-string">'enableClientValidation'</span> => <span class="hljs-keyword">true</span>]);<br />
</code></pre><br />
Теперь при отправки данных, проверка будет происходить сначала в браузере, без отправки запросов на сервер:</p>
<h4>Пользовательские данные корректные.</h4><br />
Если же данные прошли проверку в контроллере:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post()) &amp;&amp; <span class="hljs-variable">$model</span>->validate()) {<br />
</code></pre><br />
то срабатывает метод <code>sendEmail</code> модели, который отправляет сообщение на электронный адрес администратора. Далее с помощью компонента <a href="http://www.yiiframework.com/doc-2.0/yii-web-session.html" target="_blank">yiiwebSession</a>(отвечает за сессию $_SESSION пользователя) формируется статус-ответ об отправки почты. Дальше с помощью <code>Controller->refresh()</code> отправляется ответ пользователю, который содержит заголовки для обновления текущей страницы.</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->sendEmail(Yii::<span class="hljs-variable">$app</span>->params[<span class="hljs-string">'adminEmail'</span>])) {<br />
    Yii::<span class="hljs-variable">$app</span>->session->setFlash(<br />
        <span class="hljs-string">'success'</span>,<br />
        <span class="hljs-string">'Спасибо за ваше письмо. Мы свяжемся с вами в ближайшее время.'</span><br />
    );<br />
} <span class="hljs-keyword">else</span> {<br />
    Yii::<span class="hljs-variable">$app</span>->session->setFlash(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Ошибка отправки почты.'</span>);<br />
}</p>
<p><span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->refresh();<br />
</code></pre></p>
<h3>Создание формы.</h3><br />
Построим новую форму - опрос пользователя. Форма будет содержать следующие элементы:</p>
<ul>
<li>Ф.И.О.</li>
<li>Пол</li>
<li>Вопрос - какие планеты солнечной системы обитаемы?</li>
<li>Вопрос - какие космонавты известны?</li>
<li>Вопрос - на какую планету хотели бы полететь?</li>
<li>Проверочный код - каптча</li><br />
</ul><br />
Форма опрос, в отличие от формы обратной связи, подразумевает под собой анализ ответов всех пользователей. Т.е нам понадобится сохранять в базу данных и обрабатывать пользовательские данные. Как вы помните, базовый класс <code>yiibaseModel</code> позволяет:</p>
<ul>
<li>наполнять модель данными,</li>
<li>извлекать данные из модели,</li>
<li>проверять данные на корректность;</li><br />
</ul><br />
Поэтому его недостаточно для работы с базой данных. В Yii реализован популярный способ доступа к данным <a href="https://ru.wikipedia.org/wiki/ActiveRecord" target="_blank">Active Record</a> - класс <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" target="_blank">yiidbActiveRecord</a>Этот класс наследуется от базового класса <code>yiibaseModel</code>, расширяя его до такого состояния, при котором модель становится отражением строки в таблице из базы данных. Следовательно с моделью можно работать так же как со строкой в базе данных - искать, создавать, изменять, удалять. Следующий код иллюстрирует всю мощь и красоту реализованного шаблона проектирования Active Record в Yii:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> ActiveRecord;<br />
<span class="hljs-variable">$model</span>->attributes = [<span class="hljs-string">'text'</span> => <span class="hljs-string">'Длинный текст'</span>, <span class="hljs-string">'title'</span> => <span class="hljs-string">'Заголовок'</span>];<br />
<span class="hljs-variable">$model</span>->save();<br />
</code></pre><br />
С помощью трёх строк можно наполнить модель данными, проверить данные и в случае корректности, сохранить их в базу данных. Заметьте SQL не использовался, этот код сработает и для используемой нами SQLite и для любой другой СУБД.<br />
И так вернёмся к форме "Опрос". Создадим для начала таблицу в базе данных.<br />
Напомним, что для обращения к базе данных используется компонент, который мы настроили в <code>yii2-app-advanced/common/config/main-local.php</code> конфигурации приложения:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'db'</span> => [<br />
    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiidbConnection'</span>,<br />
    <span class="hljs-string">'dsn'</span> => <span class="hljs-string">'sqlite:'</span> . <span class="hljs-keyword">__DIR__</span>  .<span class="hljs-string">'/../../sqlite.db'</span>,<br />
],<br />
</code></pre><br />
и к нему можно обратиться через <code>Yii::$app->db</code>. Познакомится с методами и свойствами компонента <code>db</code> можно в <a href="http://www.yiiframework.com/doc-2.0/yii-db-connection.html">API класса yiidbConnection</a>.<br />
Для создания в базе данных таблицы, которая будет хранить данные из опросов, нам понадобится миграция. Сейчас она создана, вам её осталось только применить.<br />
Миграции создаются следующим образом:</p>
<pre><code class="hljs coffeescript">yii2-tutorialyii2-app-advanced> php yii migrate/create interview<br />
Yii Migration Tool (based <span class="hljs-literal">on</span> Yii v2.0.3)</p>
<p>Create <span class="hljs-keyword">new</span> migration <span class="hljs-string">'~/yii2-tutorial/yii2-app-advanced/console/migrations/m150428_104828_interview.php'</span>? (<span class="hljs-literal">yes</span>|<span class="hljs-literal">no</span>) [<span class="hljs-literal">no</span>]:<span class="hljs-literal">yes</span><br />
New migration created successfully.<br />
</code></pre><br />
В <code>yii2-app-advanced/console/migrations</code> появится файл, наподобие <code>m150428_104828_interview.php</code>, который содержит класс с тем же именем, что и имя файла. Этот класс содержит два метода <code>up()</code> и <code>down()</code>. Первый описывает, что происходит, когда миграция применяется, второй - что происходит, когда миграция аннулируется. Код принято писать так, чтобы он работал для любой СУБД, пусть то MySQL, PostgreSQL, SQlite или другая. Для того, чтобы писать универсальный код для всех СУБД в Yii реализован <a href="http://www.yiiframework.com/doc-2.0/yii-db-schema.html">абстрактный класс yiidbSchema</a>. Этот класс описывает схему, как хранится информация в СУБД. При создании запроса определяется на основании <code>dns</code> компонента <code>yiidbConnection</code>, какую схему нужно использовать. В свою очередь эта схема реализует работу с данными в зависимости от СУБД.<br />
Миграция для таблицы, которая будет храненить данных из формы "Опрос", выглядит следующим образом(Подробнее в в файле <code>yii2-app-advanced/console/migrations/m150428_104828_interview.php</code>) :</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$this</span>->createTable(<span class="hljs-string">'{{%interview}}'</span>, [<br />
    <span class="hljs-string">'id'</span> => Schema::TYPE_PK,<br />
    <span class="hljs-string">'name'</span> => Schema::TYPE_STRING . <span class="hljs-string">' NOT NULL'</span>,<br />
    <span class="hljs-string">'sex'</span> => Schema::TYPE_BOOLEAN . <span class="hljs-string">' NOT NULL'</span>,<br />
    <span class="hljs-string">'planets'</span> => Schema::TYPE_STRING . <span class="hljs-string">' NOT NULL'</span>,<br />
    <span class="hljs-string">'astronauts'</span> => Schema::TYPE_STRING. <span class="hljs-string">' NOT NULL'</span>,<br />
    <span class="hljs-string">'planet'</span> => Schema::TYPE_INTEGER . <span class="hljs-string">' NOT NULL'</span>,<br />
], <span class="hljs-variable">$tableOptions</span>);<br />
</code></pre><br />
С применением миграций мы уже сталкивались, когда создавали таблицу <code>user</code>. Применим новую миграцию:</p>
<pre><code class="hljs coffeescript">yii2-tutorialyii2-app-advanced> php yii migrate<br />
Yii Migration Tool (based <span class="hljs-literal">on</span> Yii v2.0.3)</p>
<p>Total <span class="hljs-number">1</span> <span class="hljs-keyword">new</span> migration to be <span class="hljs-attribute">applied</span>:<br />
        m150428_104828_interview</p>
<p>Apply the above migration? (<span class="hljs-literal">yes</span>|<span class="hljs-literal">no</span>) [<span class="hljs-literal">no</span>]:<span class="hljs-literal">yes</span><br />
*** applying m150428_104828_interview<br />
    > create table {{%interview}} ... done (<span class="hljs-attribute">time</span>: <span class="hljs-number">0.048</span>s)<br />
*** applied m150428_104828_interview (<span class="hljs-attribute">time</span>: <span class="hljs-number">0.116</span>s)</p>
<p>Migrated up successfully.<br />
</code></pre><br />
Таблица в базе данных создана. Теперь, чтобы использовать Active Record, необходимо создать модель, как отражение строки из СУБД. Чтобы облегчить эту задачу, в Yii есть замечательный инструмент Gii, который генерирует код.</p>
<h4>Gii - магический инструмент, который может написать код за вас.</h4><br />
Gii включен в Advanced шаблоне приложения, если это приложение инициализировано в режиме отладки, т.е. как было ранее сделано, через</p>
<pre><code class="hljs nginx"><span class="hljs-title">php</span> init --env=Development<br />
</code></pre><br />
Чтобы попасть в Gii нужно перейти по ссылке index.php?r=gii и выбрать пункт <strong>Model Generator</strong>.<br />
Если ваш сайт установлен не на локальном хосте, то скорее всего вы увидите на странице Gii ошибку доступа 403.</p>
<blockquote><p>Forbidden (#403) You are not allowed to access this page.</blockquote><br />
<a href="http://www.yiiframework.com/doc-2.0/yii-gii-module.html#$allowedIPs-detail" target="_blank">Доступ по умолчанию</a>разрешён только для <code>['127.0.0.1', '::1'];</code> IP адресов. Настраивается свойство <code>$allowedIPs</code> для Gii через конфигурационные файлы в директории <code>config</code>. Настройки доступа, в зависимости от окружения, на котором запущен сайт, могут изменяться. Поэтому такие настройки принято хранить не в <code>main.php</code>, а в <code>main-local.php</code>. Откройте <code>yii2-app-advanced/frontend/config/main-local.php</code> и измените строку:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$config</span>[<span class="hljs-string">'modules'</span>][<span class="hljs-string">'gii'</span>] = <span class="hljs-string">'yiigiiModule'</span>;<br />
</code></pre><br />
на</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$config</span>[<span class="hljs-string">'modules'</span>][<span class="hljs-string">'gii'</span>] = [<br />
    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiigiiModule'</span>,<br />
    <span class="hljs-string">'allowedIPs'</span> => [<span class="hljs-string">'192.168.0.*'</span>]<br />
];<br />
</code></pre><br />
Теперь на страницу index.php?r=gii разрешено будет заходить только с тех устройств, которые находятся в подсети 192.168.0.0/24<br />
Вернёмся к Model Generator. Этот раздел Gii предназначен для генерации моделей. Для того, чтобы форма была сгенерирована, необходимо указать:</p>
<ul>
<li>имя таблицы</li>
<li>имя будущей модели <code>Interview</code></li>
<li>пространство имени <code>frontendmodels</code></li><br />
</ul><br />
остальные поля оставляем как есть. Нажмём кнопку Preview (предпросмотр) и посмотрите <code>modelsInterview.php</code> будущий код. После этого нажмите Generate. Всё наша модель создана и доступна по <code>/yii2-app-advanced/frontend/models/Interview.php</code>. Gii всё же не всесилен и потребуется внести некоторые изменения в модель. Добавим элемент "проверочный код" - <code>verifyCode</code>, как свойство модели:</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Interview</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">yii</span><span class="hljs-title">db</span><span class="hljs-title">ActiveRecord</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$verifyCode</span>;</p>
<p>    <span class="hljs-comment">//...</span><br />
}<br />
</code></pre><br />
изменим метки для будущих элементов:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attributeLabels</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        <span class="hljs-string">'name'</span> => <span class="hljs-string">'Имя'</span>,<br />
        <span class="hljs-string">'sex'</span> => <span class="hljs-string">'Пол'</span>,<br />
        <span class="hljs-string">'planets'</span> => <span class="hljs-string">'Какие планеты обитаемы?'</span>,<br />
        <span class="hljs-string">'astronauts'</span> => <span class="hljs-string">'Какие космонавты известны?'</span>,<br />
        <span class="hljs-string">'planet'</span> => <span class="hljs-string">'На какую планету хотели бы полететь?'</span>,<br />
        <span class="hljs-string">'verifyCode'</span> => <span class="hljs-string">'Проверочный код'</span>,<br />
    ];<br />
}<br />
</code></pre><br />
И так модель формы готова, сделаем саму форму. Опять обратимся за помощью к Gii, только теперь выберем генератор <code>Form Generator</code>, в котором следует указать:</p>
<ul>
<li>имя вида (View Name) - <code>site/interview</code></li>
<li>имя модели с учётом пространства имён - <code>frontendmodelsInterview</code></li><br />
</ul><br />
Все остальные поля оставим как есть. Нажмём кнопку Preview, а затем Generate - создастся вид в директории <code>views/site/interview.php</code>. Также Gii предложит код действия для контроллера, который необходимо самостоятельно вставить в контроллер <code>SiteController</code>. Вот чуть измененный код действия:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInterview</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> frontendmodelsInterview();</p>
<p>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post())) {<br />
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->validate()) {<br />
            <span class="hljs-comment">// делаем что-то, если форма прошла валидацию</span><br />
            <span class="hljs-keyword">return</span>;<br />
        }<br />
    }</p>
<p>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'interview'</span>, [<br />
        <span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,<br />
    ]);<br />
}<br />
</code></pre><br />
Итак модель, контроллер с действием и представление созданы, теперь можно посмотреть на результат - index.php?r=site/interview</p>
<h4>Настройка вида формы</h4><br />
Изменим вид формы на</p>
<ul>
<li>Вид элемента <code>name</code> остаётся неизменным.</li>
<li>Вид элемента <code>sex</code> необходимо переделать на два переключателя. По умолчанию <code>$form->field()</code> генерирует текстовый <code><input type="text"></code>. Это можно изменить следующим образом:
<pre><code class="language-php hljs"> <span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'sex'</span>)->radioList([<span class="hljs-string">'Мужчина'</span>, <span class="hljs-string">'Женщина'</span>]) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
<a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activefield.html#radioList%28%29-detail" target="_blank">ActiveForm->ActiveField->radioList()</a> - метод в качестве первого элемента принимает массив возможных значений. Так как метка атрибута <code>sex</code> в модели определена как <code>'sex' => 'Пол'</code>, а необходимо "Вы мужчина/женщина?". То можно изменить "пол" на "вы", что не совсем понятно, если эти метки в других местах (например в письме, отчётных таблицах или в прочем). Поэтому сделаем это только в виде, с помощью <a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activefield.html#label%28%29-detail" target="_blank">ActiveField->label()</a>.</li><br />
</ul></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'sex'</span>)->radioList([<span class="hljs-string">'Мужчина'</span>, <span class="hljs-string">'Женщина'</span>])->label(<span class="hljs-string">'Вы:'</span>) <span class="hljs-preprocessor">?></span><br />
</code></pre></p>
<ul>
<li>Дальше идёт список флаги(checkbox). Для генерации их используем метод <a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activefield.html#checkboxList%28%29-detail" target="_blank">ActiveField->checkboxList()</a>.</li><br />
</ul></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'planets'</span>)->checkboxList(<br />
    [<span class="hljs-string">'Меркурий'</span>, <span class="hljs-string">'Венера'</span>, <span class="hljs-string">'Земля'</span>, <span class="hljs-string">'Марс'</span>, <span class="hljs-string">'Юпитер'</span>, <span class="hljs-string">'Сатурн'</span>, <span class="hljs-string">'Уран'</span>, <span class="hljs-string">'Нептун'</span>]<br />
)->label(<span class="hljs-string">'Какие планеты по вашему мнению обитаемы?'</span>) <span class="hljs-preprocessor">?></span><br />
</code></pre></p>
<ul>
<li>Дальше список с множественным выбором(select) и подсказкой(hint) - <a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activefield.html#dropDownList%28%29-detail" target="_blank">ActiveField->dropDownList()</a>:</li><br />
</ul></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'astronauts'</span>)->dropDownList(<br />
    [<br />
        <span class="hljs-string">'Юрий Гагарин'</span>,<br />
        <span class="hljs-string">'Алексей Леонов'</span>,<br />
        <span class="hljs-string">'Нил Армстронг'</span>,<br />
        <span class="hljs-string">'Валентина Терешкова'</span>,<br />
        <span class="hljs-string">'Эдвин Олдрин'</span>,<br />
        <span class="hljs-string">'Анатолий Соловьев'</span><br />
    ],<br />
    [<span class="hljs-string">'size'</span> => <span class="hljs-number">6</span>, <span class="hljs-string">'multiple'</span> => <span class="hljs-keyword">true</span>]<br />
)<br />
->hint(<span class="hljs-string">'С помощью Ctrl вы можете выбрать более одного космонавта'</span>)<br />
->label(<span class="hljs-string">'Какие космонавты вам известны?'</span>) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
<a href="http://www.yiiframework.com/doc-2.0/yii-widgets-activefield.html#hint%28%29-detail" target="_blank">ActiveField->hint()</a> - формирует подсказку для элемента формы.</p>
<ul>
<li>Дальше выпадающий список с одиночным выбором - метод <code>ActiveField->dropDownList()</code>:</li><br />
</ul></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'planet'</span>)->dropDownList(<br />
    [<span class="hljs-string">'Меркурий'</span>, <span class="hljs-string">'Венера'</span>, <span class="hljs-string">'Земля'</span>, <span class="hljs-string">'Марс'</span>, <span class="hljs-string">'Юпитер'</span>, <span class="hljs-string">'Сатурн'</span>, <span class="hljs-string">'Уран'</span>, <span class="hljs-string">'Нептун'</span>]<br />
) <span class="hljs-preprocessor">?></span><br />
</code></pre></p>
<ul>
<li>И виджет каптчи, как элемент формы:</li><br />
</ul></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'verifyCode'</span>)->widget(<br />
    yiicaptchaCaptcha::className(),<br />
    [<br />
        <span class="hljs-string">'template'</span> => <span class="hljs-string">'
<div class="row">
<div class="col-xs-3">{image}</div>
<div class="col-xs-4">{input}</div></div>'</span>,<br />
    ]<br />
)->hint(<span class="hljs-string">'Нажмите на картинку, чтобы обновить.'</span>) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Html шаблона у каптчи формируется исходя из свойства <code>yiicaptchaCaptcha::template</code>. Чтобы настроить само <code>{image}</code> используем <code>CaptchaAction::minLength</code>, <code>CaptchaAction::maxLength</code>, <code>CaptchaAction::height</code> свойства, которые настраиваются в действии <code>captcha</code>, контроллера <code>SiteController</code>.</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actions</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        <span class="hljs-string">'captcha'</span> => [<br />
            <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiicaptchaCaptchaAction'</span>,<br />
            <span class="hljs-string">'minLength'</span>=><span class="hljs-number">3</span>,<br />
            <span class="hljs-string">'maxLength'</span>=><span class="hljs-number">4</span>,<br />
            <span class="hljs-string">'height'</span>=><span class="hljs-number">40</span>,<br />
            <span class="hljs-string">'fixedVerifyCode'</span> => YII_ENV_TEST ? <span class="hljs-string">'testme'</span> : <span class="hljs-keyword">null</span>,<br />
        ],<br />
        <span class="hljs-comment">//...</span><br />
    ];<br />
}<br />
</code></pre></p>
<div class="alert alert-info">Когда формируется элемент капчта, то для получения изображения виджет <a href="http://www.yiiframework.com/doc-2.0/yii-captcha-captcha.html" target="_blank">yiicaptchaCaptcha</a>, по умолчанию, посылает запрос на `site/captcha`. Действие <a href="http://www.yiiframework.com/doc-2.0/yii-captcha-captchaaction.html" target="_blank">yiicaptchaCaptchaAction</a> возвращает изображение каптчи и при этом сохраняет в сессию пользователя проверочный код, для последующей валидации.</div><br />
Обновите страницу с формой. Вид у неё не такой как у результата, который мы ожидали. Всё дело в том, что в виде <code>site/interview.php</code> Gii сгенерировал <code>use yiiwidgetsActiveForm</code> вместо <code>use yiibootstrapActiveForm;</code>. Измените пространство имен на <code> yiibootstrap</code>. Как описывалось ранее, это позволит использовать стили Bootstrap для форм. Вид формы настроен.</p>
<h4>Валидация формы</h4><br />
Модель <code>Interview</code> на данный момент использует правила для проверки, которые Gii подобрал на основании типов полей в базе данных. Перепишем в модели <code>frontend/models/Interview.php</code> некоторые правила валидации:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        [[<span class="hljs-string">'name'</span>, <span class="hljs-string">'sex'</span>, <span class="hljs-string">'planets'</span>, <span class="hljs-string">'astronauts'</span>, <span class="hljs-string">'planet'</span>, <span class="hljs-string">'verifyCode'</span>], <span class="hljs-string">'required'</span>],<br />
        [<span class="hljs-string">'name'</span>, <span class="hljs-string">'string'</span>],<br />
        [<span class="hljs-string">'sex'</span>, <span class="hljs-string">'boolean'</span>, <span class="hljs-string">'message'</span> => <span class="hljs-string">'Пол выбран не верно.'</span>],<br />
        [<br />
            [<span class="hljs-string">'planets'</span>, <span class="hljs-string">'planet'</span>],<br />
            <span class="hljs-string">'in'</span>,<br />
            <span class="hljs-string">'range'</span> => range(<span class="hljs-number">0</span>, <span class="hljs-number">7</span>),<br />
            <span class="hljs-string">'message'</span> => <span class="hljs-string">'Выбран не корректный список планет.'</span>,<br />
            <span class="hljs-string">'allowArray'</span> => <span class="hljs-number">1</span><br />
        ],<br />
        [<br />
            <span class="hljs-string">'astronauts'</span>,<br />
            <span class="hljs-string">'in'</span>,<br />
            <span class="hljs-string">'range'</span> => range(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>),<br />
            <span class="hljs-string">'message'</span> => <span class="hljs-string">'Выбран не корректный список космонавтов.'</span>,<br />
            <span class="hljs-string">'allowArray'</span> => <span class="hljs-number">1</span><br />
        ],<br />
        [<span class="hljs-string">'verifyCode'</span>, <span class="hljs-string">'captcha'</span>],<br />
    ];<br />
}<br />
</code></pre></p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul>
<li>Ознакомьтесь с информацией о работе с формами в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/start-forms.md" target="_blank">официальном руководстве</a>.</li>
<li>Ознакомьтесь с информацией о проверке данных <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/input-validation.md" target="_blank">официальном руководстве</a>.</li>
<li>Ознакомьтесь с информацией о генерация кода при помощи Gii <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/start-gii.md" target="_blank">официальном руководстве</a>.</li><br />
</ul><br />
</div><br />
</div><br />
5 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Обработка формы.</h3><br />
В этом разделе рассмотрим как в Yii работать с базой данных, сессиями. Познакомимся с проведениями и событиями.<br />
Чтобы начать, выполните команду из директории yii2-tutorial</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">0.3</span><br />
</code></pre><br />
В предыдущих главах вы уже узнали: что такое контроллер, что такое модель, что такое виды с шаблонами, как это всё взаимосвязано и где располагается. Поэтому далее многая информация будет дана без разъяснений этих основ.<br />
Вспомните, создавая форму "Опрос", контроллер <code>SiteController</code> ничего в ответ не посылал, когда данные от пользователя поступали валидные:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post())) {<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->validate()) {<br />
        <span class="hljs-comment">// делаем что-то, если форма прошла валидацию</span><br />
        <span class="hljs-keyword">return</span>;<br />
    }<br />
}<br />
</code></pre><br />
Логичнее было отправить сообщение пользователю о успешном принятии его ответов. Также необходимо сохранить эти ответы, для последующего анализа. Ещё запретим принимать участие в опросе тем пользователям, кто уже ответил на вопросы.</p>
<h4>Компонент для работы с сессией.</h4><br />
Давайте сначала проинформируем пользователя об успешном принятии его ответов и перенаправим его на домашнюю страницу, после того как он ввёл корректные данные. Для информирования пользователя запишем ему сообщение в сессию. Когда пользователя перебросит на домашнюю страницу, покажем сообщение из сессии и удалим его впоследствии.</p>
<div class="alert alert-info">Ознакомьтесь с информацией <a href="http://php.net/manual/ru/book.session.php" target="_blank">"Управление сессиями в PHP"</a></div><br />
В Yii2 для работы с сессиями используется компонент <a href="http://www.yiiframework.com/doc-2.0/yii-web-session.html" target="_blank">yiiwebSession</a>, к которому можно обратиться через <code>Yii::$app->session</code>. У компонента Session есть свойство <code>$flash</code>, которое предназначено именно для нашей задачи. Следующий код</p>
<pre><code class="language-php hljs">Yii::<span class="hljs-variable">$app</span>->session->setFlash(<br />
    <span class="hljs-string">'success'</span>,<br />
    <span class="hljs-string">'Спасибо, что уделили время. В ближайшее время будут опубликованы результаты.'</span><br />
);<br />
</code></pre><br />
создаст в сессии пользователя сообщение с ключом <code>success</code>. Останется только вывести это сообщение. Yii упрощает это до предельно возможной простоты - ничего не нужно делать. В главном шаблоне <code>main.php</code> есть код:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= frontendwidgetsAlert::widget() <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
это виджет, который располагается в директории <code>yii2-app-advancedfrontendwidgets</code>. Откройте его и ознакомьтесь.<br />
Alert виджет выводит сообщение из сессии, которое было задано с помощью <code>setFlash</code> и распознаёт по ключу, какой стиль css Bootstrap применить к данном сообщению. В данном случае ключ <code>success</code> подключит css <code>'alert alert-success'</code>:</p>
<div class="alert alert-success">Спасибо, что уделили время. В ближайшее время будут опубликованы результаты.</div><br />
И так добавим <code>yiiwebSession->setFlash()</code> в действие контроллера:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInterview</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> Interview();<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post())) {<br />
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->validate()) {<br />
            Yii::<span class="hljs-variable">$app</span>->session->setFlash(<br />
                <span class="hljs-string">'success'</span>,<br />
                <span class="hljs-string">'Спасибо, что уделили время. В ближайшее время будут опубликованы результаты.'</span><br />
            );<br />
        }<br />
    }<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'interview'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,]);<br />
}<br />
</code></pre><br />
Теперь когда форма запроса будет верно заполнена и отправлена, должно появиться сообщение. Проверьте.<br />
После успешной отправки формы, страница с формой опять выводится на экран, так как сработал <code>$this->render('interview'...)</code>. Перенаправим пользователя, на домашнюю страницу. Для формирования URL адресов в Yii используется класс помощник <a href="http://www.yiiframework.com/doc-2.0/yii-helpers-url.html" target="_blank">yiihelpersUrl</a>. В API этого класса можно найти метод <code>home()</code>, который перенаправляет на домашнюю страницу. Домашняя страница может быть задана через конфигурацию приложения <code>Yii::$app->homeUrl</code>, так же, как настраивали язык и имя нашего приложения:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">return</span> [<br />
    <span class="hljs-string">'name'</span> => <span class="hljs-string">'Мой сайт'</span>,<br />
    <span class="hljs-string">'language'</span> => <span class="hljs-string">'ru'</span>,<br />
    <span class="hljs-string">'homeUrl'</span> => [<span class="hljs-string">'/site/interview'</span>],<br />
]<br />
</code></pre><br />
Url формируется как id контроллера и id действия - это не строка, а массив так как:</p>
<ul>
<li>вторым и последующим элементом может быть переданы $_GET параметры</li><br />
</ul></p>
<pre><code class="language-php hljs"><span class="hljs-string">'homeUrl'</span> => [<span class="hljs-string">'/site/page'</span>, <span class="hljs-string">'view'</span>=><span class="hljs-string">'duty'</span>],<br />
</code></pre></p>
<ul>
<li>если это строка, то путь будет создан не как <code>http://localhost:8888/yii2-app-advanced/frontend/web/index.php?r=/site/interview</code>, а как <code>http://localhost:8888/site/interview</code>.</li><br />
</ul><br />
Имя приложения и язык приложения мы настраивали <code>yii2-app-advanced/common/config/main.php</code>. Эта конфигурация располагается в директории <code>common</code>, что означает что конфигурация будет применена ко всем приложениями - консольному, административной части (backend), клиентской части (frontend) и другим. Мы работаем в <code>frontend</code>, поэтому homeUrl установим только для него, так как, например, в административной части URL домашней страницы может и не быть.<br />
В файле конфигурации <code>yii2-app-advanced/frontend/config/main.php</code> добавьте код:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'homeUrl'</span> => [<span class="hljs-string">'/site/page'</span>, <span class="hljs-string">'view'</span>=><span class="hljs-string">'about'</span>],<br />
</code></pre><br />
Теперь при вызове <code>Url::homeUrl()</code> будет сформирован <code>/index.php?r=site/page&amp;view=about</code>. Чтобы перенаправить пользователя по этому адресу используем метод контроллера <code>redirect()</code></p>
<pre><code class="language-php hljs"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">helpers</span><span class="hljs-title">Url</span>;</p>
<p><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SiteController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInterview</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> Interview();<br />
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post())) {<br />
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->validate()) {<br />
                Yii::<span class="hljs-variable">$app</span>->session->setFlash(<br />
                    <span class="hljs-string">'success'</span>,<br />
                    <span class="hljs-string">'Спасибо, что уделили время. В ближайшее время будут опубликованы результаты.'</span><br />
                );<br />
                <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->redirect(Url::home());<br />
            }<br />
        }<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'interview'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,]);<br />
    }<br />
}<br />
</code></pre><br />
Теперь когда пользователь ответит на опрос, его перебросит на домашнюю страницу. Но он может схитрить - снова вернуться на страницу с формой и ответить заново. Ограничим доступ к форме, если пользователь уже отвечал. Сделаем это через всю туже сессию - когда пользователь открывать страницу с формой, в контроллере будет срабатывать проверка по поиску определённого ключа в сессии, если он найден, то запретим пользователю дальнейшую работу с формой. Ключ в сессии будем создавать только, когда форма прошла валидацию.<br />
Такое ограничение нам может понадобиться в будущем в разных ситуациях: участие в акциях, опросах, вручение подарков и прочее. Поэтому давайте сделаем так, чтобы можно было легко использовать наш код в разных действиях контроллеров. Т.е. если писать:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInterview</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">if</span> (Yii::<span class="hljs-variable">$app</span>->session->get(<span class="hljs-string">'уникальный-ключ'</span>) === <span class="hljs-keyword">null</span>) {<br />
        <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> Interview();<br />
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post())) {<br />
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->validate()) {<br />
                Yii::<span class="hljs-variable">$app</span>->session->set(<span class="hljs-string">'уникальный-ключ'</span>,<span class="hljs-number">1</span>);<br />
                <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->redirect(Url::home());<br />
            }<br />
        }<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'interview'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,]);<br />
    } <span class="hljs-keyword">else</span> {<br />
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"ДОСТУП ЗАКРЫТ"</span>;<br />
    }<br />
}<br />
</code></pre><br />
то нужно будет в других действиях проделывать аналогичные действия. В <a href="http://www.yiiframework.com/doc-2.0/yii-base-controller.html" target="_blank">yiibaseController</a> есть константы:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">const</span> EVENT_BEFORE_ACTION = <span class="hljs-string">'beforeAction'</span>;<br />
<span class="hljs-keyword">const</span> EVENT_AFTER_ACTION = <span class="hljs-string">'afterAction'</span>;<br />
</code></pre><br />
Из их названия видно, что первое называется "СОБЫТИЕ_ПОСЛЕ_ДЕЙСТВИЯ", второе - "СОБЫТИЕ_ПЕРЕД_ДЕЙСТВИЕМ".</p>
<h4>События и поведения.</h4></p>
<blockquote><p>Событие &mdash; то, что происходит в некоторый момент времени и рассматривается как изменение состояния чего-либо.</blockquote><br />
Т.е. можно догадаться, что эти две константы описывают методы, которые сработают до действия и после.</p>
<div class="alert alert-info">Рекомендуется ознакомится с <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/concept-events.md" target="_blank">информацией о событиях в Yii 2</a></div><br />
При срабатывании события EVENT_BEFORE_ACTION, нам необходимо проверить, есть ли ключ в сессии пользователя. А при срабатывании EVENT_AFTER_ACTION нам необходимо установить этот ключ, но с одной оговоркой - если форма корректна.<br />
В контроллере нужно написать, что-то вроде такого:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$this</span>->on(<br />
    <span class="hljs-variable">$this</span>::EVENT_BEFORE_ACTION,<br />
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{<br />
        <span class="hljs-keyword">if</span> (Yii::<span class="hljs-variable">$app</span>->session->get(<span class="hljs-string">'уникальный-ключ'</span>) !== <span class="hljs-keyword">null</span>) {<br />
            <span class="hljs-keyword">echo</span> <span class="hljs-string">"ДОСТУП ЗАКРЫТ"</span>;<br />
        }<br />
    }<br />
);<br />
<span class="hljs-variable">$this</span>->on(<br />
    <span class="hljs-variable">$this</span>::EVENT_AFTER_ACTION,<br />
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{<br />
        Yii::<span class="hljs-variable">$app</span>->session->set(<span class="hljs-string">'уникальный-ключ'</span>, <span class="hljs-number">1</span>);<br />
    }<br />
);<br />
</code></pre><br />
Сразу возникают вопросы:</p>
<ul>
<li>Как отключить EVENT_AFTER_ACTION, если данные в форме некорректные и требуют правок со стороны пользователя?</li>
<li>Куда этот код вставлять?</li><br />
</ul><br />
Сейчас контроллер <strong>ведёт</strong> себя определённым образом:</p>
<ul>
<li>Контроллер последовательно вызывает метод beforeAction() приложения и самого контроллера. Если один из методов вернул false, то остальные, невызванные методы beforeAction будут пропущены, а выполнение действия будет отменено; По умолчанию, каждый вызов метода beforeAction() вызовет событие EVENT_BEFORE_ACTION.</li>
<li>Контроллер запускает действие: параметры действия будут проанализированы и заполнены из данных запроса.</li>
<li>Контроллер последовательно вызывает методы afterAction контроллера и приложения. По умолчанию, каждый вызов метода afterAction() вызовет событие EVENT_AFTER_ACTION.</li><br />
</ul><br />
Нужно как-то вклинится в это <strong>поведение</strong> с проверками сессии. Для работы с поведениями в Yii используется <a href="http://www.yiiframework.com/doc-2.0/yii-base-behavior.html" target="_blank">yiibaseBehavior</a></p>
<div class="alert alert-info">Рекомендуется ознакомится с <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/concept-behaviors.md" target="_blank">информацией о поведениях в Yii 2</a></div><br />
У контроллера есть метод <code>behaviors()</code>, в котором можно описать поведения. Сейчас в <code>SiteController</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">behaviors</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        <span class="hljs-string">'access'</span> => [<br />
            <span class="hljs-string">'class'</span> => AccessControl::className(),<br />
            <span class="hljs-string">'only'</span> => [<span class="hljs-string">'logout'</span>, <span class="hljs-string">'signup'</span>],<br />
            <span class="hljs-string">'rules'</span> => [<br />
                [<br />
                    <span class="hljs-string">'actions'</span> => [<span class="hljs-string">'signup'</span>],<br />
                    <span class="hljs-string">'allow'</span> => <span class="hljs-keyword">true</span>,<br />
                    <span class="hljs-string">'roles'</span> => [<span class="hljs-string">'?'</span>],<br />
                ],<br />
                [<br />
                    <span class="hljs-string">'actions'</span> => [<span class="hljs-string">'logout'</span>],<br />
                    <span class="hljs-string">'allow'</span> => <span class="hljs-keyword">true</span>,<br />
                    <span class="hljs-string">'roles'</span> => [<span class="hljs-string">'@'</span>],<br />
                ],<br />
            ],<br />
        ],<br />
        <span class="hljs-string">'verbs'</span> => [<br />
            <span class="hljs-string">'class'</span> => VerbFilter::className(),<br />
            <span class="hljs-string">'actions'</span> => [<br />
                <span class="hljs-string">'logout'</span> => [<span class="hljs-string">'post'</span>],<br />
            ],<br />
        ],<br />
    ];<br />
}<br />
</code></pre><br />
Что этот код обозначает мы разберём в ближайших главах, а сейчас просто добавим своё поведение, назовём его к примеру <code>accessOnce</code>.</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">behaviors</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        <span class="hljs-string">'accessOnce'</span> => [<br />
            <span class="hljs-string">'class'</span> =><br />
        ],<br />
        <span class="hljs-comment">//...</span><br />
    ];<br />
}<br />
</code></pre><br />
Нужно указать класс поведения - создадим его. Создайте директорию <code>yii2-app-advanced/frontend/behaviors</code> и в ней класс:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">namespace</span> <span class="hljs-title">frontend</span><span class="hljs-title">behaviors</span>;</p>
<p><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">base</span><span class="hljs-title">Behavior</span>;</p>
<p><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessOnce</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Behavior</span><br />
</span>{</p>
<p>}<br />
</code></pre><br />
допишем в контроллере:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'accessOnce'</span> => [<br />
    <span class="hljs-string">'class'</span> => frontendbehaviorsAccessOnce::className(),<br />
],<br />
</code></pre><br />
В принципе это "пустышка", т.е. если перейти на страницу с формой "Опроса", то ничего изменится. Но когда поведение прикреплено к наследнику базового класса <a href="http://www.yiiframework.com/doc-2.0/yii-base-object.html" target="_blank">yiibaseObject</a>, т.е. к почти ко всем классам Yii, то в поведении, после создания его объекта, свойству <code>$owner</code> присваивается объект, который вызвал это поведение. По-простому: объект класса <code>SiteController</code> является владельцем поведения <code>AccessOnce</code> и может быть в поведении получен через <code>$this->owner</code>. Следовательно, становится доступно влиять на события владельца поведения, через <code>$this->owner->on(...)</code>. Но опять же, куда вставлять этот код? Логичнее было бы прикрепить обработчик события при создании объекта поведения, делается это через переопределение метода <code>yiibaseBehavior::events()</code>:</p>
<pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessOnce</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Behavior</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">events</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-variable">$owner</span> = <span class="hljs-variable">$this</span>->owner;</p>
<p>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$owner</span> <span class="hljs-keyword">instanceof</span> Controller) {<br />
            <span class="hljs-keyword">return</span> [<br />
                <span class="hljs-variable">$owner</span>::EVENT_BEFORE_ACTION => <span class="hljs-string">'имя_обработчика'</span>,<br />
                <span class="hljs-variable">$owner</span>::EVENT_AFTER_ACTION => <span class="hljs-string">'имя_обработчика'</span>,<br />
            ];<br />
        }</p>
<p>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">parent</span>::events();<br />
    }<br />
}<br />
</code></pre><br />
Т.к. поведение может быть прикреплено к разным объектам(контроллерам, моделям, представлениями и прочему), то событий EVENT_BEFORE_ACTION и EVENT_AFTER_ACTION у этих объектов может и не быть. Поэтому вводим дополнительную проверку</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$owner</span> <span class="hljs-keyword">instanceof</span> Controller) {<br />
</code></pre><br />
которая ограничит неверное использование поведения AccessOnce.<br />
Теперь создадим обработчиков, которые будут срабатывать при наступлении событий:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> имя<span class="hljs-title">_</span>обработчика<span class="hljs-params">(<span class="hljs-variable">$event</span>)</span><br />
</span>{</p>
<p>}<br />
</code></pre><br />
В обработчике будет доступно, $event - наследник класса <a href="http://www.yiiframework.com/doc-2.0/yii-base-event.html" target="_blank">yiibaseEvent</a>Наследник определяется в зависимости от того, кто это событие вызвал. В данном случае $event - <a href="http://www.yiiframework.com/doc-2.0/yii-base-actionevent.html" target="_blank">yiibaseActionEvent</a>, т.к. в любом контроллере присутствует код:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beforeAction</span><span class="hljs-params">(<span class="hljs-variable">$action</span>)</span><br />
</span>{<br />
    <span class="hljs-variable">$event</span> = <span class="hljs-keyword">new</span> ActionEvent(<span class="hljs-variable">$action</span>);<br />
    <span class="hljs-variable">$this</span>->trigger(<span class="hljs-keyword">self</span>::EVENT_BEFORE_ACTION, <span class="hljs-variable">$event</span>);<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$event</span>->isValid;<br />
}</p>
<p><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterAction</span><span class="hljs-params">(<span class="hljs-variable">$action</span>, <span class="hljs-variable">$result</span>)</span><br />
</span>{<br />
    <span class="hljs-variable">$event</span> = <span class="hljs-keyword">new</span> ActionEvent(<span class="hljs-variable">$action</span>);<br />
    <span class="hljs-variable">$event</span>->result = <span class="hljs-variable">$result</span>;<br />
    <span class="hljs-variable">$this</span>->trigger(<span class="hljs-keyword">self</span>::EVENT_AFTER_ACTION, <span class="hljs-variable">$event</span>);<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$event</span>->result;<br />
}<br />
</code></pre><br />
И так создадим обработчик, который закрывает доступ, создаёт переменную в сессии.</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closeDoor</span><span class="hljs-params">(yiibaseActionEvent <span class="hljs-variable">$event</span>)</span><br />
</span>{<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$event</span>->action->id === <span class="hljs-string">'interview'</span>) {<br />
        Yii::<span class="hljs-variable">$app</span>->session->set(<span class="hljs-string">'interview-access-lock'</span>, <span class="hljs-number">1</span>);<br />
    }<br />
}<br />
</code></pre><br />
Но как же универсальность, а если мы захотим прикрепить наше поведение на другое действие, не <code>interview</code>? Переделаем. Добавим в наше поведение переменную <code>$actions</code>, которое будет следить на какие действия вешать "замок".</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessOnce</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Behavior</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$actions</span> = [];    </p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closeDoor</span><span class="hljs-params">(yiibaseActionEvent <span class="hljs-variable">$event</span>)</span><br />
    </span>{<br />
        <span class="hljs-keyword">if</span> (in_array(<span class="hljs-variable">$event</span>->action->id, <span class="hljs-variable">$this</span>->actions, <span class="hljs-keyword">true</span>)) {<br />
            Yii::<span class="hljs-variable">$app</span>->session->set(<span class="hljs-variable">$event</span>->action->id . <span class="hljs-string">'-access-lock'</span>, <span class="hljs-number">1</span>);<br />
        }<br />
    }<br />
}<br />
</code></pre><br />
Аналогично сделаем обработчик, который будет проверять переменную в сессии</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessOnce</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Behavior</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$actions</span> = [];</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$message</span> = <span class="hljs-string">'Доступ ограничен. Вы ранее совершали действия на этой странице.'</span>;  </p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkAccess</span><span class="hljs-params">(yiibaseActionEvent <span class="hljs-variable">$event</span>)</span><br />
    </span>{<br />
        <span class="hljs-keyword">if</span> (in_array(<span class="hljs-variable">$event</span>->action->id, <span class="hljs-variable">$this</span>->actions, <span class="hljs-keyword">true</span>)) {<br />
            <span class="hljs-keyword">if</span> (Yii::<span class="hljs-variable">$app</span>->session->get(<span class="hljs-variable">$event</span>->action->id . <span class="hljs-string">'-access-lock'</span>) !== <span class="hljs-keyword">null</span>) {<br />
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpException(<span class="hljs-number">403</span>, <span class="hljs-variable">$this</span>->message);<br />
            }<br />
        }<br />
    }<br />
}<br />
</code></pre><br />
При срабатывании</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpException(<span class="hljs-number">403</span>, <span class="hljs-variable">$this</span>->message);<br />
</code></pre><br />
пользователя перекинет на <code>/index.php?r=site/error</code>. Самостоятельно попробуйте разобраться как сработает <code>site/error</code>.<br />
После всего сделанного, в итоге имеем:</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SiteController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">behaviors</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-keyword">return</span> [<br />
            <span class="hljs-string">'accessOnce'</span> => [<br />
                <span class="hljs-string">'class'</span> => <span class="hljs-string">'frontendbehaviorsAccessOnce'</span>,<br />
                <span class="hljs-string">'actions'</span> => [<span class="hljs-string">'interview'</span>]<br />
            ],<br />
        ];<br />
    }</p>
<p>     <span class="hljs-comment">//...</span><br />
}</p>
<p><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessOnce</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Behavior</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">events</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-variable">$owner</span> = <span class="hljs-variable">$this</span>->owner;</p>
<p>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$owner</span> <span class="hljs-keyword">instanceof</span> Controller) {<br />
            <span class="hljs-keyword">return</span> [<br />
                <span class="hljs-variable">$owner</span>::EVENT_BEFORE_ACTION => <span class="hljs-string">'checkAccess'</span>,<br />
                <span class="hljs-variable">$owner</span>::EVENT_AFTER_ACTION => <span class="hljs-string">'closeDoor'</span>,<br />
            ];<br />
        }</p>
<p>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">parent</span>::events();<br />
    } </p>
<p>    <span class="hljs-comment">//...</span><br />
}<br />
</code></pre><br />
Первый раз EVENT_BEFORE_ACTION пускает нас на страницу, так как не обнаруживает переменную в сессии. EVENT_AFTER_ACTION устанавливает эту переменную и при повторном заходе на страницу, EVENT_BEFORE_ACTION нас уже не пропускает. Чтобы изменить такое поведение, нужно отключить EVENT_AFTER_ACTION, если данные не корректные. Для этого отключаем поведение, через <code>Controller::detachBehaviors</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInterview</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> Interview();<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post())) {<br />
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->validate()) {<br />
            Yii::<span class="hljs-variable">$app</span>->session->setFlash(<br />
                <span class="hljs-string">'success'</span>,<br />
                <span class="hljs-string">'Спасибо, что уделили время. В ближайшее время будут опубликованы результаты.'</span><br />
            );<br />
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->redirect(Url::home());<br />
        }<br />
    }<br />
    <span class="hljs-variable">$this</span>->detachBehaviors(<span class="hljs-string">'accessOnce'</span>);<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'interview'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,]);<br />
}<br />
</code></pre><br />
Теперь обработчик EVENT_BEFORE_ACTION <code>checkAccess</code> будет срабатывать каждый раз. А обработчик <code>closeDoor</code> события EVENT_AFTER_ACTION будет срабатывать, только когда сработает <code>return $this->redirect(Url::home());</code>, в противном случае поведение будет откреплено от контроллера и не сможет влиять на обработку события.</p>
<h4>Осталось сохранить данные.</h4><br />
Таблицу <code>interview</code> в базе данных, которая описывает нашу модель <code>frontend/models/Interview</code>, мы создали ранее. Напомним, что использовали шаблон проектирования Active Record. Модель <code>Interview</code> наследует всю функциональность из <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" target="_blank">yiidbActiveRecord</a>, поэтому трудностей с сохранением не должно возникнуть. Нужно использовать лишь один метод <code>save($runValidation == true)</code>, который также включает в себя валидацию данных. Т.е. метод <code>$model->validate()</code> мы можем заменить на <code>$model->save()</code> в контроллере <code>SiteController</code>.</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionInterview</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> Interview();</p>
<p>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$model</span>->load(Yii::<span class="hljs-variable">$app</span>->request->post()) &amp;&amp; <span class="hljs-variable">$model</span>->save()) {<br />
        Yii::<span class="hljs-variable">$app</span>->session->setFlash(<br />
            <span class="hljs-string">'success'</span>,<br />
            <span class="hljs-string">'Спасибо, что уделили время. В ближайшее время будут опубликованы результаты.'</span><br />
        );<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->redirect(Url::home());<br />
    }</p>
<p>    <span class="hljs-variable">$this</span>->detachBehaviors(<span class="hljs-string">'accessOnce'</span>);</p>
<p>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->render(<span class="hljs-string">'interview'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,]);<br />
}<br />
</code></pre><br />
Метод <code>save($runValidation)</code> подразумевает под собой следующий сценарий:</p>
<ol>
<li>вызывается <code>beforeValidate()</code>, если <code>$runValidation = true</code>. Если <code>$runValidation = false</code> этот и последующий шаги игнорируется.</li>
<li>вызывается <code>afterValidate()</code>.</li>
<li>вызывается <code>beforeSave()</code>. Если метод возвращает false, то процесс прерывается и дальнейшие шаги не выполняются.</li>
<li>происходит сохранение данных в базу данных</li>
<li>вызывается <code>afterSave()</code>;</li><br />
</ol><br />
В нашем случае есть один нюанс - например, на вопрос "Какие космонавты вам известны?", пользователь может выбрать несколько вариантов. Следовательно данные поступят в модель в виде массива значений, а в базе это поле хранится в виде строки. Получается необходимо преобразовать массив данных в строку для последующего сохранения. Сделаем это с помощью переопределения метода <code>beforeSave()</code> в модели Interview:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beforeSave</span><span class="hljs-params">(<span class="hljs-variable">$insert</span>)</span><br />
</span>{<br />
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">parent</span>::beforeSave(<span class="hljs-variable">$insert</span>)) {<br />
        <span class="hljs-variable">$this</span>->planets = implode(<span class="hljs-string">','</span>, <span class="hljs-variable">$this</span>->planets);<br />
        <span class="hljs-variable">$this</span>->astronauts = implode(<span class="hljs-string">','</span>, <span class="hljs-variable">$this</span>->astronauts);<br />
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br />
    }</p>
<p>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br />
}<br />
</code></pre></p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-models.md" target="_blank">Модели</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/start-databases.md" target="_blank">Работа с базами данных</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/concept-components.md" target="_blank">Компоненты</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/runtime-sessions-cookies.md" target="_blank">Сессии и куки</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/runtime-routing.md" target="_blank">Работа с URL</a>.</li><br />
</ul><br />
6 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Административное приложение Backend</h3><br />
В этом разделе добавим функциональности в backend приложение. Создадим место, где администратор сможет просматривать результаты опроса. Рассмотрим возможности ограничения доступа к тому или иному функционалу.<br />
Чтобы начать, выполните команду из директории yii2-tutorial:</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">0.4</span><br />
</code></pre><br />
Входной файл административного раздела (далее Backend) доступен по ссылке /yii2-app-advanced/backend/web/index.php, а все файлы для работы backend располагаются в директории <code>/yii2-app-advanced/backend/</code>.<br />
Если вы не прошли аутентификацию на сайте, то в backend вас не пустит. В работу вступил так называемый фильтр контроллера <a href="http://www.yiiframework.com/doc-2.0/yii-filters-accesscontrol.html" target="_blank">yiifiltersAccessControl</a>. Фильтры являются особым видом поведений, которые могут быть выполнены до действия контроллера или после.<br />
Если открыть <code>SiteController</code> backend части, то можно обнаружить следующий код:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">return</span> [<br />
    <span class="hljs-string">'access'</span> => [<br />
        <span class="hljs-string">'class'</span> => AccessControl::className(),<br />
        <span class="hljs-string">'rules'</span> => [<br />
            [<br />
                <span class="hljs-string">'actions'</span> => [<span class="hljs-string">'login'</span>, <span class="hljs-string">'error'</span>],<br />
                <span class="hljs-string">'allow'</span> => <span class="hljs-keyword">true</span>,<br />
            ],<br />
            [<br />
                <span class="hljs-string">'actions'</span> => [<span class="hljs-string">'logout'</span>, <span class="hljs-string">'index'</span>],<br />
                <span class="hljs-string">'allow'</span> => <span class="hljs-keyword">true</span>,<br />
                <span class="hljs-string">'roles'</span> => [<span class="hljs-string">'@'</span>],<br />
            ],<br />
        ],<br />
    ],<br />
];<br />
</code></pre><br />
С помощью правил доступа <code>rules</code> можно описать к каким действиям контроллера применять те или иные ограничения.</p>
<div class="alert alert-info">Подробная информация по работе фильтров описана в <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-filters.md" target="_blank">официальном руководстве</a></div><br />
TODO: <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/security-authentication.md">https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/security-authentication.md</a><br />
Теперь давайте вернёмся к форме "Опрос". Для работы с формой в клиентской части(далее frontend) мы использовали Active Record модель <code>Interview</code>, которая описывала форму. Т.к. эта модель описана в frontend, то в backend она не доступна. Чтобы исправить это, необходимо модель расположить в общей директории - <code>common/models/</code>. Необходимо скопировать файл <code>Interview.php</code> из <code>frontend/models</code> в <code>common/models/</code>. Это уже сделано.<br />
Вам осталось изменить файлы следующим образом. В common модели изменим пространство имени, удалим свойство "проверочный код", удалим правила, так как это всё требуется на стороне frontend части. А в frontend модели изменить родительский класс с <code>yiidbActiveRecord</code> на <code>commonmodelsInterview</code> и удалите методы <code>tableName()</code> и <code>attributeLabels()</code>.<br />
Теперь, когда все изменения внесены, в backend возможно использовать модель <code>commonmodelsInterview</code>. Создадим вид, в котором будут отображаться все записи из таблицы "Опросов". Чтобы облегчить выполнение этой задачи, обратимся к Gii. Выберите генератор "CRUD Generator", который генерирует виды и контроллер на основании модели. Введите в Model Class <code>commonmodelsInterview</code>, а в Controller Class - <code>backendcontrollersInterviewController</code>. Всё, жмите Preview. "CRUD Generator" генерируется вид для создания, изменения, удаления и просмотра модели, также помогает генерировать страницу <code>index.php</code>, которая показывает список моделей постранично, используя виджет <a href="http://www.yiiframework.com/doc-2.0/yii-grid-gridview.html" target="_blank">GridView</a> или <a href="http://www.yiiframework.com/doc-2.0/yii-widgets-listview.html" target="_blank">ListView</a>Нажимаем "Generate" и наслаждаемся результатами работы.</p>
<h4>Виджет GridView</h4><br />
Очень часто необходимо вывести данные в виде таблицы. Для решения этой задачи в Yii имеется сверхмощный виджет <a href="http://www.yiiframework.com/doc-2.0/yii-grid-gridview.html" target="_blank">yiigridGridView</a>. Разрабатывая административный раздел сайта, практически всегда этот виджет будет полезен. Вот и сейчас в виде <code>yii2-app-advanced/backend/views/interview/index.php</code> он используется для того, чтобы отобразить все ответы на опрос.</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= GridView::widget([<br />
    <span class="hljs-string">'dataProvider'</span> => <span class="hljs-variable">$dataProvider</span>,<br />
    <span class="hljs-string">'columns'</span> => [<br />
        <span class="hljs-comment">//...</span><br />
    ],<br />
]); <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Для работы этого виджета нужен объект <code>$dataProvider</code>, который реализует интерфейс <a href="http://www.yiiframework.com/doc-2.0/yii-data-dataproviderinterface.html" target="_blank">yiidataDataProviderInterface</a>Интерфейс можно разделить на следующие части: набор данных; объект, который отвечает за сортировку данных; объект, который отвечает за постраничную разбивку данных. Есть несколько реализаций этого интерфейса:</p>
<ul>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-data-activedataprovider.html" target="_blank">yiidataActiveDataProvider</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-data-arraydataprovider.html" target="_blank">yiidataArrayDataProvider</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-data-sqldataprovider.html" target="_blank">yiidataSqlDataProvider</a></li><br />
</ul><br />
В нашем случае для моделей используется Active Record, поэтому и для удобства работы, лучше выбрать первый класс - <code>yiidataActiveDataProvider</code>, так как это позволит представить набор данных в виде массива Active Record объектов. $dataProvider создаётся в контроллере <code>yii2-app-advanced/backend/controllers/InterviewController.php</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">new</span> ActiveDataProvider([<br />
    <span class="hljs-string">'query'</span> => Interview::find(),<br />
]);<br />
</code></pre><br />
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#find%28%29-detail" target="_blank">Interview::find()</a> - подготавливает запрос типа <code>SELECT * FROM interview</code>. Далее $dataProvider передаётся в вид, где срабатывают внутренние механизмы <code>ActiveDataProvider</code> для отображения данных, в соответствии с разбивкой на страницы и сортировкой - выполняется запрос типа</p>
<pre><code class="hljs sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-string">`interview`</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> имя_атрибута <span class="hljs-keyword">LIMIT</span> количество_записей_на_страницу OFFSET (номер_страницы - <span class="hljs-number">1</span>) * количество_записей_на_страницу<br />
</span></code></pre><br />
Разбивка записей страницу и сортировка могут быть настроены следующим образом:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$dataProvider</span> = <span class="hljs-keyword">new</span> ActiveDataProvider([<br />
    <span class="hljs-string">'query'</span> => Interview::find(),<br />
    <span class="hljs-string">'pagination'</span> => [<br />
        <span class="hljs-string">'pageSize'</span> => <span class="hljs-number">50</span>,<br />
    ],<br />
    <span class="hljs-string">'sort'</span> => [<br />
        <span class="hljs-string">'defaultOrder'</span> => [<br />
            <span class="hljs-string">'name'</span> => SORT_ASC,<br />
        ]<br />
    ]<br />
]);<br />
</code></pre><br />
Когда данные получены из базы данных, то с учётом настроек свойства <code>columns</code> виджета GridView эти данные приобретают окончательный вид и выводятся на экран. Формат вывода данных может быть изменён путём изменения свойства <a href="http://www.yiiframework.com/doc-2.0/yii-grid-gridview.html#$columns-detail" target="_blank">columns</a>:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
    <span class="hljs-variable">$planets</span> = [<span class="hljs-string">'Меркурий'</span>, <span class="hljs-string">'Венера'</span>, <span class="hljs-string">'Земля'</span>, <span class="hljs-string">'Марс'</span>, <span class="hljs-string">'Юпитер'</span>, <span class="hljs-string">'Сатурн'</span>, <span class="hljs-string">'Уран'</span>, <span class="hljs-string">'Нептун'</span>];</p>
<p>    <span class="hljs-variable">$astronauts</span> = [<br />
        <span class="hljs-string">'Юрий Гагарин'</span>,<br />
        <span class="hljs-string">'Алексей Леонов'</span>,<br />
        <span class="hljs-string">'Нил Армстронг'</span>,<br />
        <span class="hljs-string">'Валентина Терешкова'</span>,<br />
        <span class="hljs-string">'Эдвин Олдрин'</span>,<br />
        <span class="hljs-string">'Анатолий Соловьев'</span><br />
    ];</p>
<p>    <span class="hljs-keyword">echo</span> GridView::widget(<br />
        [<br />
            <span class="hljs-string">'dataProvider'</span> => <span class="hljs-variable">$dataProvider</span>,<br />
            <span class="hljs-string">'columns'</span> => [<br />
                [<span class="hljs-string">'class'</span> => <span class="hljs-string">'yiigridSerialColumn'</span>],<br />
                <span class="hljs-string">'name'</span>,<br />
                [<br />
                    <span class="hljs-string">'attribute'</span> => <span class="hljs-string">'sex'</span>,<br />
                    <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$model</span>)</span> </span>{<br />
                        <span class="hljs-keyword">return</span> <span class="hljs-variable">$model</span>->sex ? <span class="hljs-string">'Мужчина'</span> : <span class="hljs-string">'Женщина'</span>;<br />
                    }<br />
                ],<br />
                [<br />
                    <span class="hljs-string">'attribute'</span> => <span class="hljs-string">'planets'</span>,<br />
                    <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$model</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$planets</span>)</span> </span>{<br />
                        <span class="hljs-variable">$result</span> = <span class="hljs-keyword">null</span>;<br />
                        <span class="hljs-variable">$numbers</span> = explode(<span class="hljs-string">','</span>, <span class="hljs-variable">$model</span>->planets);<br />
                        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$numbers</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$number</span>) {<br />
                            <span class="hljs-variable">$result</span> .= <span class="hljs-variable">$planets</span>[<span class="hljs-variable">$number</span>] . <span class="hljs-string">' '</span>;<br />
                        }<br />
                        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br />
                    }<br />
                ],<br />
                [<br />
                    <span class="hljs-string">'attribute'</span> => <span class="hljs-string">'astronauts'</span>,<br />
                    <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$model</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$astronauts</span>)</span> </span>{<br />
                        <span class="hljs-variable">$result</span> = <span class="hljs-keyword">null</span>;<br />
                        <span class="hljs-variable">$numbers</span> = explode(<span class="hljs-string">','</span>, <span class="hljs-variable">$model</span>->astronauts);<br />
                        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$numbers</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$number</span>) {<br />
                            <span class="hljs-variable">$result</span> .= <span class="hljs-variable">$astronauts</span>[<span class="hljs-variable">$number</span>] . <span class="hljs-string">' '</span>;<br />
                        }<br />
                        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br />
                    }<br />
                ],<br />
                [<br />
                    <span class="hljs-string">'attribute'</span> => <span class="hljs-string">'planet'</span>,<br />
                    <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$model</span>)</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$planets</span>)</span> </span>{<br />
                        <span class="hljs-keyword">return</span> <span class="hljs-variable">$planets</span>[<span class="hljs-variable">$model</span>->planet];<br />
                    }<br />
                ],<br />
                [<br />
                    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiigridActionColumn'</span>,<br />
                    <span class="hljs-string">'template'</span> => <span class="hljs-string">'{delete}'</span>,<br />
                ],<br />
            ],<br />
        ]<br />
    ); <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Сейчас <code>InterviewController</code> не использует фильтры для ограничения доступов к своим действиям. Попробуйте самостоятельно добавить условия, чтобы действия <code>actionIndex</code> и <code>actionDelete</code> могли выполнять только аутентифицированные пользователи. Остальные действия (создание, изменение, просмотр опроса) <code>InterviewController</code> можно удалить за ненадобностью.</p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/structure-widgets.md" target="_blank">Виджеты</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/output-pagination.md" target="_blank">Постраничное разделение данных</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/output-sorting.md" target="_blank">Сортировка</a>.</li><br />
</ul><br />
</div><br />
7 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Знакомство с тестированием</h3><br />
Неотъемлемой частью разработки масштабного приложения служит тестирование тех или иных частей этого приложения. Есть даже методика разработки приложений, которая тесно связана с тестированием - разработка через тестирование. Возможно, вы знакомы с ней как <a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank">TDD</a>.<br />
Разработчики и сообщество Yii приложило много усилий, чтобы можно было максимально просто покрыть тестами необходимый код.<br />
Раньше, например когда создавали форму опрос, приходилось открывать браузер, заполнять форму выдуманными данными, проверять результат. Добавляли успешный вывод сообщения, в виде результата - опять открывали форму, заполняли данными, проверяли результат. Добавили, поведение к форме - опять проверяли, открывая форму и вводя данные. Сохраняли результат в базе данных - приходилось смотреть сохранились ли данные корректно. Всё это наверное вам знакомо. Возможно, вам приходится такое проделывать, когда разрабатывается тот или иной функционал. А когда приложение становится масштабным, уже боязно вносить изменения в код. Так как далее приходится тратить много времени, чтобы пройтись по некоторым страницам сайта и проверить вручную всё ли работает как требуется. И часто, спустя несколько дней, кто-нибудь сообщает, что то что, когда-то работало, перестало работать. И опять тратиться время на выяснение причины неисправности, а так как изменения вносились несколько дней назад, то поиск истиной причины становится мукой. Или причина неисправности определяется неверно и в результате добавляется "костыль", который исправляет проблему.<br />
Может вы к этому привыкли и вас всё устраивает. Но что, если про это всё забыть и использовать всего лишь одну команду:</p>
<pre><code class="hljs nginx"><span class="hljs-title">codecept</span> run<br />
</code></pre><br />
Всё! Больше ничего. Запустив команду, после очередного изменения кода и не увидев ни одной ошибки в результатах, вы можете со спокойной душой сообщить всем, что всё работает, как того требует техническое задание.<br />
В этой главе посмотрим, что скрывается под командой <code>codecept run</code>. Чтобы начать, выполните команду из директории yii2-tutorial:</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">1.0</span><br />
</code></pre></p>
<div class="alert alert-info">Под Windows вместо стандартной командной строки cmd лучше использовать другой интерпретатор. Тот который использует подсветку кода, например <a href="http://gooseberrycreative.com/cmder/" target="_blank">Cmder</a>Если у вас возникли проблемы с кодировкой в командной строке, то попробуйте выполнить в ней команду "chcp 65001".</div></p>
<h4>Codeception</h4><br />
Yii для тестирование кода предоставляет систему <a href="http://codeception.com/" target="_blank">Codeception</a>. Codeception основан на php фреймворке для тестирования <a href="https://phpunit.de/" target="_blank">PHPUnit</a>. Вся настройка Codeception сводится к следующим шагам:</p>
<ul>
<li>создайте директорию <code>codecept</code>, где посчитаете нужным (не внутри учебника)</li>
<li>создайте в этой директории <code>composer.json</code>:
<pre><code class="hljs json">{<br />
  "<span class="hljs-attribute">require</span>": <span class="hljs-value">{<br />
      "<span class="hljs-attribute">codeception/codeception</span>": <span class="hljs-value"><span class="hljs-string">"*"</span></span>,<br />
      "<span class="hljs-attribute">codeception/verify</span>": <span class="hljs-value"><span class="hljs-string">"*"</span></span>,<br />
      "<span class="hljs-attribute">codeception/specify</span>": <span class="hljs-value"><span class="hljs-string">"*"</span><br />
  </span>}<br />
</span>}<br />
</code></pre><br />
</li></p>
<li>запустите команду <code>composer install</code> из этой директории</li>
<li>после установки всех зависимостей, настройте переменную <a href="https://ru.wikipedia.org/wiki/PATH_%28%D0%BF%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F%29" target="_blank">PATH</a> на директории <code>codeceptvendorbin</code>, чтобы команда codecept была доступна из любого места.</li><br />
</ul><br />
Теперь можно выполнить команду <code>codecept -V</code>, чтобы увидеть версию Codeception и убедиться, что он успешно установлен.</p>
<h4>Виды тестов</h4><br />
Codeception поддерживает следующие виды тестов:</p>
<ul>
<li>Модульные тесты (Unit), которые проверяют код, который выполняется в изоляции.</li>
<li>Функциональные тесты (Functional), которые проверяют код, через эмуляцию браузера.</li>
<li>Приёмочные тесты (Acceptance), которые проверяют код, через браузер.</li><br />
</ul><br />
Все тесты располагаются в <code>yii2-tutorialyii2-app-advancedtestscodeception</code>. Как и структура Advanced шаблона Yii, тесты также разделены для гибкости на backend и frontend. Только настройки вынесены в отдельную директорию <code>config</code>.<br />
Кстати для некоторых тестов необходимо соединение с базой данных. Придётся извлекать, записывать данные, а иногда и удалять. Понятное дело, что основную базу лучше в этом случае не использовать. Нужна тестовая. Используя миграции, не составит труда создать копию основной базы данных.<br />
Поэтому в <code>yii2-app-advanced/tests/codeception/config/config.php</code> указана:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'db'</span> => [<br />
    <span class="hljs-string">'dsn'</span> => <span class="hljs-string">'sqlite:'</span> . dirname(<span class="hljs-keyword">__FILE__</span>) .<span class="hljs-string">'/../../sqlite-test.db'</span>,<br />
],<br />
</code></pre><br />
К этой базе данных применены все миграции, которые использовались и для основной. Чтобы это выполнить, понадобилось вызвать <code>php yii migrate</code> из <code>yii2-app-advanced/tests/codeception/bin</code>.<br />
Теперь вернёмся к структуре директорий. Открыв <code>yii2-app-advanced/tests/codeception/backend</code>, можно обнаружить</p>
<pre><code class="hljs json">[_output]<br />
[acceptance]<br />
[functional]<br />
[unit]<br />
</code></pre><br />
<code>acceptance, functional, unit</code> директории, которые хранят тесты в зависимости от их видов. <code>_output</code> - это директория, в которую будет попадать результат эмуляции браузера (html код страницы) для функциональных тестов, в случае ошибки.<br />
В Codeception есть понятие "Исполнители тестов". Из названия понятно, для чего они. Для того, чтобы их создать необходимо произвести их инициализацию. В директории <code>tests/codeception/frontend</code> необходимо выполнить <code>codecept build</code>. Создадутся файлы:</p>
<pre><code class="hljs">yii2-app-advanced/tests/codeception/frontend/acceptance/AcceptanceTester.php<br />
yii2-app-advanced/tests/codeception/frontend/functional/FunctionalTester.php<br />
yii2-app-advanced/tests/codeception/frontend/unit/UnitTester.php<br />
</code></pre><br />
которые и будут являться исполнителями. В последствии, тоже самое нужно проделать и для backend части.</p>
<h4>Запуск тестов</h4><br />
Можно попробовать для frontend запустить тесты. В <code>yii2-tutorialyii2-app-advancedtestscodeceptionfrontend</code>запустим на выполнение все функциональные тесты:</p>
<pre><code class="language-php hljs">codecept run functional</p>
<p>Time: <span class="hljs-number">3</span> seconds, Memory: <span class="hljs-number">29.25</span>Mb<br />
OK (<span class="hljs-number">6</span> tests, <span class="hljs-number">49</span> assertions)<br />
</code></pre><br />
Выполнив эту команду, вы наверное ничего и не почувствовали. Но обратите внимание на время выполнения - <strong>3 секунды</strong>. За эти три секунды <code>FunctionalTester</code> успел посетить страницу о нас, обратная связь, домашнюю страницу и проверить что они работают без ошибок. В эти 3 секунды исполнитель побывал на странице регистрации, аутентификации, и на странице опроса, проверил эти формы, на корректность ввода данных. Исполнитель проверил работоспособность поведения accessOnce, которое было создано ранее. В сумме за три секунды исполнитель выполнил 6 тестов, в которых присутствовало 49 проверок.<br />
Представьте сколько бы времени у вас ушло, если бы это выполняли самостоятельно через браузер. И запустив</p>
<pre><code class="language-php hljs">codecept run functional<br />
</code></pre><br />
после очередного рефакторинга кода, можно с уверенностью сказать, корректно ли работает сайт. А не бродить по сайту в поисках "А не поломал ли я чего-нибудь?". В этом и есть одна из приятных особенностей тестирования.<br />
Также можно попробовать запустить модульные тесты:</p>
<pre><code class="language-php hljs">codecept run unit</p>
<p>Time: <span class="hljs-number">8.29</span> seconds, Memory: <span class="hljs-number">17.00</span>Mb<br />
OK (<span class="hljs-number">9</span> tests, <span class="hljs-number">25</span> assertions)<br />
</code></pre><br />
А вот для приёмочных, вы обнаружите ошибки.</p>
<pre><code class="language-php hljs">codecept run acceptance</p>
<p>FAILURES!<br />
Tests: <span class="hljs-number">5</span>, Assertions: <span class="hljs-number">0</span>, Errors: <span class="hljs-number">5.</span><br />
</code></pre><br />
Всё дело в том, что для работы приёмочных тестов нужен браузер. Окружение для Codeception в Yii настроено таким образом, что используется <a href="http://codeception.com/docs/modules/PhpBrowser" target="_blank">PhpBrowser</a>.</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// Файл yii2-app-advanced/tests/codeception/frontend/acceptance.suite.yml</span><br />
modules:<br />
    enabled:<br />
        - PhpBrowser<br />
        - testscodeceptioncommon_supportFixtureHelper<br />
    config:<br />
        PhpBrowser:<br />
            url: http:<span class="hljs-comment">//localhost:8080</span><br />
</code></pre><br />
Т.е. настраивать ничего не нужно, остаётся изменить только путь к нашему сайту с http://localhost:8080 на http://localhost:8888/yii2-app-advanced/. Сделайте это.<br />
Вместо PhpBrowser может быть выбран любой другой браузер (Chrome, FF, IE или другой) под управлением специального веб-драйвера, например <a href="http://www.seleniumhq.org/" target="_blank">Selenium</a>. Смена PhpBrowser браузера позволит тестировать поведения в браузере, связанные с javascripts.<br />
А сейчас, когда PhpBrowser настроен, можно пробовать запускать и приёмочные тесты.<br />
Запуск отдельных тестов, сокращает время ожидания выполнения. Codeception поддерживает: запуск всех тестов, запуск тестов по видам и запуск отдельных тестов. Например, для <code>yii2-app-advanced/tests/codeception/frontend</code> можно выполнить:</p>
<pre><code class="hljs nginx"><span class="hljs-title">codecept</span> run<br />
codecept run functional<br />
codecept run functional functionalInterviewCept.php<br />
</code></pre></p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul>
<li><a href="https://ru.wikipedia.org/wiki/%D0%AD%D0%BA%D1%81%D1%82%D1%80%D0%B5%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" target="_blank">Экстремальное программирование</a>.</li>
<li><a href="http://codeception.com/docs/01-Introduction" target="_blank">Руководство по Codeception</a>.</li>
<li><a href="https://phpunit.de/manual/current/en/index.html" target="_blank">Руководство по PHPUnit</a>.</li><br />
</ul><br />
</div><br />
8 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Работа с реляционными данными</h3><br />
Вы уже познакомились с тем как с помощью Active Record можно получить запись из базы данных. В этом разделе научимся получать связанные данные и работать с ними.<br />
Чтобы начать, выполните команду из директории yii2-tutorial:</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">1.1</span><br />
</code></pre><br />
Сперва определимся, что мы хотим получить. Возьмём нашу солнечную систему. В солнечной системе есть звезда Солнце, вокруг звезды вращаются планеты - Меркурий, Венера, Земля, Марс, Церера, Юпитер, Сатурн, Уран, Нептун, Плутон, Хаумеа, Макемаке, Эрида; а вокруг планет их спутники. Для хранение этих данных нам понадобятся три таблицы: звезды, планеты, спутники.<br />
Star</p>
<pre><code class="hljs objectivec">| <span class="hljs-keyword">id</span> | name |<br />
|----|------|<br />
|    |      |<br />
</code></pre><br />
Planet</p>
<pre><code class="hljs objectivec">| <span class="hljs-keyword">id</span> | name | star_id |<br />
|----|------|---------|<br />
|    |      |         |<br />
</code></pre><br />
Satellite</p>
<pre><code class="hljs objectivec">| <span class="hljs-keyword">id</span> | name | planet_id |<br />
|----|------|-----------|<br />
|    |      |           |<br />
</code></pre></p>
<div class="alert alert-info">Хорошим тоном служит именовать таблицы в единственном числе на английском языке, например Planet, но не Planets. Внешние ключи принято называть в сочетании имени и поля таблицы, например "planet_id", а первичные ключи - "id". <a href="https://toster.ru/q/139295" target="_blank">Подробнее...</a></div><br />
Создадим эти таблицы, через миграцию. Выполните в <code>yii2-tutorialyii2-app-advanced</code>:</p>
<pre><code class="hljs coffeescript">php yii migrate/create create_asto_tables</p>
<p>    Yii Migration Tool (based <span class="hljs-literal">on</span> Yii v2.0.3)<br />
    Create <span class="hljs-keyword">new</span> migration <span class="hljs-string">'/yii2-tutorial/yii2-app-advanced/console/migrations/m150513_054155_create_asto_tables.php'</span>? (<span class="hljs-literal">yes</span>|<span class="hljs-literal">no</span>) [<span class="hljs-literal">no</span>]:<span class="hljs-literal">yes</span><br />
    New migration created successfully.<br />
</code></pre><br />
Приведём код миграции к следующему виду:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span></p>
<p><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">db</span><span class="hljs-title">Schema</span>;<br />
<span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">db</span><span class="hljs-title">Migration</span>;</p>
<p><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">m150513_054155_create_asto_tables</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Migration</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-variable">$tableOptions</span> = <span class="hljs-keyword">null</span>;</p>
<p>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>->db->driverName === <span class="hljs-string">'mysql'</span>) {<br />
            <span class="hljs-variable">$tableOptions</span> = <span class="hljs-string">'CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE=InnoDB'</span>;<br />
        }</p>
<p>        <span class="hljs-variable">$this</span>->createTable(<br />
            <span class="hljs-string">'{{%star}}'</span>,<br />
            [<br />
                <span class="hljs-string">'id'</span> => Schema::TYPE_PK,<br />
                <span class="hljs-string">'name'</span> => Schema::TYPE_STRING . <span class="hljs-string">' NOT NULL'</span>,<br />
            ],<br />
            <span class="hljs-variable">$tableOptions</span><br />
        );</p>
<p>        <span class="hljs-variable">$this</span>->createTable(<br />
            <span class="hljs-string">'{{%planet}}'</span>,<br />
            [<br />
                <span class="hljs-string">'id'</span> => Schema::TYPE_PK,<br />
                <span class="hljs-string">'name'</span> => Schema::TYPE_STRING . <span class="hljs-string">' NOT NULL'</span>,<br />
                <span class="hljs-string">'star_id'</span> => Schema::TYPE_INTEGER . <span class="hljs-string">' NOT NULL'</span>,<br />
                <span class="hljs-string">'FOREIGN KEY(star_id) REFERENCES '</span><br />
                . <span class="hljs-variable">$this</span>->db->quoteTableName(<span class="hljs-string">'{{%star}}'</span>) . <span class="hljs-string">'(id) ON UPDATE CASCADE ON DELETE CASCADE'</span><br />
            ],<br />
            <span class="hljs-variable">$tableOptions</span><br />
        );</p>
<p>        <span class="hljs-variable">$this</span>->createTable(<br />
            <span class="hljs-string">'{{%satellite}}'</span>,<br />
            [<br />
                <span class="hljs-string">'id'</span> => Schema::TYPE_PK,<br />
                <span class="hljs-string">'name'</span> => Schema::TYPE_STRING . <span class="hljs-string">' NOT NULL'</span>,<br />
                <span class="hljs-string">'planet_id'</span> => Schema::TYPE_INTEGER . <span class="hljs-string">' NOT NULL'</span>,<br />
                <span class="hljs-string">'FOREIGN KEY(planet_id) REFERENCES '</span><br />
                . <span class="hljs-variable">$this</span>->db->quoteTableName(<span class="hljs-string">'{{%planet}}'</span>) . <span class="hljs-string">'(id) ON UPDATE CASCADE ON DELETE CASCADE'</span><br />
            ],<br />
            <span class="hljs-variable">$tableOptions</span><br />
        );<br />
    }</p>
<p>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-variable">$this</span>->dropTable(<span class="hljs-string">'{{%satellite}}'</span>);<br />
        <span class="hljs-variable">$this</span>->dropTable(<span class="hljs-string">'{{%planet}}'</span>);<br />
        <span class="hljs-variable">$this</span>->dropTable(<span class="hljs-string">'{{%star}}'</span>);<br />
    }<br />
}</p>
<p></code></pre><br />
Обратите внимание, что имена таблиц имеют вид <code>"{{%name}}"</code>. Это необходимо, если вы захотите использовать префикс в именах таблиц, который можно установить через конфигурацию компонента <code>db</code>:</p>
<pre><code class="language-php hljs"> <span class="hljs-string">'db'</span> => [<br />
    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiidbConnection'</span>,<br />
    <span class="hljs-string">'dsn'</span> => <span class="hljs-string">'sqlite:'</span> . <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../sqlite.db'</span>,<br />
    <span class="hljs-string">'tablePrefix'</span> => <span class="hljs-string">'astro'</span>,<br />
],<br />
</code></pre><br />
Так как наша миграция, может в будущем использоваться не только на SQLite, но и на Mysql, то для Mysql с помощью <code>$tableOptions</code> устанавливаем кодировку и <code>ENGINE=InnoDB</code>, для работы с внешними ключами <code>FOREIGN KEY</code>. В SQLite по умолчанию <a href="https://www.sqlite.org/foreignkeys.html#fk_enable" target="_blank">проверка внешних ключей отключена</a>. Для того, чтобы её включить необходимо выполнить команду:</p>
<pre><code class="hljs sql"><span class="hljs-operator"><span class="hljs-keyword">PRAGMA</span> foreign_keys = <span class="hljs-keyword">ON</span>;</span><br />
</code></pre><br />
Выполнять её требуется всякий раз, когда устанавливается соединение с базой данных. У класса, который в нашем случае отвечает за соединение, <a href="http://www.yiiframework.com/doc-2.0/yii-db-connection.html" target="_blank">yiidbConnection</a>есть события:</p>
<ul>
<li><code>EVENT_AFTER_OPEN</code> - срабатывает каждый раз, после установки соединения с БД.</li>
<li><code>EVENT_BEGIN_TRANSACTION</code> - срабатывает каждый раз, перед началом транзакции.</li>
<li><code>EVENT_COMMIT_TRANSACTION</code> - срабатывает каждый раз, после применении транзакции.</li>
<li><code>EVENT_ROLLBACK_TRANSACTION</code> - срабатывает каждый раз, после отмены транзакции.</li><br />
</ul><br />
Присоединим на событие <code>EVENT_AFTER_OPEN</code> функцию-обработчик, которая будет включать проверку внешних ключей в SQLite. Это можно сделать, через глобальную конфигурацию компонента. Добавьте к настройкам базы данных <code>on afterOpen</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'db'</span> => [<br />
    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiidbConnection'</span>,<br />
    <span class="hljs-string">'dsn'</span> => <span class="hljs-string">'sqlite:'</span> . <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../sqlite.db'</span>,<br />
    <span class="hljs-string">'on afterOpen'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(<span class="hljs-variable">$event</span>)</span> </span>{<br />
        <span class="hljs-variable">$event</span>->sender->createCommand(<span class="hljs-string">'PRAGMA foreign_keys = ON;'</span>)->execute();<br />
    }<br />
],<br />
</code></pre></p>
<div class="alert alert-info">Освежите знания <a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/concept-events.md" target="_blank">о событиях в Yii 2</a></div><br />
Заметьте, что таким способом (<code>'on имя_события'=>обработчик</code>) можно присоединять обработчики к любым событиям компонентов или приложений. Так же можно можно поступить и с поведениями. Например, запретить доступ "гостям" к методу <code>logout</code> в контроллере <code>site</code>, можно с помощью <code>as access</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'as access'</span> => [<br />
    <span class="hljs-string">'class'</span> => <span class="hljs-string">'yiifiltersAccessControl'</span>,<br />
    <span class="hljs-string">'rules'</span> => [<br />
        [<br />
            <span class="hljs-string">'controllers'</span>=>[<span class="hljs-string">'site'</span>],<br />
            <span class="hljs-string">'actions'</span> => [<span class="hljs-string">'logout'</span>],<br />
            <span class="hljs-string">'allow'</span> => <span class="hljs-keyword">true</span>,<br />
            <span class="hljs-string">'roles'</span> => [<span class="hljs-string">'@'</span>],<br />
        ],<br />
    ]<br />
]<br />
</code></pre><br />
И так, когда все настройки применены, миграция создана, можно запустить на выполнение:</p>
<pre><code class="hljs perl">php yii migrate</p>
<p>    Yii Migration Tool (based on Yii v2.<span class="hljs-number">0</span>.<span class="hljs-number">3</span>)</p>
<p>    Total <span class="hljs-number">1</span> new migration to be applied:<br />
            m150513_054155_create_asto_tables</p>
<p>    Apply the above migration? (yes|<span class="hljs-keyword">no</span>) [<span class="hljs-keyword">no</span>]:yes<br />
    *** applying m150513_054155_create_asto_tables<br />
        > create table {{<span class="hljs-variable">%star</span>}} ... done (<span class="hljs-keyword">time</span>: <span class="hljs-number">0</span>.<span class="hljs-number">05</span>9s)<br />
        > create table {{<span class="hljs-variable">%planet</span>}} ... done (<span class="hljs-keyword">time</span>: <span class="hljs-number">0</span>.<span class="hljs-number">041</span><span class="hljs-keyword">s</span>)<br />
        > create table {{<span class="hljs-variable">%satellite</span>}} ... done (<span class="hljs-keyword">time</span>: <span class="hljs-number">0</span>.<span class="hljs-number">046</span><span class="hljs-keyword">s</span>)<br />
    *** applied m150513_054155_create_asto_tables (<span class="hljs-keyword">time</span>: <span class="hljs-number">0</span>.<span class="hljs-number">204</span><span class="hljs-keyword">s</span>)    </p>
<p>    Migrated up successfully.<br />
</code></pre><br />
<strong>Таблицы готовы</strong>.</p>
<p>Создадим модели, через Gii.</p>
<p>Используя это изображение, остальные модели -<code>Planet</code> и <code>Satellite</code>, создайте самостоятельно. После в директории <code>yii2-app-advanced/common/models</code> появятся три файла <code>Planet.php</code>, <code>Star.php</code>, <code>Satellite.php</code>, которые описывают модели.</p>
<h4>Описание реляционных данных.</h4><br />
Открыв <code>Star.php</code>, вы обнаружите новый метод, с которым до сих пор мы не встречались:</p>
<pre><code class="language-php hljs"> <span class="hljs-comment">/**<br />
 *<span class="hljs-phpdoc"> @return</span> yiidbActiveQuery<br />
 */</span><br />
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPlanets</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->hasMany(Planet::className(), [<span class="hljs-string">'star_id'</span> => <span class="hljs-string">'id'</span>]);<br />
}<br />
</code></pre><br />
Из названия <code>getPlanets</code> можно понять, что данный метод должен возвращать модел<strong>и</strong> планет. Ну и в реализации, используется <code>$this->hasMany(Planet...</code>, который обозначает, что звезда имеет много планет. Можно догадаться, что в моделях <code>Planet.php</code> и <code>Satellite.php</code> также должны быть похожие методы, которые описывают связи между моделями. Точно:</p>
<pre><code class="language-php hljs"><span class="hljs-comment">// в Planet.php</span></p>
<p><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStar</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->hasOne(Star::className(), [<span class="hljs-string">'id'</span> => <span class="hljs-string">'star_id'</span>]);<br />
}</p>
<p><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSatellites</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->hasMany(Satellite::className(), [<span class="hljs-string">'planet_id'</span> => <span class="hljs-string">'id'</span>]);<br />
}<br />
</code></pre></p>
<pre><code class="language-php hljs"><span class="hljs-comment">// в Satellite.php</span></p>
<p><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPlanet</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->hasOne(Planet::className(), [<span class="hljs-string">'id'</span> => <span class="hljs-string">'planet_id'</span>]);<br />
}<br />
</code></pre><br />
Метод <code>hasOne</code> из <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" target="_blank">ActiveRecord</a>в отличие <code>hasMany</code> обозначает отношение моделей, как связь один к одному. Например спутник Луна принадлежит только одной планете Земля.</p>
<h4>Доступ к реляционным данным.</h4><br />
Из описания методов, которые описаны выше, можно увидеть, что возвращается объект <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" target="_blank">yiidbActiveQuery</a>.</p>
<pre><code class="language-php hljs"><span class="hljs-comment">/**<br />
*<span class="hljs-phpdoc"> @return</span> yiidbActiveQuery<br />
*/</span><br />
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPlanet</span><span class="hljs-params">()</span> </span>{..}<br />
</code></pre><br />
Для того, что получить все спутники для планеты Марс, нужно обратиться к коду:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$marsModel</span> = Planet::find()->where([<span class="hljs-string">'name'</span>=><span class="hljs-string">'Марс'</span>])->one();<br />
<span class="hljs-variable">$marsModel</span>->getSatellites()->all();<br />
</code></pre><br />
Например, у Юпитера 67 спутников, а нужно получить только 10 первых, которые отсортированы по имени:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$marsModel</span> = Planet::find()->where([<span class="hljs-string">'name'</span>=><span class="hljs-string">'Юпитер'</span>])->one();<br />
<span class="hljs-variable">$marsModel</span>->getSatellites()->limit(<span class="hljs-number">10</span>)->orderBy([<span class="hljs-string">'name'</span>=>SORT_ASC])->limit(<span class="hljs-number">10</span>)->all();<br />
</code></pre><br />
Результатом будет массив Active Record моделей. Иногда, для экономии памяти, результат стоит возвращать в виде массива значений с помощью <code>->asArray()->all()</code>.<br />
Эти примеры выполняли в два этапа: находилась модель, находились отношения, если в этом была необходимость. Можно сделать тоже самое в один запрос:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$marsModel</span> = Planet::find()->with(<span class="hljs-string">'satellites'</span>)->where([<span class="hljs-string">'name'</span>=><span class="hljs-string">'Юпитер'</span>])->one();<br />
</code></pre><br />
Уже упоминалось, что почти каждый класс в Yii наследует <code>yiibaseObject</code>. Это означает, что к любому методу, который начинающийся как get(геттер) или set(сеттер), может быть использован как свойство объекта. Т.е. <code>getPlanet()</code> в модели <code>Satellite</code> может быть получено как <code>$satelliteModel->planet</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$marsModel</span> = Planet::find()->where([<span class="hljs-string">'name'</span>=><span class="hljs-string">'Марс'</span>])->one();<br />
<span class="hljs-variable">$marsModel</span>->getSatellites()->all();<br />
</code></pre><br />
эквивалентно</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$marsModel</span> = Planet::find()->where([<span class="hljs-string">'name'</span>=><span class="hljs-string">'Марс'</span>])->one();<br />
<span class="hljs-variable">$marsModel</span>->satellites; <span class="hljs-comment">//вернёт массив Active Record моделей Satellites</span><br />
</code></pre></p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul>
<li>Официальное руководство по работе с связями в AR.</li><br />
</ul><br />
</div><br />
9 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Вывод реляционных данных в видах.</h3><br />
Сгенерируйте через CRUD Gii. виды и контроллер для моделей <code>Star</code>, <code>Planet</code> и <code>Satellite</code>. В качестве подсказки воспользуйтесь следующим изображением:</p>
<p>Обратите внимание, что модели <code>Star</code>, <code>Planet</code> и <code>Satellite</code> мы располагаем в пространстве имён <code>commonmodels</code>, которое подразумевает доступность моделей из frontend и backend. А вспомогательные модели для фильтрации и сортировки <code>Search Model Class</code> в пространстве в <code>backendmodels</code>, т.к. определённая фильтрация и сортировка понадобится только в backend приложении.<br />
Чтобы убедиться в правильности выполненных действий выполните тесты.<br />
Из <code>yii2-tutorialyii2-app-advancedtestscodeceptionbin</code> установите миграцию для тестовой базы</p>
<pre><code class="hljs nginx"><span class="hljs-title">php</span> yii migrate<br />
</code></pre><br />
Из <code>yii2-tutorialyii2-app-advancedtestscodeceptionbackend</code> выполните две команды для запуска тестов:</p>
<ul>
<li>создайте исполнителей для тестов</li><br />
</ul></p>
<pre><code class="hljs nginx"><span class="hljs-title">codecept</span> build<br />
</code></pre></p>
<ul>
<li>запустите функциональный тест AstroCept</li><br />
</ul></p>
<pre><code class="hljs bash">codecept run functional functionalAstroCept.php</p>
<p>Time: <span class="hljs-number">519</span> ms, Memory: <span class="hljs-number">21.00</span>Mb<br />
OK (<span class="hljs-number">1</span> <span class="hljs-built_in">test</span>, <span class="hljs-number">3</span> assertions)<br />
</code></pre><br />
После того, как Gii сгенерировал контроллеры и виды, станут доступны следующие url:</p>
<ul>
<li>управление Star.</li>
<li>управление Planet.</li>
<li>управление Satellite.</li><br />
</ul><br />
Эти страницы служат интерфейсом, отправной точкой для работы с моделями. С этих страниц можно попасть на формы для создания или изменения информации по звёздам, планетам и их спутникам. На данный момент база данных не содержит какой-либо информации по звёздам, планетам и их спутникам. Перейдите на следующий шаг, в котором в базу данных добавлена эта информация:</p>
<pre><code class="hljs bash">git checkout <span class="hljs-operator">-f</span> step-<span class="hljs-number">1.2</span><br />
</code></pre><br />
Обновив страницу управления планетами, можно увидеть информацию:</p>
<p>Давайте приведём её к более красивому виду. Для настройки вида откройте файл <code>yii2-app-advanced/backend/views/planet/index.php</code>Вначале измените <code>title</code> компонента <code>View</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$this</span>->title = <span class="hljs-string">'Планеты'</span>;<br />
</code></pre><br />
Измените название ссылки</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= Html::a(<span class="hljs-string">'Добавить планету'</span>, [<span class="hljs-string">'create'</span>], [<span class="hljs-string">'class'</span> => <span class="hljs-string">'btn btn-success'</span>]) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Ну и наконец измените структуру колонок в таблице на:</p>
<pre><code class="language-php hljs"><span class="hljs-string">'columns'</span> => [<br />
    <span class="hljs-string">'id'</span>,<br />
    [<br />
        <span class="hljs-string">'attribute'</span>=><span class="hljs-string">'name'</span>,<br />
        <span class="hljs-string">'label'</span>=><span class="hljs-string">'Планета'</span>,<br />
    ],<br />
    [<br />
        <span class="hljs-string">'label'</span>=><span class="hljs-string">'Звезда'</span>,<br />
        <span class="hljs-string">'attribute'</span>=><span class="hljs-string">'star_id'</span>,<br />
        <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$planet</span>)</span> </span>{<br />
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$planet</span>->star->name;<br />
        }<br />
    ],<br />
    [<br />
        <span class="hljs-string">'label'</span>=><span class="hljs-string">'Количество спутников'</span>,<br />
        <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$planet</span>)</span> </span>{<br />
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$planet</span>->getSatellites()->count();<br />
        }<br />
    ],<br />
    [<span class="hljs-string">'class'</span> => <span class="hljs-string">'yiigridActionColumn'</span>],<br />
],<br />
</code></pre><br />
тут мы определили пять колонок:</p>
<ul>
<li>первая <code>id</code>, служит для отображения служебной информации по id записям планет.</li>
<li>вторая <code>name</code> в виде массива <code>attribute</code>, который указывает, что значение для колонки требуется брать из атрибута <code>name</code>, но заголовок у этой колонки по умолчанию <code>Name</code>(Наименование). Изменим на <code>'label'=>'Планета',</code></li>
<li>третья колонка содержала числовое значение <code>star_id</code>, что не совсем удобно. Так как у модели Planet настроена связь
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStar</span><span class="hljs-params">()</span><br />
</span>{<br />
  <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->hasOne(Star::className(), [<span class="hljs-string">'id'</span> => <span class="hljs-string">'star_id'</span>]);<br />
}<br />
</code></pre><br />
, то значение колонки <code>value</code> можно изменить на анонимную функцию, которая будет возвращать наименование звезды.</li></p>
<li>четвертая колонка будет отображать количество спутников у планеты. Только в анонимной функции мы обратились непосредственно к методу <code>Planet::getSatellites()</code>, так как <code>$planet->star</code> через магический метод <code>__get</code> получает массив моделей, который в данном пункте избыточен, в отличие от предыдущего.</li>
<li>ну и пятая колонка <a href="http://www.yiiframework.com/doc-2.0/yii-grid-actioncolumn.html" target="_blank">ActionColumn</a>, выводит три ссылки, для стандартных операций с моделью Planet (просмотр, редактирование, удаление).</li>
<li>была также колонка <a href="http://www.yiiframework.com/doc-2.0/yii-grid-serialcolumn.html" target="_blank">yiigridSerialColumn</a>, которая служит для вывода порядкового номера строки. Мы её удалили за ненадобностью.</li><br />
</ul><br />
Аналогично попробуйте настроить виды для оставшихся моделей <code>Star</code>(<code>/views/star/index.php</code>) и <code>Satellite</code>(<code>/views/satellite/index.php</code>).</p>
<p>Вы наверное уже обратили внимание, что только у колонки "Количество спутников" отсутствует поле для фильтрации, а также недоступна сортировка. Всё потому, что мы не указали свойство <code>attribute</code> для этой колонки. Исправим это:</p>
<pre><code class="language-php hljs">[<br />
    <span class="hljs-string">'label'</span>=><span class="hljs-string">'Количество спутников'</span>,<br />
    <span class="hljs-string">'attribute'</span>=><span class="hljs-string">'countSatellites'</span>,<br />
    <span class="hljs-string">'value'</span> => <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$planet</span>)</span> </span>{<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$planet</span>->getSatellites()->count();<br />
    }<br />
],<br />
</code></pre><br />
Но обновив страницу ничего не изменится - мало указать <code>attribute</code>, нужно указать, что это свойство является безопасным, в <code>rules()</code> модели для поиска, т.е. в <code>/backend/models/SearchPlanet.php</code>.</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchPlanet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Planet</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$countSatellites</span>;</p>
<p>    <span class="hljs-comment">/**<br />
     *<span class="hljs-phpdoc"> @inheritdoc</span><br />
     */</span><br />
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span><br />
    </span>{<br />
        <span class="hljs-keyword">return</span> [<br />
            [[<span class="hljs-string">'id'</span>, <span class="hljs-string">'star_id'</span>, <span class="hljs-string">'countSatellites'</span>], <span class="hljs-string">'integer'</span>],<br />
            [[<span class="hljs-string">'name'</span>], <span class="hljs-string">'safe'</span>],<br />
        ];<br />
    }</p>
<p></code></pre><br />
Теперь на странице появилось поле input для фильтрации, но фильтрация и сортировка по этому полю по-прежнему не работает. Осталось настроить <code>$dataProvider</code>, а именно свойство <code>$sort</code> и <code>$query</code> <a href="http://www.yiiframework.com/doc-2.0/yii-data-activedataprovider.html" target="_blank">yiidataActiveDataProvider</a>. Сортировка и фильтрация выполняется путём добавления к sql запросу <code>ORDER BY</code> или <code>WHERE</code>. Т.е. когда сработает сортировка по полю <code>countSatellites</code>, то должен выполнится запрос</p>
<pre><code class="language-sql hljs"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> Planet <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> countSatellites <span class="hljs-keyword">ASC</span>|<span class="hljs-keyword">DESC</span>;</span><br />
</code></pre><br />
Так как в таблице Planet нету поля <code>countSatellites</code>, то такой запрос не выполнится. Поэтому нужно изменить запрос, чтобы в нём участвовал <code>countSatellites</code>. На данный момент в методе <code>search()</code> модели <code>backendmodelsSearchPlanet</code> у нас:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$query</span> = Planet::find(); <span class="hljs-comment">// эквивалентно выполнению SELECT * FROM Planet</span><br />
</code></pre><br />
Нам нужно изменить его так, чтобы в запросе участвовало <code>countSatellites</code>:</p>
<pre><code class="language-sql hljs"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> planet.*, <span class="hljs-keyword">count</span>(planet_id) <span class="hljs-keyword">as</span> countSatellites<br />
<span class="hljs-keyword">FROM</span> planet<br />
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> satellite <span class="hljs-keyword">ON</span> planet_id = planet.id<br />
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> planet.id<br />
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> countSatellites <span class="hljs-keyword">ASC</span>|<span class="hljs-keyword">DESC</span>;</span><br />
</code></pre><br />
Когда есть sql запрос, то не составит труда его переделать в <code>$query</code> (ActiveQuery):</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$query</span> = Planet::find()<br />
        ->select([<span class="hljs-variable">$this</span>->tableName() . <span class="hljs-string">'.*'</span>, <span class="hljs-string">'count(planet_id) as countSatellites'</span>])<br />
        ->joinWith(<span class="hljs-string">'satellites'</span>)<br />
        ->groupBy(<span class="hljs-variable">$this</span>->tableName() . <span class="hljs-string">'.id'</span>);<br />
</code></pre><br />
Теперь сортировка работает для всех полей. Проверьте - управление Planet. Осталось настроить фильтрацию для поля <code>countSatellites</code>. Так в sql запросе <code>countSatellites</code> - это агрегатные функция <code>COUNT()</code>, то для неё параметр запроса <code>WHERE</code> не сработает, необходим <code>HAVING</code>. Для ActiveQuery это эквивалентно вызову метода <code>$query->having()</code>. Но параметр <code>HAVING</code> понадобится только, когда поле фильтра будет заполнено. С учётом всего этого метод <code>search()</code> модели <code>backendmodelsSearchPlanet</code> примет следующий вид:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-variable">$params</span>)</span><br />
</span>{<br />
    <span class="hljs-variable">$query</span> = Planet::find()<br />
        ->select([<span class="hljs-variable">$this</span>->tableName() . <span class="hljs-string">'.*'</span>, <span class="hljs-string">'count(planet_id) as countSatellites'</span>])<br />
        ->joinWith(<span class="hljs-string">'satellites'</span>)<br />
        ->groupBy(<span class="hljs-variable">$this</span>->tableName() . <span class="hljs-string">'.id'</span>);</p>
<p>    <span class="hljs-variable">$dataProvider</span> = <span class="hljs-keyword">new</span> ActiveDataProvider(<br />
        [<br />
            <span class="hljs-string">'query'</span> => <span class="hljs-variable">$query</span>,<br />
            <span class="hljs-string">'sort'</span> => [<br />
                <span class="hljs-string">'attributes'</span> => [<br />
                    <span class="hljs-string">'id'</span>,<br />
                    <span class="hljs-string">'name'</span>,<br />
                    <span class="hljs-string">'star_id'</span>,<br />
                    <span class="hljs-string">'countSatellites'</span> => [<br />
                        <span class="hljs-string">'asc'</span> => [<span class="hljs-string">'countSatellites'</span> => SORT_ASC,],<br />
                        <span class="hljs-string">'desc'</span> => [<span class="hljs-string">'countSatellites'</span> => SORT_DESC,],<br />
                    ],<br />
                ]<br />
            ]<br />
        ]<br />
    );</p>
<p>    <span class="hljs-variable">$this</span>->load(<span class="hljs-variable">$params</span>);</p>
<p>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$this</span>->validate()) {<br />
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$dataProvider</span>;<br />
    }</p>
<p>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>->countSatellites) {<br />
        <span class="hljs-variable">$query</span>->having([<span class="hljs-string">'countSatellites'</span> => (int) <span class="hljs-variable">$this</span>->countSatellites]);<br />
    }</p>
<p>    <span class="hljs-variable">$query</span>->andFilterWhere(<br />
        [<br />
            <span class="hljs-variable">$this</span>->tableName() . <span class="hljs-string">'.id'</span> => <span class="hljs-variable">$this</span>->id,<br />
            <span class="hljs-string">'star_id'</span> => <span class="hljs-variable">$this</span>->star_id,<br />
        ]<br />
    );</p>
<p>    <span class="hljs-variable">$query</span>->andFilterWhere([<span class="hljs-string">'like'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-variable">$this</span>->name]);</p>
<p>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$dataProvider</span>;<br />
}<br />
</code></pre><br />
Для закрепления знаний, настройте фильтрацию и сортировку для дополнительного свойства <code>countPlanets</code> в модели <code>StarSearch</code> на странице управления моделями Star.</p>
<p></div><br />
10 урок</p>
<div class="col-md-9 col-lg-8">
<h3>Сохранение реляционных данных.</h3></p>
<h4>Формы для сохранения данных</h4><br />
Вы наверное уже обратили внимание на формы для сохранения:</p>
<ul>
<li>звёзд</li>
<li>планет</li>
<li>спутников</li><br />
</ul><br />
Сейчас они выглядит, мягко говоря, не удобно для того, чтобы ими пользоваться.<br />
Давайте начнём с первой формы - сохранение информации по звёздам. Чтобы найти файл формы - смотрим на url <code>star/create</code>, далее открываем контроллер <code>StarController</code>, ищем в нём метод <code>actionCreate()</code>. Видим, что вызывается вид <code>create</code>. Следовательно открываем <code>yii2-app-advanced/backend/views/star/create.php</code> и обнаруживаем, что в этом файле нет нам уже знакомого класса <code>ActiveForm</code> для работы с формами. А есть:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$this</span>->render(<span class="hljs-string">'_form'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,])<br />
</code></pre><br />
Как уже известно в видах $this - это <a href="http://www.yiiframework.com/doc-2.0/yii-web-view.html" target="_blank">yiiwebView</a>. Метод <code>render</code>, вам встречался в контроллере, но там его реализация отличается тем, что до вывода вида, вызывается компонент для работы с видами, т.е. вызывается <code>yiiwebView</code> и только затем его метод для получения вида из файла. Тут же <code>$this</code>это уже компонент для работы с видами и его <code>render()</code> получает вид <code>_form</code>. Получается, что один вид <code>_form</code> находится внутри другого вида <code>create</code>. Почему это так? Это удобно, так как вид <code>_form</code> содержит форму, которая может быть использована не только для создания модели, но и также для изменения уже существующей модели. Если открыть вид <code>update.php</code> в этой же директории то, можно обнаружить тот же код, что в и <code>create.php</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$this</span>->render(<span class="hljs-string">'_form'</span>, [<span class="hljs-string">'model'</span> => <span class="hljs-variable">$model</span>,])<br />
</code></pre><br />
Т.е. одна форма используется для видов <code>create.php</code> и <code>update.php</code>.<br />
Открыв <code>yii2-app-advanced/backend/views/star/_form.php</code> вы не обнаружите ничего нового. Обычная форма - одно поле и кнопка. В браузере эта форма занимает почти всю ширину экрана. Не совсем красиво. У <a href="http://www.yiiframework.com/doc-2.0/yii-bootstrap-activeform.html" target="_blank">ActiveForm</a>, что из пространства имён <code>yiibootstrap</code> есть свойство <code>$layout</code>, которое может иметь значение <code>['default', 'horizontal', 'inline']</code>. Попробуйте установить <code>inline</code>. В <code>views/star/_form</code> :</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span> <span class="hljs-variable">$form</span> = ActiveForm::begin([<span class="hljs-string">'layout'</span>=><span class="hljs-string">'inline'</span>]); <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Не забудьте изменить <code>yiiwidgetsActiveForm;</code> на корректное пространство. Обновите страницу с формой и посмотрите на результат. Красивее, чем было, хотя о вкусах не спорят. При <code>inline</code> можно заметить, что метки (label) не используются. Но есть <a href="http://htmlbook.ru/html/input/placeholder" target="_blank">placeholder</a>. Добавим его к <code>textInput</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'name'</span>)->textInput([<span class="hljs-string">'maxlength'</span> => <span class="hljs-number">255</span>, <span class="hljs-string">'placeholder'</span>=><span class="hljs-string">'Введите название звезды'</span>]) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
С Yii версии 2.0.3 <code>maxlength</code> - максимальная длина введённого текста, может быть автоматически высчитана из правила валидации:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        [[<span class="hljs-string">'name'</span>], <span class="hljs-string">'required'</span>],<br />
        [[<span class="hljs-string">'name'</span>], <span class="hljs-string">'string'</span>, <span class="hljs-string">'max'</span> => <span class="hljs-number">255</span>]<br />
    ];<br />
}<br />
</code></pre><br />
Для этого используйте:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'name'</span>)->textInput([<span class="hljs-string">'maxlength'</span> => <span class="hljs-keyword">true</span>, <span class="hljs-string">'placeholder'</span>=><span class="hljs-string">'Введите название звезды'</span>]) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Теперь наша форма готова. Введите название для звезды и нажав кнопку создать, почувствовать себя властелином Вселенной.<br />
Открыв <code>backendcontrollersStarController::actionCreate</code> вы увидите уже знакомый принцип сохранения данных - проверка и дальнейшее их сохранение. Со звездой всё просто. Перейдём к планетам.<br />
На форме с планетами появляется новое поле - <code>star_id</code>. Тот, кто будет пользоваться этой формой, будет вспоминать программиста не добрым словом. Всех id не упомнишь, да и ошибиться всегда можно. Давайте сделаем выпадающий список с названиями звёзд.<br />
Как мы делали когда-то для планет:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?</span>= <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'planet'</span>)->dropDownList(<br />
    [<span class="hljs-string">'Меркурий'</span>, <span class="hljs-string">'Венера'</span>, <span class="hljs-string">'Земля'</span>, <span class="hljs-string">'Марс'</span>, <span class="hljs-string">'Юпитер'</span>, <span class="hljs-string">'Сатурн'</span>, <span class="hljs-string">'Уран'</span>, <span class="hljs-string">'Нептун'</span>]<br />
) <span class="hljs-preprocessor">?></span><br />
</code></pre><br />
Только вместо массива будем использовать запрос <code>Star::find()->all()</code>, который вернёт массив моделей.</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$stars</span> = [];</p>
<p><span class="hljs-keyword">foreach</span> (Star::find()->all() <span class="hljs-keyword">as</span> <span class="hljs-variable">$star</span>){<br />
    <span class="hljs-variable">$stars</span>[<span class="hljs-variable">$star</span>->id] = <span class="hljs-variable">$star</span>->name;<br />
}</p>
<p><span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'planet'</span>)->dropDownList(<span class="hljs-variable">$stars</span>);<br />
</code></pre><br />
Но можно переписать этот код с использованием класса помощника <a href="http://www.yiiframework.com/doc-2.0/yii-helpers-arrayhelper.html" target="_blank">yiihelpersArrayHelper</a>, который позволяет обращаться с массивами более эффективно:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$stars</span> = ArrayHelper::map(Star::find()->all(), <span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>);<br />
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$form</span>->field(<span class="hljs-variable">$model</span>, <span class="hljs-string">'planet'</span>)->dropDownList(<span class="hljs-variable">$stars</span>);<br />
</code></pre><br />
Конечно, вы можете обойтись без переменной <code>$stars</code>, записав этот код одну строку. Ну и после всего, для этой формы попробуйте использовать <code>horizontal</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span> <span class="hljs-variable">$form</span> = ActiveForm::begin([<span class="hljs-string">'layout'</span> => <span class="hljs-string">'horizontal'</span>,]); <span class="hljs-preprocessor">?></span><br />
</code></pre></p>
<p>Осталось форма создания спутников. Вы уже всё умеете, чтобы внести изменения самостоятельно.</p>
<p>Так как формы, для редактирования существующих моделей используются одни и те же, что и для сохранения. То, что-либо новое создавать не нужно.</p>
<h4>Проверка работоспособности формы через тест</h4><br />
В этом подразделе описывается как написать функциональный тест для формы. Такой тест упростит отладку и разработку формы. Возможно, вам легче использовать браузер и по сто пятьдесят раз выдумывать и вводить данные, для того, чтобы проверить сохранение данных через форму, после очередной правки кода. Если это так, то можете пропустить этот подраздел и перейти дальше. Остальным добро пожаловать.<br />
Будем двигаться небольшими шагами, чтобы было понятнее и легче.<br />
Создадим функциональный тест <code>PlanetFormCept</code>, который будет проверять работу формы для сохранения данных по планетам.</p>
<pre><code class="hljs bash"><span class="hljs-built_in">cd</span> yii2-app-advancedtestscodeceptionbackend<br />
codecept build<br />
</code></pre></p>
<pre><code class="hljs bash">codecept generate:cept functional PlanetFormCept<br />
    Test was created <span class="hljs-keyword">in</span> ...<br />
</code></pre><br />
Откройте созданный файл <code>PlanetFormCept.php</code> и измените его содержимое на:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span> <span class="hljs-keyword">use</span> <span class="hljs-title">tests</span><span class="hljs-title">codeception</span><span class="hljs-title">backend</span><span class="hljs-title">FunctionalTester</span>;<br />
<span class="hljs-comment">/*<span class="hljs-phpdoc"> @var</span> $scenario CodeceptionScenario */</span><br />
<span class="hljs-variable">$I</span> = <span class="hljs-keyword">new</span> FunctionalTester(<span class="hljs-variable">$scenario</span>);<br />
<span class="hljs-variable">$I</span>->wantTo(<span class="hljs-string">'ensure than create form works'</span>);<br />
</code></pre><br />
Можно запустить этот тест:</p>
<pre><code class="hljs bash">codecept run functional functional/PlanetFormCept.php</p>
<p>    Time: <span class="hljs-number">1.51</span> seconds, Memory: <span class="hljs-number">13.25</span>Mb<br />
    OK (<span class="hljs-number">1</span> <span class="hljs-built_in">test</span>, <span class="hljs-number">0</span> assertions)<br />
</code></pre><br />
Как видно запустился 1 тест и выполнилось 0 проверок. Теперь к тесту добавим команду на открытие страницы с формой. ля этого нужно создать объект этой страницы. В директории <code>yii2-app-advanced/tests/codeception/backend/_pages/</code> создайте <code>PlanetFormPage.php</code> с содержимым:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">namespace</span> <span class="hljs-title">tests</span><span class="hljs-title">codeception</span><span class="hljs-title">backend</span><span class="hljs-title">_pages</span>;</p>
<p><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">codeception</span><span class="hljs-title">BasePage</span>;</p>
<p><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlanetFormPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasePage</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$route</span> = <span class="hljs-string">'planet/create'</span>;<br />
}<br />
</code></pre><br />
Теперь в нашем тесте можно воспользоваться этим объектом, для того, чтобы имитировать открытие страницы с формой:</p>
<pre><code class="hljs php"><span class="hljs-comment">//...</span><br />
<span class="hljs-variable">$I</span>->wantTo(<span class="hljs-string">'ensure than create form works'</span>);<br />
<span class="hljs-variable">$formPage</span> = testscodeceptionbackend_pagesPlanetFormPage::openBy(<span class="hljs-variable">$I</span>);<br />
</code></pre><br />
Запускаем тест для того, чтобы убедиться, что всё выполнили правильно:</p>
<pre><code class="hljs bash">codecept run functional functional/PlanetFormCept.php</p>
<p>    Time: <span class="hljs-number">518</span> ms, Memory: <span class="hljs-number">18.00</span>Mb<br />
    OK (<span class="hljs-number">1</span> <span class="hljs-built_in">test</span>, <span class="hljs-number">0</span> assertions)<br />
</code></pre><br />
На данный момент форма содержит два поля: тестовое поле "Название планеты" и выпадающий список "Название звезды". Проверим их через тест. Для этого нам понадобятся методы <code>fillField</code> и <code>click</code> из класса <code>yii2-app-advanced/tests/codeception/backend/functional/FunctionalTester.php</code>, который создался с помощью ранее выполненной команды <code>codecept build</code>.</p>
<div class="alert alert-info">Ознакомьтесь с информацией <a href="http://codeception.com/docs/modules/Yii2" target="_blank">по доступным методам</a>модуля Yii2 для Codeception.</div></p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span> <span class="hljs-keyword">use</span> <span class="hljs-title">tests</span><span class="hljs-title">codeception</span><span class="hljs-title">backend</span><span class="hljs-title">FunctionalTester</span>;<br />
<span class="hljs-comment">/*<span class="hljs-phpdoc"> @var</span> $scenario CodeceptionScenario */</span><br />
<span class="hljs-variable">$I</span> = <span class="hljs-keyword">new</span> FunctionalTester(<span class="hljs-variable">$scenario</span>);<br />
<span class="hljs-variable">$I</span>->wantTo(<span class="hljs-string">'ensure than create form works'</span>);<br />
<span class="hljs-variable">$formPage</span> = testscodeceptionbackendPlanetFormPage::openBy(<span class="hljs-variable">$I</span>);</p>
<p><span class="hljs-variable">$I</span>->fillField(<span class="hljs-string">'//*[@id="planet-name"]'</span>,<span class="hljs-string">'Новая Земля'</span>);<br />
<span class="hljs-variable">$I</span>->selectOption(<span class="hljs-string">'//*[@id="planet-star_id"]'</span>, <span class="hljs-string">'Солнце'</span>);<br />
<span class="hljs-variable">$I</span>->click(<span class="hljs-string">'//*[@id="w0"]/div[3]/button'</span>);<br />
<span class="hljs-variable">$I</span>->dontSeeInTitle(<span class="hljs-string">'Новая планета'</span>);<br />
</code></pre></p>
<ul>
<li>fillField - заполняем текстовое поле "Название планеты"</li>
<li>click - нажимаем на кнопку "Создать"</li>
<li>dontSeeInTitle - проверяем, чтобы в заголовке странице не было текста "Новая планета"</li><br />
</ul><br />
<code>//*[@id="planet-name"]</code> и <code>'//*[@id="w0"]/div[3]/button'</code> - это <a href="https://ru.wikipedia.org/wiki/XPath" target="_blank">XPath</a>. Например, в браузере Chrome, нажав на странице с формой F12, можно получить XPath через контекстное меню к html коду элемента:</p>
<p>Запустив тест, увидим ошибку:</p>
<pre><code class="hljs nginx"><span class="hljs-title">codecept</span> run functional functional/PlanetFormCept.php</p>
<p>     InvalidArgumentException: Input <span class="hljs-string">"Planet[star_id]"</span> cannot take <span class="hljs-string">"Солнце"</span> as a value (possible values: ).<br />
        <span class="hljs-number">3</span>. I <span class="hljs-built_in">select</span> option <span class="hljs-string">"//*[<span class="hljs-variable">@id</span>="</span>planet-star_id<span class="hljs-string">"]"</span>,<span class="hljs-string">"Солнце"</span><br />
        //...<br />
</code></pre><br />
Всё потому, что используется тестовая база данных, которая никакой информации по звёздам не содержит. Данные есть только в главной базе данных, но её использовать не будем, во избежание порчи данных. На помощь приходят фикстуры. Это состояние базы данных, до которого она будет доведена при запуске теста. Для работы с фикстурами исполнитель функциональных тестов <code>FunctionalTester.php</code> использует класс помощник <code>FixtureHelper.php</code> (в файле <code>tests/codeception/backend/functional.suite.yml</code>):</p>
<pre><code class="hljs css"><span class="hljs-rule"><span class="hljs-attribute">class_name</span>:<span class="hljs-value"> FunctionalTester<br />
modules:<br />
    enabled:<br />
      - Filesystem<br />
      - Yii2<br />
      - testscodeceptioncommon_supportFixtureHelper<br />
    config:<br />
        Yii2:<br />
            configFile: <span class="hljs-string">'../config/backend/functional.php'</span><br />
</span></span></code></pre><br />
Откройте файл помощник <code>FixtureHelper.php</code> и найдите его метод:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixtures</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        <span class="hljs-string">'user'</span> => [<br />
            <span class="hljs-string">'class'</span> => UserFixture::className(),<br />
            <span class="hljs-string">'dataFile'</span> => <span class="hljs-string">'@tests/codeception/common/fixtures/data/init_login.php'</span>,<br />
        ],<br />
    ];<br />
}<br />
</code></pre><br />
Запуская каждый раз любой функциональный тест из backend, запускается <code>FixtureHelper</code>, который загружает фикстуру <code>UserFixture</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserFixture</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ActiveFixture</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$modelClass</span> = <span class="hljs-string">'commonmodelsUser'</span>;<br />
}<br />
</code></pre><br />
, которая очищает таблицу для модели <code>commonmodelsUser</code>, а затем заполняет её данными из <code>dataFile</code>.<br />
Добавим новые фикстуры, которые будут сбрасывать состояние таблицы для звёзд, планет и их спутников. Создайте в <code>yii2-app-advanced/tests/codeception/common/fixtures</code> файлы:</p>
<ul>
<li>PlanetFixture.php</li>
<li>SatelliteFixture.php</li>
<li>StarFixture.php</li><br />
</ul><br />
Вот пример одной из фикстуры <code>SatelliteFixture.php</code>:</p>
<pre><code class="language-php hljs"><span class="hljs-preprocessor"><?php</span><br />
<span class="hljs-keyword">namespace</span> <span class="hljs-title">tests</span><span class="hljs-title">codeception</span><span class="hljs-title">common</span><span class="hljs-title">fixtures</span>;</p>
<p><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span><span class="hljs-title">test</span><span class="hljs-title">ActiveFixture</span>;</p>
<p><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SatelliteFixture</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ActiveFixture</span><br />
</span>{<br />
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$modelClass</span> = <span class="hljs-string">'commonmodelsSatellite'</span>;<br />
}</p>
<p></code></pre><br />
Код её простой, остальные две: <code>PlanetFixture</code> и <code>StarFixture</code> создайте самостоятельно.<br />
Без <code>$dataFile</code> фикстуры <a href="http://www.yiiframework.com/doc-2.0/yii-test-activefixture.html" target="_blank">ActiveFixture</a>будут очищать таблицы без внесения первоначальных данных. Явно можно не указывать расположение файла с данными(<code>$dataFile</code>), а просто его создать в той же директории, где лежит фикстура, с учётом имени таблицы. Т.е. для фикструры <code>SatelliteFixture</code>нужно создать в директории <code>yii2-app-advanced/tests/codeception/common/fixtures/data</code> файл с именем <code>satellite.php</code>. Для вашего удобства эти файлы уже созданы заранее.<br />
Фикстуры созданы, теперь нужно определить порядок их загрузки. Если мы сначала начнём загружать фикстуру для таблицы планет, то споткнёмся на ограничение внешних ключей в базе данных, т.е. вставляя данные из <code>yii2-app-advanced/tests/codeception/common/fixtures/data/planet.php</code></p>
<pre><code class="language-php hljs"><span class="hljs-keyword">return</span> [<br />
    [<br />
        <span class="hljs-string">'name'</span> => <span class="hljs-string">'Земля'</span>,<br />
        <span class="hljs-string">'star_id'</span> => <span class="hljs-string">'1'</span>,<br />
    ],<br />
];<br />
</code></pre><br />
получим ошибку</p>
<blockquote><p>SQLSTATE[23000]: Integrity constraint violation: 19 FOREIGN KEY constraint failed</blockquote><br />
которая обозначает, что звезды с ID = 1 не найдено. Поэтому сначала нужно загрузить фикстуру для звезды, затем для планеты и на последок фикстуру для спутников. Подключаем загрузку фикстур в файле помощнике FixtureHelper:</p>
<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixtures</span><span class="hljs-params">()</span><br />
</span>{<br />
    <span class="hljs-keyword">return</span> [<br />
        <span class="hljs-string">'user'</span> => [<br />
           <span class="hljs-string">'class'</span> => UserFixture::className(),<br />
           <span class="hljs-string">'dataFile'</span> => <span class="hljs-string">'@tests/codeception/common/fixtures/data/init_login.php'</span>,<br />
        ],<br />
        <span class="hljs-string">'star'</span> => [<br />
           <span class="hljs-string">'class'</span> => testscodeceptioncommonfixturesStarFixture::className(),<br />
        ],<br />
        <span class="hljs-string">'planet'</span> => [<br />
           <span class="hljs-string">'class'</span> => testscodeceptioncommonfixturesPlanetFixture::className(),<br />
        ],<br />
        <span class="hljs-string">'satellite'</span> => [<br />
           <span class="hljs-string">'class'</span> => testscodeceptioncommonfixturesSatelliteFixture::className(),<br />
        ],<br />
    ];<br />
}<br />
</code></pre></p>
<div class="alert alert-info">У <a href="http://www.yiiframework.com/doc-2.0/yii-test-activefixture.html" target="_blank">ActiveFixture</a>есть свойство $depends, с помощью которого можно также установить порядок связей фикстур.</div><br />
Фикстуры созданы, при запуске теста таблицы будут очищаться и заполняться данными из файлов <code>yii2-app-advanced/tests/codeception/common/fixtures/data/</code>. Поэтому теперь при запуске теста формы, мы сможем выбрать звезду из выпадающего списка:</p>
<pre><code class="language-php hljs">codecept run functional functional/PlanetFormCept.php</p>
<p>    Testscodeceptionbackend.functional Tests (<span class="hljs-number">1</span>)<br />
    Trying to ensure than create form works Ok</p>
<p>    Time: <span class="hljs-number">1.03</span> seconds, Memory: <span class="hljs-number">21.50</span>Mb<br />
    OK (<span class="hljs-number">1</span> test, <span class="hljs-number">1</span> assertion)<br />
</code></pre><br />
Если посмотреть в контроллер <code>yii2-app-advanced/backend/controllers/PlanetController.php</code>, то в методе <code>actionCreate</code>можно увидеть, что после сохранения происходит переход на действие <code>view</code></p>
<pre><code class="language-php hljs"> <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>->redirect([<span class="hljs-string">'view'</span>, <span class="hljs-string">'id'</span> => <span class="hljs-variable">$model</span>->id]);<br />
</code></pre><br />
В конце нашего теста указано:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$I</span>->dontSeeInTitle(<span class="hljs-string">'Новая планета'</span>);<br />
</code></pre><br />
что не совсем корректно, так как данные могут не сохраниться, появится ошибка, но в этом случае <code>dontSeeInTitle</code> вернёт утвердительный результат и тест выполнится успешно. Лучше заменить эту проверку на:</p>
<pre><code class="language-php hljs"><span class="hljs-variable">$I</span>->seeInTitle(<span class="hljs-string">'Новая Земля'</span>);<br />
</code></pre><br />
Теперь мы можем смело вносить изменения в код формы и запуская тест видеть, что всё работает корректно. Причём затраты по времени на проверку составит всего около 1 секунды, в то время как раньше, когда вы проверяли форму самостоятельно через браузер, уходило куда больше времени. Для закрепления основ самостоятельно напишите тесты к формам для сохранения звёзд и спутников.</p>
<h4>Сохранение реляционных данных.</h4><br />
У нас есть три формы для трёх разных моделей. Представьте себе ситуацию: нужно ввести информацию по новой планете, но звезды у неё ещё нету. Не совсем удобно переключаться с формы на форму, сохраняя новые данные. Давайте объединим работу с тремя формами в одной. Для этого нам понадобится новая модель формы, которая будет объединять работу с тремя моделями относительно модели Планет.</p>
<h4>Дополнительная информация для самостоятельного ознакомления:</h4></p>
<ul>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/helper-array.md" target="_blank">Руководство по ArrayHelper</a>.</li>
<li><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide-ru/test-fixtures.md" target="_blank">Руководство по фикстурам</a>.</li><br />
</ul><br />
</div><br />
</div></li><br />
</ul><br />
</div><br />
</div><br />
Source: des1roer.blogspot.com</p>
