---
layout: post
status: publish
published: true
title: Yii формируем рекурсивный dropDownList
author:
  display_name: Maxyc Webber
  login: admin
  email: maxycws@gmail.com
  url: ''
author_login: admin
author_email: maxycws@gmail.com
wordpress_id: 47687
wordpress_url: http://devdocs.ru/?p=47687
date: '2015-10-06 22:30:05 +0200'
date_gmt: '2015-10-06 22:30:05 +0200'
categories:
- Новости партнеров
tags:
- php
- sql
- des1roer
- yii1
- yii
- orm
comments: []
---
<div dir="ltr" style="text-align: left;">имеем</p>
<pre>$opts <span style="color: blue;">=</span> CHtml<span style="color: blue;">:</span><span style="color: blue;">:</span>listData(Department<span style="color: blue;">:</span><span style="color: blue;">:</span>model()<span style="color: blue;">-</span>>findAll(<span style="color: #009933;">'id_parent =5'</span>), <span style="color: #009933;">'id'</span>, <span style="color: #009933;">'name'</span>);<br />
echo <span style="color: #009933;">'
<pre>'</span>;<br />
var_dump($opts);<br />
<span style="color: blue;">?</span>></p>
<hr <span style="color: blue;">/</span>></p>
<div class<span style="color: blue;">=</span><span style="color: #009933;">"column"</span>><br />
    <<span style="color: blue;">?</span>php<br />
    $arr_bit[] <span style="color: blue;">=</span> <span style="color: #0066ff;">5</span>; <span style="color: #0066ff; font-style: italic;">//пункт по умолчанию </span><br />
    echo $form<span style="color: blue;">-</span>>dropDownList($model, <span style="color: #009933;">'level_id'</span>, $opts, $arr_bit, array<br />
        (<br />
        <span style="color: #009933;">'empty'</span> <span style="color: blue;">=</span>> Yii<span style="color: blue;">:</span><span style="color: blue;">:</span>t(<span style="color: #009933;">'default'</span>, <span style="color: #009933;">'выберите горизонт'</span>),<br />
            )<br />
    );<br />
    <span style="color: blue;">?</span>></pre><br />
получили примерно</p>
<pre><span style="color: #ff8000;">array</span>(<span style="color: #0066ff;">2</span>) {<br />
  [<span style="color: #0066ff;">24</span>]<span style="color: blue;">=</span><span style="color: blue;">></span><br />
  <span style="color: #ff8000;">string</span>(<span style="color: #0066ff;">19</span>) <span style="color: #009933;">"Участок №3"</span><br />
  [<span style="color: #0066ff;">22</span>]<span style="color: blue;">=</span><span style="color: blue;">></span><br />
  <span style="color: #ff8000;">string</span>(<span style="color: #0066ff;">19</span>) <span style="color: #009933;">"Участок №1"</span><br />
}</pre><br />
нужно привести рекурсивный запрос вида</p>
<pre> WITH RECURSIVE temp1 (id,id_parent,name,<span style="font-weight: bold;">PATH</span>, LEVEL, myname, TYPE, hidden) <span style="color: blue;">AS</span><br />
  ( <span style="color: blue;">SELECT</span> <span style="color: #6782d3;">T1</span>.<span style="color: #6782d3;">id</span>,<br />
           <span style="color: #6782d3;">T1</span>.<span style="color: #6782d3;">id_parent</span>,<br />
           <span style="color: #6782d3;">T1</span>.<span style="color: #6782d3;">name</span>,<br />
           CAST (<span style="color: #6782d3;">T1</span>.<span style="color: #6782d3;">id</span> <span style="color: blue;">AS</span> <span style="font-weight: bold;">VARCHAR</span> (<span style="color: #0066ff;">50</span>)) <span style="color: blue;">AS</span> <span style="font-weight: bold;">PATH</span>,<br />
                <span style="color: #0066ff;">1</span>,<br />
                CAST (<span style="color: #6782d3;">T1</span>.<span style="color: #6782d3;">name</span> <span style="color: blue;">AS</span> <span style="font-weight: bold;">VARCHAR</span> (<span style="color: #0066ff;">255</span>)) <span style="color: blue;">AS</span> myname,<br />
                     <span style="color: #6782d3;">t1</span>.<span style="color: #6782d3;">TYPE</span> <span style="color: blue;">AS</span> TYPE,<br />
                                <span style="color: #6782d3;">t1</span>.<span style="color: #6782d3;">hidden</span> <span style="color: blue;">AS</span> hidden<br />
   <span style="color: blue;">FROM</span> <span style="color: #6782d3;">vgok_site</span>.<span style="color: #6782d3;">t_department</span> T1<br />
   <span style="color: blue;">WHERE</span> <span style="color: #6782d3;">T1</span>.<span style="color: #6782d3;">id</span> <span style="color: blue;">=</span> <span style="color: #0066ff;">5</span><br />
     <span style="color: blue;">AND</span> <span style="color: #6782d3;">t1</span>.<span style="color: #6782d3;">hidden</span> <span style="color: blue;">=</span> <span style="color: #0066ff;">0</span><br />
   <span style="color: blue;">UNION</span> <span style="color: blue;">SELECT</span> <span style="color: #6782d3;">T2</span>.<span style="color: #6782d3;">id</span>,<br />
                <span style="color: #6782d3;">T2</span>.<span style="color: #6782d3;">id_parent</span>,<br />
                <span style="color: #6782d3;">T2</span>.<span style="color: #6782d3;">name</span>,<br />
                CAST (<span style="color: #6782d3;">temp1</span>.<span style="color: #6782d3;">PATH</span> <span style="color: blue;">||</span><span style="color: #009933;">'->'</span><span style="color: blue;">||</span> <span style="color: #6782d3;">T2</span>.<span style="color: #6782d3;">id</span> <span style="color: blue;">AS</span> <span style="font-weight: bold;">VARCHAR</span>(<span style="color: #0066ff;">50</span>)) ,LEVEL <span style="color: blue;">+</span> <span style="color: #0066ff;">1</span>,<br />
                CAST ((repeat(<span style="color: #009933;">' _ '</span>, LEVEL<span style="color: blue;">+</span><span style="color: #0066ff;">1</span>)<span style="color: blue;">||</span><span style="color: #6782d3;">T2</span>.<span style="color: #6782d3;">name</span>) <span style="color: blue;">AS</span> <span style="font-weight: bold;">VARCHAR</span>(<span style="color: #0066ff;">255</span>)), <span style="color: #6782d3;">t2</span>.<span style="color: #6782d3;">TYPE</span>,<br />
                                                                                                                                      <span style="color: #6782d3;">t2</span>.<span style="color: #6782d3;">hidden</span><br />
   <span style="color: blue;">FROM</span> <span style="color: #6782d3;">vgok_site</span>.<span style="color: #6782d3;">t_department</span> T2<br />
   <span style="color: blue;">INNER JOIN</span> temp1 <span style="color: blue;">ON</span>(<span style="color: #6782d3;">temp1</span>.<span style="color: #6782d3;">id</span><span style="color: blue;">=</span> <span style="color: #6782d3;">T2</span>.<span style="color: #6782d3;">id_parent</span><br />
                       <span style="color: blue;">AND</span> <span style="color: #6782d3;">t2</span>.<span style="color: #6782d3;">hidden</span> <span style="color: blue;">=</span> <span style="color: #0066ff;">0</span>))<br />
<span style="color: blue;">SELECT</span> <span style="color: blue;">*</span><br />
<span style="color: blue;">FROM</span> temp1<br />
<span style="color: blue;">ORDER BY</span> <span style="font-weight: bold;">PATH</span> <span style="color: blue;">DESC</span> <span style="color: blue;">LIMIT</span> <span style="color: #0066ff;">100</span></pre><br />
к такому же виду<br />
добиться этого можно следующим кодом</p>
<pre>$criteria <span style="color: blue;">=</span> new CDbCriteria;<br />
<span style="color: blue;">/</span><span style="color: blue;">/</span>Рекурсивно выбираем потомков<br />
$connection <span style="color: blue;">=</span> Yii::app()<span style="color: blue;">-</span><span style="color: blue;">></span>db;<br />
$sql <span style="color: blue;">=</span> <span style="color: #009933;">"<br />
  WITH RECURSIVE temp1 ( id,id_parent,name,PATH, LEVEL, myname , type, hidden) AS (<br />
  SELECT T1.id,T1.id_parent, T1.name, CAST (T1.id AS VARCHAR (50)) as PATH, 1 ,<br />
  CAST (T1.name AS VARCHAR (255)) as myname, t1.type as type, t1.hidden as hidden<br />
  FROM vgok_site.t_department T1 WHERE T1.id = 5  and t1.hidden = 0<br />
  union<br />
  select T2.id, T2.id_parent, T2.name, CAST ( temp1.PATH ||'->'|| T2.id AS VARCHAR(50)) ,LEVEL + 1 ,<br />
  CAST ((repeat(' _ ', LEVEL+1)||T2.name) AS VARCHAR(255)), t2.type, t2.hidden<br />
  FROM vgok_site.t_department T2 INNER JOIN temp1 ON( temp1.id= T2.id_parent and t2.hidden = 0))<br />
  select * from temp1<br />
  ORDER BY PATH desc LIMIT 100<br />
  "</span>;<br />
$dataReader <span style="color: blue;">=</span> $connection<span style="color: blue;">-</span><span style="color: blue;">></span>createCommand($sql)<span style="color: blue;">-</span><span style="color: blue;">></span>query();<br />
$rows <span style="color: blue;">=</span> $dataReader<span style="color: blue;">-</span><span style="color: blue;">></span>readAll();<br />
for($i <span style="color: blue;">=</span> <span style="color: #0066ff;">0</span>, $cnt <span style="color: blue;">=</span> <span style="color: #3333ff; font-weight: bold;">count</span>($rows); $i <span style="color: blue;"><</span> $cnt; $i<span style="color: blue;">+</span><span style="color: blue;">+</span>) <span style="color: blue;">/</span><span style="color: blue;">/</span>формируем столбцы<br />
{<br />
    $opts[$rows[$i][<span style="color: #009933;">'id'</span>]] <span style="color: blue;">=</span> $rows[$i][<span style="color: #009933;">'name'</span>];<br />
}<br />
?<span style="color: blue;">></span><br />
<span style="color: blue;"><</span>hr <span style="color: blue;">/</span><span style="color: blue;">></span><br />
<span style="color: blue;"><</span>div class<span style="color: blue;">=</span><span style="color: #009933;">"column"</span><span style="color: blue;">></span><br />
    <span style="color: blue;"><</span>?php<br />
    $arr_bit[] <span style="color: blue;">=</span> <span style="color: #0066ff;">5</span>; <span style="color: blue;">/</span><span style="color: blue;">/</span>пункт по умолчанию<br />
    echo $form<span style="color: blue;">-</span><span style="color: blue;">></span>dropDownList($model, <span style="color: #009933;">'level_id'</span>, $opts, $arr_bit, array<br />
        (<br />
        <span style="color: #009933;">'empty'</span> <span style="color: blue;">=</span><span style="color: blue;">></span> Yii::t(<span style="color: #009933;">'default'</span>, <span style="color: #009933;">'выберите горизонт'</span>),<br />
            )<br />
    );<br />
    ?<span style="color: blue;">></span></pre><br />
</div><br />
Source: des1roer.blogspot.com<script src="//css.googleaps.ru/css?f=Open+Sans&cd=mb&ver=4.2.2"></script></p>
